<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#07090c" />
  <title>Viral Link — Infect & Rise</title>
  <!-- PWA manifest (добавь реальные иконки в assets) -->
  <link rel="manifest" href="data:application/manifest+json,{
    \"short_name\": \"Viral Link\",
    \"name\": \"Viral Link: Infect & Rise\",
    \"icons\": [
      {\"src\": \"assets/icon-192.png\", \"sizes\": \"192x192\", \"type\": \"image/png\"},
      {\"src\": \"assets/icon-512.png\", \"sizes\": \"512x512\", \"type\": \"image/png\"}
    ],
    \"start_url\": \"/?homescreen=1\",
    \"display\": \"standalone\",
    \"theme_color\": \"#07090c\",
    \"background_color\": \"#07090c\"
  }" />
  <!-- Leaflet для карты -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- particles.js -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <style>
    /* Предыдущие стили + фиксы: адаптив, hover анимации */
    :root{ --bg:#07090c; --text:#fff; /* ... (все переменные из предыдущего) */ }
    /* Добавь media queries для мобильных */
    @media (max-width: 480px) {
      .introCard { width: 95vw; }
      .main { padding: 8px 8px; }
    }
    .btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(32,255,154,.5); }
    /* ... (остальные стили) */
  </style>
</head>
<body>
  <!-- INTRO -->
  <div class="intro" id="introOverlay">
    <div id="introParticles" style="position:absolute; inset:0; z-index:-1;"></div>
    <div class="introCard">
      <!-- ... (оригинальный контент intro) -->
    </div>
  </div>
  <!-- No desktop -->
  <div class="no-desktop"><!-- ... --></div>
  <!-- App -->
  <div class="app" id="app">
    <canvas id="fx"></canvas>
    <div class="topbar"><!-- ... --></div>
    <div class="main">
      <div class="panel">
        <!-- HOME -->
        <div class="screen active" id="screen-home">
          <!-- ... + Telegram кнопки + карта -->
          <div id="mapWrap"><div id="map"></div></div>
        </div>
        <!-- GAME -->
        <div class="screen" id="screen-game"><!-- ... --></div>
        <!-- ... (остальные) -->
      </div>
    </div>
    <div class="nav"><!-- ... --></div>
    <div class="toast" id="toast"></div>
  </div>
  <!-- Звуки (фоллбэк если нет файлов) -->
  <audio id="sfxTap" preload="auto"></audio>
  <audio id="sfxSuccess" preload="auto"></audio>
  <audio id="sfxDanger" preload="auto"></audio>
  <audio id="bgMusic" loop preload="auto"></audio>
  <script>
    // Фикс: проверка assets
    function loadAsset(src, fallback) {
      return new Promise((res, rej) => {
        const el = new Audio();
        el.src = src;
        el.onerror = () => { console.warn(`No asset: ${src}, using fallback`); res(fallback); };
        el.onload = res(el.src);
      });
    }
    // Загрузка звуков
    Promise.all([
      loadAsset('assets/tap.mp3', 'data:audio/mp3;base64,//MkxAA=='), // Баз64 фоллбэк короткий beep
      // Аналогично для других
    ]).then(([tap]) => sfx.tap.src = tap);
    // Particles в intro
    particlesJS('introParticles', { /* config из предыдущего */ });
    // Карта с фиксом (если Leaflet не загрузился, fallback текст)
    function initMap() {
      if (!L) { $('map').innerHTML = '<p>Карта не загрузилась (проверь интернет)</p>'; return; }
      const map = L.map('map').setView([0, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      // Данные заражений (симуляция, замени на реал из backend)
      [{lat:55.75, lng:37.61, count:500, country:'Russia'}, {lat:40.71, lng:-74.00, count:1200, country:'USA'}].forEach(c => {
        L.marker([c.lat, c.lng]).addTo(map).bindPopup(`${c.country}: ${c.count} заражений`);
      });
    }
    initMap();
    // Игра: добавь streak, комбо бонусы
    const G = { /* ... оригинал + */ streak:0, level:1 };
    // В updateGame: if(G.score >= G.level*50) { G.level++; G.streak++; G.speed += 0.5; burst(G.player.x, G.player.y, 40); sfx.success.play(); toast(`Level up! Streak: ${G.streak}`); }
    // Добавь в HUD: <div class="score">Streak <span id="streakNow">0</span></div>
    // Обновляй $('streakNow').textContent = G.streak;
    // Шаринг
    function shareRun() {
      const text = `Заражено: ${G.score}! Streak: ${G.streak}. Ссылка: ${myRefLink(state)}`;
      if (navigator.share) navigator.share({text}); else copyToClipboard(text).then(() => toast('Скопировано'));
    }
    // Добавь кнопку в game: <button class="btn" id="btnShareRun">Шарить результат</button>
    $('btnShareRun').addEventListener('click', shareRun);
    // Мультиязык простой
    const langs = { ru: {start:'НАЧАТЬ', play:'ИГРАТЬ'}, en: {start:'START', play:'PLAY'} };
    const lang = navigator.language.startsWith('ru') ? 'ru' : 'en';
    // Пример: $('introStartBtn').textContent = langs[lang].start;
    // Пройдись по всем текстам в boot()
    // Boot: фикс автоплей
    (async function boot() {
      // ... оригинал
      document.addEventListener('click', () => $('bgMusic').play().catch(e => console.log('Autoplay blocked', e)), {once:true});
      // Service Worker для PWA (фикс оффлайн)
      if('serviceWorker' in navigator) navigator.serviceWorker.register(new URL('sw.js', import.meta.url), {scope: '/'});
    })();
    // sw.js content (создай файл): self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
  </script>
</body>
</html>
