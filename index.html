<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#06070a"/>
  <title>Viral Link ‚Äî The Link Is The Virus</title>

  <style>
    :root{
      --bg:#06070a;
      --bg2:#030408;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.12);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --bio:#20ff9a;
      --cyan:#31d7ff;
      --pink:#ff2f6d;
      --gold:#ffd56a;
      --void:#b49bff;

      --shadow: 0 18px 70px rgba(0,0,0,.60);
      --shadow2: 0 12px 28px rgba(0,0,0,.35);

      --r: 20px;
      --r2: 28px;
      --pad: 14px;
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    body{ overflow:hidden; -webkit-tap-highlight-color: transparent; user-select:none; }

    /* ===========================
       BACKGROUND (zombie vibe)
       =========================== */
    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1000px 650px at 50% -10%, rgba(32,255,154,.16), transparent 60%),
        radial-gradient(900px 650px at 12% 55%, rgba(49,215,255,.12), transparent 60%),
        radial-gradient(900px 650px at 88% 70%, rgba(255,47,109,.10), transparent 62%),
        linear-gradient(180deg, var(--bg2), var(--bg) 35%, var(--bg2));
    }
    .noise{
      position:absolute; inset:0; opacity:.08; mix-blend-mode:overlay; pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
    }
    .scan{
      position:absolute; inset:0; pointer-events:none; opacity:.35;
      background: linear-gradient(180deg, transparent 0%, rgba(32,255,154,.10) 48%, transparent 70%);
      transform: translateY(-70%);
      animation: scan 4.5s linear infinite;
      mix-blend-mode: screen;
      filter: blur(6px);
    }
    @keyframes scan{ to{ transform: translateY(70%); } }

    /* ===========================
       INTRO OVERLAY
       =========================== */
    .intro{
      position:fixed; inset:0;
      z-index:9999;
      display:flex; align-items:center; justify-content:center;
      padding: calc(14px + var(--safeTop)) 14px calc(14px + var(--safeBottom));
      background:
        radial-gradient(900px 650px at 50% -10%, rgba(32,255,154,.20), transparent 60%),
        radial-gradient(900px 650px at 10% 70%, rgba(49,215,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.78), rgba(0,0,0,.84));
      backdrop-filter: blur(10px);
      transition: opacity .25s ease, transform .25s ease;
    }
    .intro.hidden{
      opacity:0; transform: scale(.98);
      pointer-events:none;
    }
    .introCard{
      width:min(520px, 92vw);
      border-radius: 30px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 30px 120px rgba(0,0,0,.75);
      overflow:hidden;
      position:relative;
    }
    .introTop{
      padding:18px 18px 12px;
      position:relative;
    }
    .introTop:before{
      content:"";
      position:absolute; inset:-70%;
      background: conic-gradient(from 240deg,
        rgba(32,255,154,0), rgba(32,255,154,.18), rgba(49,215,255,0),
        rgba(255,47,109,.16), rgba(32,255,154,0));
      filter: blur(18px);
      animation: spin 7s linear infinite;
      opacity:.85;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .introTitle{
      position:relative;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px;
      border-radius:999px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      font-weight:950;
      letter-spacing:.6px;
      color: rgba(255,255,255,.88);
      font-size:12px;
    }
    .badge .dot{
      width:10px; height:10px; border-radius:99px;
      background: radial-gradient(circle at 30% 30%, rgba(32,255,154,1), rgba(32,255,154,.18));
      box-shadow:0 0 18px rgba(32,255,154,.35);
    }

    .glitch{
      position:relative;
      font-weight:1000;
      letter-spacing:1.0px;
      font-size:18px;
      text-transform: uppercase;
    }
    .glitch:before,.glitch:after{
      content:attr(data-text);
      position:absolute; left:0; top:0;
      width:100%;
      opacity:.55;
      mix-blend-mode: screen;
      pointer-events:none;
    }
    .glitch:before{ transform: translate(1px,0); color: rgba(49,215,255,.95); clip-path: inset(0 0 60% 0); animation: glitch 2.8s infinite linear; }
    .glitch:after{ transform: translate(-1px,0); color: rgba(255,47,109,.85); clip-path: inset(55% 0 0 0); animation: glitch 2.1s infinite linear; }
    @keyframes glitch{
      0%,100%{ filter:none; }
      20%{ filter: blur(.3px); }
      22%{ filter:none; }
      55%{ filter: blur(.4px); }
      58%{ filter:none; }
    }

    .introBody{
      position:relative;
      padding: 0 18px 16px;
      display:flex; flex-direction:column; gap:12px;
    }
    .lead{ margin:0; color:rgba(255,255,255,.74); font-size:13px; line-height:1.35; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; letter-spacing:.7px; }

    .contract{
      border-radius: 22px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .contract .row{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .contract .row:last-child{ border-bottom:none; }
    .contract .row b{ font-size:12px; letter-spacing:.3px; }
    .contract .row span{ font-size:11px; color:rgba(255,255,255,.65); }
    .tag{
      padding:8px 10px;
      border-radius: 16px;
      font-weight:950;
      background: linear-gradient(90deg, rgba(32,255,154,1), rgba(49,215,255,1));
      color: rgba(0,0,0,.92);
      box-shadow: 0 16px 40px rgba(0,0,0,.40);
      white-space:nowrap;
    }

    .introBtns{
      display:flex; gap:10px;
      padding: 0 18px 18px;
      position:relative;
    }
    .btn{
      width:100%;
      border:none; outline:none;
      padding: 14px 14px;
      border-radius: 18px;
      font-weight:1000;
      letter-spacing:.35px;
      color: rgba(0,0,0,.92);
      background:
        radial-gradient(140% 140% at 20% 20%, rgba(255,255,255,.55), rgba(255,255,255,0) 38%),
        linear-gradient(90deg, rgba(32,255,154,1), rgba(49,215,255,1));
      box-shadow:
        0 16px 50px rgba(0,0,0,.50),
        0 0 0 1px rgba(255,255,255,.20) inset,
        0 0 44px rgba(32,255,154,.18);
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
    }
    .btn:active{ transform: scale(.985); }
    .btn.secondary{
      color: rgba(255,255,255,.92);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
    }
    .btn .shine{
      position:absolute; inset:-70%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
      transform: rotate(25deg) translateX(-55%);
      animation: btnshine 2.2s ease-in-out infinite;
      opacity:.75;
      pointer-events:none;
    }
    @keyframes btnshine{
      0%{ transform: rotate(25deg) translateX(-75%); opacity:0 }
      22%{ opacity:.55 }
      62%{ opacity:.35 }
      100%{ transform: rotate(25deg) translateX(75%); opacity:0 }
    }

    /* ===========================
       SHELL + FEED
       =========================== */
    .shell{
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      padding-top: calc(10px + var(--safeTop));
      padding-bottom: calc(10px + var(--safeBottom));
    }

    .hud{
      position:sticky; top:0;
      z-index:50;
      padding:0 var(--pad);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      pointer-events:auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .sigil{
      width:34px; height:34px; border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(circle at 30% 30%, rgba(32,255,154,.9), rgba(32,255,154,0) 60%),
        radial-gradient(circle at 70% 60%, rgba(49,215,255,.7), rgba(49,215,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.02));
      position:relative;
    }
    .sigil:after{
      content:"";
      position:absolute; inset:-80%;
      background: conic-gradient(from 220deg,
        rgba(32,255,154,0), rgba(32,255,154,.22), rgba(49,215,255,0),
        rgba(255,47,109,.18), rgba(32,255,154,0));
      filter: blur(12px);
      animation: spin 6.4s linear infinite;
      opacity:.9;
    }
    .btngroup{ display:flex; gap:8px; align-items:center; }
    .pill{
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      display:flex; align-items:center; gap:8px;
      font-weight:1000;
      letter-spacing:.3px;
      font-size:12px;
    }
    .mini{
      padding:10px 12px;
      border-radius:999px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      color: rgba(255,255,255,.88);
      font-weight:1000;
      letter-spacing:.4px;
    }
    .mini:active{ transform: scale(.985); }

    .feed{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px var(--pad) 120px;
      scroll-snap-type: y proximity;
    }

    section{
      scroll-snap-align: start;
      margin: 10px 0 18px;
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    section .inner{ padding: 16px; display:flex; flex-direction:column; gap:12px; }

    .row2{ display:flex; gap:10px; }
    .row2 > *{ flex:1; }

    .card{
      border-radius: var(--r);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
      padding: 12px;
    }
    .k{ font-size:11px; color:rgba(255,255,255,.62); letter-spacing:.3px; }
    .v{ margin-top:4px; font-size:18px; font-weight:1000; letter-spacing:.4px; }

    .chipbar{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
      font-size:12px;
      color: rgba(255,255,255,.88);
      font-weight:900;
      letter-spacing:.2px;
    }

    .progress{
      height:12px; border-radius:999px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .progress > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(32,255,154,1), rgba(49,215,255,1), rgba(255,47,109,.75));
      box-shadow: 0 0 30px rgba(32,255,154,.20);
      border-radius:999px;
    }

    /* ===========================
       GAME
       =========================== */
    .gameWrap{
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      box-shadow: 0 20px 60px rgba(0,0,0,.40);
      overflow:hidden;
      height: min(56vh, 520px);
      position:relative;
      touch-action:none;
    }
    canvas.game{
      position:absolute; inset:0;
      width:100%; height:100%;
      display:block;
    }
    .hudline{
      position:absolute; top:12px; left:12px; right:12px;
      display:flex; gap:10px; flex-wrap:wrap;
      z-index:5;
    }
    .hudchip{
      padding:9px 10px;
      border-radius:16px;
      background: rgba(0,0,0,.32);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
      font-size:12px;
      font-weight:1000;
      letter-spacing:.2px;
      color: rgba(255,255,255,.90);
    }
    .hudchip.fever{
      background: linear-gradient(90deg, rgba(255,47,109,.35), rgba(32,255,154,.24));
      border-color: rgba(255,255,255,.14);
    }

    .controls{
      position:absolute; bottom:12px; left:12px; right:12px;
      display:flex; justify-content:space-between; gap:12px;
      z-index:5;
      pointer-events:none;
    }
    .stick, .dash{
      pointer-events:auto;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .stick{
      width:140px; height:140px; border-radius:999px; position:relative;
      touch-action:none;
    }
    .stick:before{
      content:""; position:absolute; inset:16px;
      border-radius:999px; border:1px dashed rgba(255,255,255,.12); opacity:.7;
    }
    .knob{
      width:56px; height:56px; border-radius:18px;
      position:absolute; left:50%; top:50%;
      transform: translate(-50%,-50%);
      background:
        radial-gradient(120% 120% at 20% 20%, rgba(255,255,255,.18), rgba(255,255,255,0) 45%),
        linear-gradient(90deg, rgba(32,255,154,.85), rgba(49,215,255,.85));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 16px 40px rgba(0,0,0,.45), 0 0 30px rgba(32,255,154,.15);
    }
    .dash{
      width:98px; height:98px; border-radius:28px;
      display:grid; place-items:center;
      font-weight:1000; letter-spacing:.7px;
      color: rgba(255,255,255,.92);
      background:
        radial-gradient(140% 140% at 20% 20%, rgba(255,255,255,.16), rgba(255,255,255,0) 45%),
        linear-gradient(90deg, rgba(255,47,109,.95), rgba(255,144,99,.90));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 20px 60px rgba(0,0,0,.45), 0 0 34px rgba(255,47,109,.16);
      touch-action:none;
    }
    .dash:active{ transform: scale(.985); }

    /* Run summary overlay */
    .runSummary{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      z-index:20;
    }
    .runSummary.show{ display:flex; }
    .runCard{
      width:min(520px, 92vw);
      border-radius: 28px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 30px 120px rgba(0,0,0,.75);
      overflow:hidden;
    }
    .runCard .top{
      padding:16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .runCard .body{ padding:16px; display:flex; flex-direction:column; gap:12px; }
    .metric{
      display:flex; justify-content:space-between; gap:10px;
      padding:12px;
      border-radius: 18px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
    }
    .metric b{ font-weight:1000; }
    .metric span{ color: rgba(255,255,255,.70); font-size:12px; }

    /* ===========================
       CHAT + PROFILE (same rules)
       =========================== */
    .tiny{ font-size:11px; color:rgba(255,255,255,.62); line-height:1.3; }
    .field{ display:flex; flex-direction:column; gap:8px; }
    label{ font-size:11px; color:rgba(255,255,255,.66); letter-spacing:.2px; }
    input,textarea{
      width:100%;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      color: rgba(255,255,255,.92);
      padding: 12px 12px;
      outline:none;
      font-size:13px;
    }
    textarea{ min-height:80px; resize:none; line-height:1.25; }

    .chatList{
      height: 320px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      display:flex; flex-direction:column; gap:8px;
      padding-right:2px;
    }
    .msg{
      max-width: 88%;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
      align-self:flex-start;
    }
    .msg.mine{
      align-self:flex-end;
      background: rgba(32,255,154,.10);
      border-color: rgba(32,255,154,.20);
    }
    .msg .h{ display:flex; justify-content:space-between; gap:10px; margin-bottom:4px; }
    .msg .h b{ font-size:11px; }
    .msg .h span{ font-size:10px; color: rgba(255,255,255,.58); }
    .msg p{ margin:0; font-size:12.5px; color: rgba(255,255,255,.88); line-height:1.3; word-break:break-word; }
    .msg audio{ width:100%; margin-top:6px; }

    .chatInput{
      display:flex; gap:10px; align-items:center;
      padding:10px;
      border-radius:18px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
    }
    .chatInput input{
      flex:1; border:none; background:transparent; padding:10px 6px;
    }
    .iconBtn{
      width:46px; height:46px; border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
      display:grid; place-items:center;
      position:relative;
    }
    .icon{ width:18px; height:18px; fill:none; stroke:rgba(255,255,255,.90); stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
    .recDot{
      position:absolute; top:10px; left:10px;
      width:10px;height:10px;border-radius:99px;
      background: rgba(255,47,109,1);
      box-shadow: 0 0 18px rgba(255,47,109,.55);
      display:none;
    }

    /* ===========================
       TOAST
       =========================== */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:calc(22px + var(--safeBottom));
      z-index:99999;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      color: rgba(255,255,255,.88);
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      max-width:92vw;
      text-align:center;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

    /* ===========================
       Landscape UI toggle (fallback)
       =========================== */
    body[data-ui="landscape"] .feed{ padding-bottom: 26px; }
    body[data-ui="landscape"] section .inner{ padding: 14px; }
    body[data-ui="landscape"] .gameWrap{ height: min(60vh, 420px); }

    @media (prefers-reduced-motion: reduce){
      .sigil:after, .introTop:before, .btn .shine, .scan{ animation:none !important; }
    }
  </style>
</head>

<body>
  <div class="bg">
    <div class="noise"></div>
    <div class="scan"></div>
  </div>

  <!-- INTRO overlay -->
  <div class="intro" id="intro">
    <div class="introCard">
      <div class="introTop">
        <div class="introTitle">
          <div class="badge"><span class="dot"></span> LIVE OUTBREAK</div>
          <button class="badge" id="introLandscape" title="Switch to landscape">‚Üî LANDSCAPE</button>
        </div>
        <div style="height:10px"></div>
        <div class="glitch" id="introGlitch" data-text="THE LINK IS THE VIRUS">THE LINK IS THE VIRUS</div>
      </div>

      <div class="introBody">
        <p class="lead">
          –¢–≤–æ—è —Ü–µ–ª—å: —Å—Ç–∞—Ç—å <b>‚Ññ1</b> –ø–æ <b>INFECTED</b>. <br/>
          –õ—é–±–æ–π, –∫—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏–≥—Ä—É –ø–æ —Ç–≤–æ–µ–º—É <span class="mono">?ref=ID</span> ‚Äî –∑–∞—Ä–∞–∂—ë–Ω.
        </p>

        <div class="contract">
          <div class="row">
            <div>
              <b>CONTRACT #1</b><br/>
              <span>–ó–∞—Ä–∞–∑–∏ 1 –∏–≥—Ä–æ–∫–∞ ‚Üí –ø–æ–ª—É—á–∏ +2 INFECTED –±–æ–Ω—É—Å</span>
            </div>
            <div class="tag" id="c1">0/1</div>
          </div>
          <div class="row">
            <div>
              <b>CONTRACT #2</b><br/>
              <span>–ó–∞—Ä–∞–∑–∏ 3 ‚Üí –æ—Ç–∫—Ä–æ–π —Å–∫–∏–Ω NEON</span>
            </div>
            <div class="tag" id="c2">0/3</div>
          </div>
          <div class="row">
            <div>
              <b>CONTRACT #3</b><br/>
              <span>–ó–∞—Ä–∞–∑–∏ 10 ‚Üí –æ—Ç–∫—Ä–æ–π —Å–∫–∏–Ω GOLD</span>
            </div>
            <div class="tag" id="c3">0/10</div>
          </div>
        </div>

        <div class="card">
          <div class="k">–¢–≤–æ—è –≤–∏—Ä—É—Å-—Å—Å—ã–ª–∫–∞</div>
          <div class="v"><span class="mono" id="introRef">‚Äî</span></div>
          <div style="height:8px"></div>
          <button class="btn secondary" id="introCopy">COPY LINK</button>
        </div>

        <div class="row2">
          <button class="btn" id="introEnter">
            ENTER OUTBREAK <span class="shine" aria-hidden="true"></span>
          </button>
          <button class="btn secondary" id="introViralText">COPY VIRAL TEXT</button>
        </div>

        <div class="tiny">DEMO: –≤—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–æ –ª–æ–≥–∏–∫–∞ –≤–∏—Ä—É—Å–∞/–º–∏—Å—Å–∏–π/–Ω–∞–≥—Ä–∞–¥ —É–∂–µ ‚Äú–∏–≥—Ä–æ–≤–∞—è‚Äù.</div>
      </div>

      <div class="introBtns">
        <button class="btn secondary" id="introSkip">SKIP INTRO</button>
      </div>
    </div>
  </div>

  <div class="shell">
    <!-- HUD -->
    <div class="hud">
      <div class="brand">
        <div class="sigil" aria-hidden="true"></div>
        <div>
          <div style="font-weight:1000;letter-spacing:.7px;font-size:12px">VIRAL LINK</div>
          <div style="font-size:11px;color:rgba(255,255,255,.62)">Infect. Level up. Dominate.</div>
        </div>
      </div>

      <div class="btngroup">
        <div class="pill" title="Your Infection ID">
          <span class="mono">ID</span>
          <span class="mono" id="myId">‚Äî</span>
        </div>
        <button class="mini" id="btnLandscape" title="Landscape mode">‚Üî</button>
      </div>
    </div>

    <!-- FEED -->
    <div class="feed" id="feed">

      <!-- HOME -->
      <section id="s-home">
        <div class="inner">
          <div class="card">
            <div class="k">STATUS</div>
            <div class="v">OUTBREAK PROGRESS</div>
            <div style="height:10px"></div>

            <div class="chipbar">
              <div class="chip"><span class="mono">FROM</span><b class="mono" id="fromChip">‚Äî</b></div>
              <div class="chip"><span class="mono">INFECTED</span><b id="infectedChip">0</b></div>
              <div class="chip"><span class="mono">RANK</span><b id="rankChip">‚Äî</b></div>
              <div class="chip"><span class="mono">SKIN</span><b id="skinChip">CLASSIC</b></div>
            </div>

            <div style="height:12px"></div>
            <div class="k">–î–æ —Å–ª–µ–¥—É—é—â–µ–π –Ω–∞–≥—Ä–∞–¥—ã</div>
            <div class="progress"><i id="nextBar"></i></div>
            <div style="height:8px"></div>
            <div class="tiny" id="nextText">‚Äî</div>

            <div style="height:12px"></div>
            <div class="row2">
              <button class="btn" id="btnCopyLink">
                COPY VIRUS LINK <span class="shine" aria-hidden="true"></span>
              </button>
              <button class="btn secondary" id="btnShare">SHARE</button>
            </div>

            <div style="height:8px"></div>
            <button class="btn secondary" id="btnCopyViralText">COPY ‚ÄúVIRAL TEXT‚Äù</button>
          </div>

          <div class="card">
            <div class="k">WHY PEOPLE WILL DO IT</div>
            <div class="v">–°–∏—Å—Ç–µ–º–∞ ‚Äú–¥–æ–ø–∞–º–∏–Ω–∞‚Äù</div>
            <div class="tiny">
              –õ—é–¥–∏ –∑–∞—Ä–∞–∂–∞—é—Ç –∫–æ–≥–¥–∞: <b>–≤–∏–¥—è—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å</b>, <b>–ø–æ–ª—É—á–∞—é—Ç unlock</b>, <b>–º–æ–≥—É—Ç –ø–æ—Ö–≤–∞—Å—Ç–∞—Ç—å—Å—è</b>.
              –ü–æ—ç—Ç–æ–º—É —Ç—É—Ç: —Ä–∞–Ω–≥–∏, —Å–∫–∏–Ω—ã, –º–∏—Å—Å–∏–∏, –∏ ‚ÄúShare Run‚Äù –ø–æ—Å–ª–µ –∑–∞–±–µ–≥–∞.
            </div>
          </div>

          <button class="btn" id="btnScrollToPlay">SCROLL TO PLAY ‚Üì <span class="shine" aria-hidden="true"></span></button>
        </div>
      </section>

      <!-- GAME -->
      <section id="s-play">
        <div class="inner">
          <div class="card">
            <div class="k">INFECT RUN</div>
            <div class="v">–°–æ–±–∏—Ä–∞–π –æ—Ä–¥—É</div>
            <div class="tiny">
              –ö–æ–º–±–æ —Ä–∞—Å—Ç—ë—Ç ‚Üí –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è <b>FEVER</b> (–≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–æ—â—å –æ—Ä–¥—ã). –°–æ–±–∏—Ä–∞–π –ø–∏–∫–∞–ø—ã: <b>SPORE</b> –∏ <b>RAGE</b>.
            </div>
          </div>

          <div class="gameWrap" id="gameWrap">
            <canvas class="game" id="glow"></canvas>
            <canvas class="game" id="game"></canvas>

            <div class="hudline">
              <div class="hudchip">SCORE <span class="mono" id="hudScore">0</span></div>
              <div class="hudchip">COMBO <span class="mono" id="hudCombo">x1</span></div>
              <div class="hudchip">STREAK <span class="mono" id="hudStreak">0</span></div>
              <div class="hudchip">TIME <span class="mono" id="hudTime">60</span></div>
              <div class="hudchip">BONUS <span class="mono" id="hudBonus">+0</span></div>
              <div class="hudchip fever" id="hudFever" style="display:none">FEVER <span class="mono" id="hudFeverT">0</span></div>
            </div>

            <div class="controls">
              <div class="stick" id="stick"><div class="knob" id="knob"></div></div>
              <div class="dash" id="dash">DASH</div>
            </div>

            <div class="runSummary" id="runSummary">
              <div class="runCard">
                <div class="top">
                  <div style="font-weight:1000;letter-spacing:.7px">RUN COMPLETE</div>
                  <div class="badge"><span class="dot"></span> OUTBREAK</div>
                </div>
                <div class="body">
                  <div class="metric"><b>SCORE</b><span class="mono" id="sumScore">0</span></div>
                  <div class="metric"><b>STREAK</b><span class="mono" id="sumStreak">0</span></div>
                  <div class="metric"><b>BONUS INFECTED</b><span class="mono" id="sumBonus">+0</span></div>
                  <div class="row2">
                    <button class="btn" id="sumShare">SHARE & INFECT <span class="shine" aria-hidden="true"></span></button>
                    <button class="btn secondary" id="sumAgain">PLAY AGAIN</button>
                  </div>
                  <div class="tiny">–°–µ–∫—Ä–µ—Ç: –ª—É—á—à–∏–µ –∏–≥—Ä–æ–∫–∏ —à–∞—Ä—è—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –º–æ—â–Ω–æ–≥–æ –∑–∞–±–µ–≥–∞.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row2">
            <button class="btn secondary" id="btnRestart">RESTART</button>
            <button class="btn" id="btnShareRun">SHARE RUN <span class="shine" aria-hidden="true"></span></button>
          </div>
        </div>
      </section>

      <!-- RANK -->
      <section id="s-rank">
        <div class="inner">
          <div class="row2">
            <div class="card">
              <div class="k">–¢–≤–æ–π –Ω–∏–∫</div>
              <div class="v" id="nickStat">‚Äî</div>
              <div class="tiny">–°—Ç–∞–≤—å –Ω–∏–∫, —á—Ç–æ–±—ã –Ω–∞ —Ç–∞–±–ª–æ –±—ã–ª–æ –∫—Ä–∞—Å–∏–≤–æ.</div>
            </div>
            <div class="card">
              <div class="k">Best Run</div>
              <div class="v"><span class="mono" id="bestRun">0</span></div>
              <div class="tiny">–û—á–∫–∏ –∑–∞ –∑–∞–±–µ–≥.</div>
            </div>
          </div>

          <div class="card">
            <div class="k">–õ–∏–¥–µ—Ä–±–æ—Ä–¥ (DEMO)</div>
            <div class="tiny">–†–µ–π—Ç–∏–Ω–≥ –ø–æ <b>INFECTED</b>.</div>
            <div style="height:10px"></div>
            <div id="rankList" style="display:flex;flex-direction:column;gap:10px"></div>
          </div>

          <div class="row2">
            <button class="btn secondary" id="btnSeed">SEED DEMO PLAYERS</button>
            <button class="btn secondary" id="btnCopyLink2">COPY LINK</button>
          </div>
        </div>
      </section>

      <!-- CHAT -->
      <section id="s-chat">
        <div class="inner">
          <div class="card">
            <div class="k">GLOBAL CHAT</div>
            <div class="v">Text + Voice</div>
            <div class="tiny"><b>–°—Å—ã–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã</b>. –õ—é–±—ã–µ URL —Ä–µ–∂—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
          </div>

          <div class="chatList" id="chatList"></div>

          <div class="chatInput">
            <input id="chatText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ (—Å—Å—ã–ª–∫–∏ —É–¥–∞–ª—è—Ç—Å—è)" maxlength="220"/>
            <button class="iconBtn" id="btnRec" title="Voice" aria-label="Voice">
              <span class="recDot" id="recDot"></span>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3Z"></path>
                <path d="M19 11a7 7 0 0 1-14 0"></path>
                <path d="M12 18v3"></path>
              </svg>
            </button>
            <button class="iconBtn" id="btnSend" title="Send" aria-label="Send">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M22 2 11 13"></path>
                <path d="M22 2 15 22 11 13 2 9 22 2Z"></path>
              </svg>
            </button>
          </div>

          <div class="tiny" id="voiceHint">–ì–æ–ª–æ—Å–æ–≤—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ (–¥–µ–º–æ). –ù–∞ iOS –∑–∞–ø–∏—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞.</div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="s-profile">
        <div class="inner">
          <div class="card">
            <div class="k">PROFILE</div>
            <div class="v">Bio + Links + Skin</div>
            <div class="tiny">–°—Å—ã–ª–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Ç—É—Ç. –í —á–∞—Ç–µ ‚Äî –Ω–µ–ª—å–∑—è.</div>
          </div>

          <div class="field">
            <label>–ù–∏–∫ (–¥–æ 16)</label>
            <input id="nickInput" maxlength="16" placeholder="PatientZero"/>
          </div>

          <div class="field">
            <label>Bio (–¥–æ 220)</label>
            <textarea id="bioInput" maxlength="220" placeholder="–ö—Ç–æ —Ç—ã –∏ –∑–∞—á–µ–º —Ç—ã –∑–∞—Ä–∞–∂–∞–µ—à—å?"></textarea>
          </div>

          <div class="field">
            <label>–°–∫–∏–Ω (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∑–∞ INFECTED)</label>
            <div class="chipbar" id="skinRow"></div>
          </div>

          <div class="field">
            <label>–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (–¥–æ 3, —Ç–æ–ª—å–∫–æ https://)</label>
            <input id="link1" placeholder="https://..."/>
            <input id="link2" placeholder="https://..."/>
            <input id="link3" placeholder="https://..."/>
          </div>

          <button class="btn" id="btnSaveProfile">
            SAVE PROFILE <span class="shine" aria-hidden="true"></span>
          </button>

          <div class="card">
            <div class="k">–¢–≤–æ—è –≤–∏—Ä—É—Å-—Å—Å—ã–ª–∫–∞</div>
            <div class="v"><span class="mono" id="profileRef">‚Äî</span></div>
            <div style="height:8px"></div>
            <button class="btn secondary" id="btnCopyProfileRef">COPY LINK</button>
          </div>

          <button class="btn secondary" id="btnCopyViralText2">COPY VIRAL TEXT</button>
          <button class="btn secondary" id="btnReset">RESET DEMO (LOCAL)</button>
        </div>
      </section>

    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
/* ==========================================================
   Viral Link ‚Äî Intro + Motivation + Better Game + Zombie UI
   ========================================================== */

const $ = (id)=>document.getElementById(id);
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const lerp=(a,b,t)=>a+(b-a)*t;
const urlRe=/https?:\/\/[^\s]+|www\.[^\s]+|\b[\w.-]+\.[a-z]{2,}\b/ig;
const stripUrls=(t)=>String(t||"").replace(urlRe,"[no-link]");
const escapeHtml=(s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
const nowTime=()=>new Date().toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});

const toast=(msg,ms=1600)=>{
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.classList.remove("show"), ms);
};

/* ---- SFX (procedural) ---- */
const SFX = (() => {
  let ctx=null;
  const ensure=()=>ctx || (ctx=new (window.AudioContext||window.webkitAudioContext)());
  const ping=(f=220,ms=35,type="sine",gain=0.045)=>{
    try{
      const c=ensure();
      const o=c.createOscillator();
      const g=c.createGain();
      o.type=type; o.frequency.value=f;
      g.gain.value=gain;
      o.connect(g); g.connect(c.destination);
      o.start(); setTimeout(()=>o.stop(), ms);
    }catch(e){}
  };
  return {
    unlock(){ try{ ensure(); }catch(e){} },
    tap(){ navigator.vibrate?.(8); ping(240,22,"sine",0.03); },
    success(){ navigator.vibrate?.([18,10,18]); ping(420,42,"triangle",0.05); },
    danger(){ navigator.vibrate?.([25,12,25]); ping(140,70,"sawtooth",0.04); }
  };
})();

/* ---- Local State (upgrade-safe) ---- */
const STORE_KEY="viral_link_v2_motivation";
const genId=()=>{
  const a="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out=""; for(let i=0;i<8;i++) out+=a[(Math.random()*a.length)|0];
  return out;
};

const SKINS = {
  classic:{ name:"CLASSIC", req:0, body:"#20ff9a", eye:"#31d7ff", accent:"rgba(32,255,154,.20)" },
  neon:{ name:"NEON", req:3, body:"#31d7ff", eye:"#20ff9a", accent:"rgba(49,215,255,.20)" },
  toxic:{ name:"TOXIC", req:6, body:"#b6ff3b", eye:"#31d7ff", accent:"rgba(182,255,59,.16)" },
  void:{ name:"VOID", req:15, body:"#b49bff", eye:"#31d7ff", accent:"rgba(180,155,255,.16)" },
  gold:{ name:"GOLD", req:10, body:"#ffd56a", eye:"#20ff9a", accent:"rgba(255,213,106,.18)" }
};

const RANKS = [
  {req:0,  name:"WALKER"},
  {req:1,  name:"BITER"},
  {req:3,  name:"SPREADER"},
  {req:6,  name:"PLAGUE"},
  {req:10, name:"OUTBREAK"},
  {req:25, name:"APEX"},
  {req:50, name:"PATIENT Œ©"}
];

function defaultState(){
  const meId=genId();
  return {
    me:{
      id:meId,
      nick:"PatientZero",
      bio:"",
      links:[],
      infectedBy:null,
      bestRun:0,
      skin:"classic",
      unlocked:["classic"]
    },
    players:{ [meId]: {id:meId, nick:"PatientZero", infected:0} },
    chat:[]
  };
}

let state = load();

function load(){
  try{
    const raw=localStorage.getItem(STORE_KEY);
    if(!raw){
      const s=defaultState();
      localStorage.setItem(STORE_KEY, JSON.stringify(s));
      return s;
    }
    const s=JSON.parse(raw);
    // upgrade safe defaults
    s.players=s.players||{};
    s.chat=s.chat||[];
    if(!s.me?.id) throw new Error("bad");
    if(!s.players[s.me.id]) s.players[s.me.id]={id:s.me.id,nick:s.me.nick||"PatientZero",infected:0};
    if(!s.me.skin) s.me.skin="classic";
    if(!Array.isArray(s.me.unlocked)) s.me.unlocked=["classic"];
    // ensure classic unlocked
    if(!s.me.unlocked.includes("classic")) s.me.unlocked.push("classic");
    return s;
  }catch(e){
    const s=defaultState();
    localStorage.setItem(STORE_KEY, JSON.stringify(s));
    return s;
  }
}
function save(){
  state.players[state.me.id]=state.players[state.me.id]||{id:state.me.id,nick:state.me.nick,infected:0};
  state.players[state.me.id].nick=state.me.nick;
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}

function infectedCount(){
  return Number(state.players[state.me.id]?.infected || 0);
}
function myRefLink(){
  const base = location.origin + location.pathname;
  return `${base}?ref=${encodeURIComponent(state.me.id)}`;
}

/* ---- Viral Text Templates (copy) ---- */
function viralText(){
  const link=myRefLink();
  const n=infectedCount();
  return [
    "ü¶† VIRAL LINK ‚Äî The Link Is The Virus",
    `–Ø —É–∂–µ –∑–∞—Ä–∞–∑–∏–ª: ${n} –∏–≥—Ä–æ–∫–æ–≤.`,
    "–ó–∞–π–¥–∏ –ø–æ –º–æ–µ–π —Å—Å—ã–ª–∫–µ ‚Äî –∏ —Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ü–µ–ø–æ—á–∫–µ –∑–∞—Ä–∞–∂–µ–Ω–∏—è:",
    link,
    "",
    "‚ö†Ô∏è –¢–≤–æ—è —Ü–µ–ª—å: –∑–∞—Ä–∞–∂–∞—Ç—å –¥–∞–ª—å—à–µ –∏ –∑–∞–ª–µ—Ç–µ—Ç—å –≤ –¢–û–ü –ø–æ INFECTED.",
  ].join("\n");
}

/* ---- Referral virus ---- */
(function applyReferral(){
  const ref = new URL(location.href).searchParams.get("ref");
  if(!ref) return;
  if(ref===state.me.id) return;
  if(state.me.infectedBy) return;

  state.me.infectedBy=ref;
  state.players[ref]=state.players[ref]||{id:ref,nick:"Unknown",infected:0};
  state.players[ref].infected = (state.players[ref].infected||0) + 1;

  save();
  toast("–¢—ã –∑–∞—Ä–∞–∂—ë–Ω –æ—Ç "+ref, 2200);
  SFX.success();
})();

/* ---- Orientation toggle (best effort lock + fallback UI) ---- */
let uiMode = localStorage.getItem("uiMode") || "portrait";
applyUiMode(uiMode);

function applyUiMode(mode){
  uiMode=mode;
  document.body.setAttribute("data-ui", mode);
  localStorage.setItem("uiMode", mode);
}
async function toggleLandscape(){
  SFX.unlock(); SFX.tap();
  const next = (uiMode==="portrait") ? "landscape" : "portrait";
  applyUiMode(next);

  if(next==="landscape"){
    try{
      if(document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
      if(screen.orientation?.lock) await screen.orientation.lock("landscape");
      toast("Landscape ON");
    }catch(e){
      toast("–ü–æ–≤–µ—Ä–Ω–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –≤—Ä—É—á–Ω—É—é (lock –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—Ä–µ—â—ë–Ω)");
    }
  }else{
    try{
      if(screen.orientation?.unlock) screen.orientation.unlock();
      if(document.fullscreenElement) await document.exitFullscreen();
    }catch(e){}
    toast("Portrait ON");
  }
}
$("btnLandscape").addEventListener("click", toggleLandscape);
$("introLandscape").addEventListener("click", toggleLandscape);

/* ---- Clipboard / Share ---- */
async function copyToClipboard(text){
  try{ await navigator.clipboard.writeText(text); return true; }
  catch(e){
    const ta=document.createElement("textarea");
    ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    ta.remove(); return true;
  }
}
async function shareLink(text, url){
  if(navigator.share){
    try{ await navigator.share({title:"Viral Link", text, url}); return true; }catch(e){ return false; }
  }
  return false;
}

/* ---- Rewards / ranks / missions ---- */
function rankName(n){
  let r=RANKS[0].name;
  for(const x of RANKS) if(n>=x.req) r=x.name;
  return r;
}
function nextReward(n){
  // choose next skin or rank milestone
  const milestones = [
    {req:1,  label:"Unlock: +2 bonus (Contract #1)"},
    {req:3,  label:"Unlock: NEON skin"},
    {req:6,  label:"Unlock: TOXIC skin"},
    {req:10, label:"Unlock: GOLD skin"},
    {req:15, label:"Unlock: VOID skin"},
    {req:25, label:"Rank: APEX"},
    {req:50, label:"Rank: PATIENT Œ©"}
  ];
  for(const m of milestones){
    if(n < m.req) return m;
  }
  return {req:100, label:"Maxed. Keep infecting."};
}
function unlockByInfected(n){
  // skins unlock
  for(const key of Object.keys(SKINS)){
    const s=SKINS[key];
    if(n>=s.req && !state.me.unlocked.includes(key)){
      state.me.unlocked.push(key);
      toast(`UNLOCKED: ${s.name} SKIN`);
      SFX.success();
    }
  }
}
function updateMotivationUI(){
  const n=infectedCount();
  $("myId").textContent=state.me.id;
  $("introRef").textContent=myRefLink();
  $("fromChip").textContent=state.me.infectedBy || "‚Äî";
  $("infectedChip").textContent = String(n);
  $("rankChip").textContent = rankName(n);
  $("skinChip").textContent = (SKINS[state.me.skin]?.name || "CLASSIC");

  // contracts counters
  $("c1").textContent = `${Math.min(n,1)}/1`;
  $("c2").textContent = `${Math.min(n,3)}/3`;
  $("c3").textContent = `${Math.min(n,10)}/10`;

  // progress to next reward
  const nxt=nextReward(n);
  const prevReq = (()=> {
    const all=[0,1,3,6,10,15,25,50];
    let p=0; for(const r of all) if(n>=r) p=r;
    return p;
  })();
  const span = Math.max(1, nxt.req - prevReq);
  const pct = clamp(((n - prevReq) / span) * 100, 0, 100);
  $("nextBar").style.width = pct.toFixed(0) + "%";
  $("nextText").textContent = `${n}/${nxt.req} ‚Ä¢ ${nxt.label}`;

  // profile refs
  $("profileRef").textContent=myRefLink();
  $("nickStat").textContent = state.me.nick || "PatientZero";
  $("bestRun").textContent = String(state.me.bestRun||0);

  renderSkins();
  renderRank();
}

/* ---- Skin UI ---- */
function renderSkins(){
  const row=$("skinRow");
  row.innerHTML="";
  const n=infectedCount();

  for(const key of Object.keys(SKINS)){
    const s=SKINS[key];
    const unlocked = state.me.unlocked.includes(key) || n>=s.req;
    const chip=document.createElement("button");
    chip.className="chip";
    chip.style.cursor="pointer";
    chip.style.borderColor = unlocked ? "rgba(255,255,255,.14)" : "rgba(255,255,255,.08)";
    chip.style.opacity = unlocked ? "1" : ".55";
    chip.innerHTML = `<span class="mono">${s.name}</span><b>${unlocked ? "‚úì" : "LOCK "+s.req}</b>`;
    chip.addEventListener("click", ()=>{
      SFX.unlock();
      if(!unlocked){
        toast(`–ù—É–∂–Ω–æ INFECTED ‚â• ${s.req}`);
        SFX.danger();
        return;
      }
      state.me.skin=key;
      if(!state.me.unlocked.includes(key)) state.me.unlocked.push(key);
      save();
      updateMotivationUI();
      toast(`Skin: ${s.name}`);
      SFX.success();
    });
    row.appendChild(chip);
  }
}

/* ---- Leaderboard ---- */
function renderRank(){
  const arr=Object.values(state.players).map(p=>({
    id:p.id, nick:p.nick||"Unknown", infected:Number(p.infected||0)
  })).sort((a,b)=>b.infected-a.infected || a.id.localeCompare(b.id));

  const box=$("rankList");
  box.innerHTML="";
  arr.slice(0,12).forEach((p,i)=>{
    const row=document.createElement("div");
    row.className="card";
    row.style.display="flex";
    row.style.alignItems="center";
    row.style.justifyContent="space-between";
    row.style.gap="10px";
    row.innerHTML=`
      <div>
        <div style="font-weight:1000;letter-spacing:.3px">${i+1}. ${escapeHtml(p.nick)}</div>
        <div class="mono" style="font-size:11px;color:rgba(255,255,255,.62)">${escapeHtml(p.id)}</div>
      </div>
      <div style="min-width:76px;text-align:center;font-weight:1000;border-radius:16px;padding:10px 12px;
        color:rgba(0,0,0,.90); background:linear-gradient(90deg, rgba(255,213,106,1), rgba(32,255,154,1));
        box-shadow:0 12px 28px rgba(0,0,0,.28)">${p.infected}</div>
    `;
    box.appendChild(row);
  });
}

/* ---- Intro controls ---- */
function hideIntro(){
  $("intro").classList.add("hidden");
  localStorage.setItem("introSeen","1");
}
function showIntro(){
  $("intro").classList.remove("hidden");
}
$("introEnter").addEventListener("click", ()=>{
  SFX.unlock(); SFX.tap();
  hideIntro();
  $("s-home").scrollIntoView({behavior:"smooth", block:"start"});
});
$("introSkip").addEventListener("click", ()=>{
  SFX.unlock(); SFX.tap();
  hideIntro();
});
$("introCopy").addEventListener("click", async ()=>{
  SFX.unlock(); SFX.tap();
  await copyToClipboard(myRefLink());
  toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
  SFX.success();
});
$("introViralText").addEventListener("click", async ()=>{
  SFX.unlock(); SFX.tap();
  await copyToClipboard(viralText());
  toast("Viral text —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
  SFX.success();
});

/* ---- Home actions ---- */
$("btnCopyLink").addEventListener("click", async ()=>{
  SFX.unlock(); SFX.tap();
  await copyToClipboard(myRefLink());
  toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
  SFX.success();
});
$("btnCopyLink2").addEventListener("click", async ()=>{
  SFX.unlock(); SFX.tap();
  await copyToClipboard(myRefLink());
  toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
  SFX.success();
});
$("btnShare").addEventListener("click", async ()=>{
  SFX.unlock(); SFX.tap();
  const link=myRefLink();
  const ok=await shareLink("ü¶† Viral Link ‚Äî –∑–∞–π–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ –∏ —Å—Ç–∞–Ω—å —á–∞—Å—Ç—å—é –∑–∞—Ä–∞–∂–µ–Ω–∏—è", link);
  if(!ok){
    await copyToClipboard(link);
    toast("Share –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
  }else toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
  SFX.success();
});
$("btnCopyViralText").addEventListener("click", async ()=>{
  SFX.unlock(); SFX.tap();
  await copyToClipboard(viralText());
  toast("Viral text —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
  SFX.success();
});
$("btnCopyViralText2").addEventListener("click", async ()=>{
  SFX.unlock(); SFX.tap();
  await copyToClipboard(viralText());
  toast("Viral text —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
  SFX.success();
});
$("btnScrollToPlay").addEventListener("click", ()=>{
  SFX.unlock(); SFX.tap();
  $("s-play").scrollIntoView({behavior:"smooth", block:"start"});
});

/* ---- Profile ---- */
function normalizeLinks(arr){
  const out=[];
  for(const raw of arr){
    if(!raw) continue;
    let s=String(raw).trim();
    if(!s) continue;
    if(!/^https?:\/\//i.test(s)) continue;
    if(s.length>120) s=s.slice(0,120);
    out.push(s);
    if(out.length>=3) break;
  }
  return out;
}
$("btnSaveProfile").addEventListener("click", ()=>{
  const nick = ($("nickInput").value||"").trim().slice(0,16) || "PatientZero";
  const bio  = ($("bioInput").value||"").trim().slice(0,220);
  const links = normalizeLinks([$("link1").value,$("link2").value,$("link3").value]);

  state.me.nick=nick;
  state.me.bio=bio;
  state.me.links=links;
  state.players[state.me.id]=state.players[state.me.id]||{id:state.me.id,nick,infected:0};
  state.players[state.me.id].nick=nick;
  save();
  updateMotivationUI();
  toast("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
  SFX.success();
});
$("btnCopyProfileRef").addEventListener("click", async ()=>{
  SFX.unlock(); SFX.tap();
  await copyToClipboard(myRefLink());
  toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
  SFX.success();
});
$("btnReset").addEventListener("click", ()=>{
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem("introSeen");
  toast("–°–±—Ä–æ—à–µ–Ω–æ");
  SFX.danger();
  setTimeout(()=>location.href=location.pathname, 450);
});

/* ---- Seed demo players ---- */
$("btnSeed").addEventListener("click", ()=>{
  const names=["GraveRunner","NightBite","ZeroPulse","BioHaze","CyanFang","RotKing","PlagueMuse","VoidEcho","SporeWave","Wasteland","NeonGhoul","ToxicByte"];
  for(let i=0;i<18;i++){
    const id=genId();
    state.players[id]={ id, nick:names[(Math.random()*names.length)|0]+(10+((Math.random()*90)|0)), infected: (Math.random()*120)|0 };
  }
  save(); updateMotivationUI();
  toast("–î–µ–º–æ-–∏–≥—Ä–æ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã");
  SFX.success();
});

/* ---- Chat ---- */
function rid(){
  try{
    const a=new Uint8Array(8); crypto.getRandomValues(a);
    return Array.from(a).map(x=>x.toString(16).padStart(2,"0")).join("");
  }catch(e){ return String(Math.random()).slice(2); }
}
function addChat(msg){
  state.chat.push(msg);
  if(state.chat.length>90) state.chat=state.chat.slice(-90);
  save();
  renderChat(true);
}
function renderChat(stickBottom=false){
  const list=$("chatList");
  const atBottom = list.scrollTop + list.clientHeight >= list.scrollHeight - 24;

  list.innerHTML="";
  for(const m of state.chat){
    const div=document.createElement("div");
    div.className="msg"+(m.fromId===state.me.id?" mine":"");
    div.innerHTML=`
      <div class="h">
        <b>${escapeHtml(m.fromNick||"Unknown")}</b>
        <span>${escapeHtml(m.t||"")}</span>
      </div>
      ${m.text ? `<p>${escapeHtml(m.text)}</p>` : ``}
      ${m.audioDataUrl ? `<audio controls src="${m.audioDataUrl}"></audio>` : ``}
    `;
    list.appendChild(div);
  }
  if(stickBottom){ if(atBottom) list.scrollTop=list.scrollHeight; }
  else list.scrollTop=list.scrollHeight;
}
function sendText(){
  const inp=$("chatText");
  let text=(inp.value||"").trim();
  if(!text) return;

  const cleaned=stripUrls(text);
  if(cleaned!==text){ toast("–°—Å—ã–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã ‚Äî —É–¥–∞–ª–µ–Ω–æ"); SFX.danger(); }
  text=cleaned.slice(0,220);

  addChat({id:rid(), fromId:state.me.id, fromNick:state.me.nick, t:nowTime(), text});
  inp.value="";
  SFX.tap();
}
$("btnSend").addEventListener("click", ()=>{ SFX.unlock(); sendText(); });
$("chatText").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); SFX.unlock(); sendText(); } });

let rec={active:false, mediaRecorder:null, chunks:[], stream:null};
async function blobToDataURL(blob){
  return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); });
}
async function toggleRecord(){
  SFX.unlock();
  if(!window.MediaRecorder){
    $("voiceHint").textContent="MediaRecorder –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–Ω–∞ iOS –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ).";
    toast("–ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"); SFX.danger(); return;
  }
  if(rec.active){
    try{ rec.mediaRecorder.stop(); }catch(e){}
    rec.active=false;
    $("recDot").style.display="none";
    toast("–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"); SFX.tap();
    return;
  }
  if(!navigator.mediaDevices?.getUserMedia){
    toast("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"); SFX.danger(); return;
  }
  try{
    rec.stream=await navigator.mediaDevices.getUserMedia({audio:true});
    rec.chunks=[];
    rec.mediaRecorder=new MediaRecorder(rec.stream);
    rec.mediaRecorder.ondataavailable=(e)=>{ if(e.data && e.data.size>0) rec.chunks.push(e.data); };
    rec.mediaRecorder.onstop=async ()=>{
      try{ rec.stream?.getTracks()?.forEach(t=>t.stop()); }catch(e){}
      const blob=new Blob(rec.chunks,{type:"audio/webm"});
      const dataUrl=await blobToDataURL(blob);
      addChat({id:rid(), fromId:state.me.id, fromNick:state.me.nick, t:nowTime(), audioDataUrl:dataUrl});
      SFX.success();
    };
    rec.mediaRecorder.start();
    rec.active=true;
    $("recDot").style.display="inline-block";
    toast("–ó–∞–ø–∏—Å—å... –Ω–∞–∂–º–∏ –µ—â—ë —Ä–∞–∑ —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å");
    SFX.tap();
  }catch(e){
    toast("–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω"); SFX.danger();
  }
}
$("btnRec").addEventListener("click", toggleRecord);

/* ==========================================================
   GAME (improved): Fever mode + pickups + summary overlay
   ========================================================== */
const Game = (() => {
  const wrap=$("gameWrap");
  const glow=$("glow");
  const game=$("game");
  const gctx=glow.getContext("2d");
  const ctx=game.getContext("2d");

  let W=0,H=0,DPR=1;
  let last=0, raf=0;

  // joystick
  let joy={x:0,y:0};
  let dashPressed=false;

  // camera shake
  let shake=0;

  const world={
    running:true,
    ended:false,
    t:0,
    timeLeft:60,
    score:0,
    streak:0,
    combo:1,
    comboT:0,
    bonus:0,

    fever:0,       // ms
    rage:0,        // ms (speed boost)

    cam:{x:0,y:0},
    bounds:{w:2200,h:3200},
    player:null,
    humans:[],
    horde:[],
    parts:[],
    pickups:[]  // {x,y,type}
  };

  function resize(){
    const r=wrap.getBoundingClientRect();
    DPR=Math.max(1, Math.min(2, window.devicePixelRatio||1));
    W=Math.max(1, Math.floor(r.width));
    H=Math.max(1, Math.floor(r.height));
    glow.width=Math.floor(W*DPR); glow.height=Math.floor(H*DPR);
    game.width=Math.floor(W*DPR); game.height=Math.floor(H*DPR);
    gctx.setTransform(DPR,0,0,DPR,0,0);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }

  function hud(){
    $("hudScore").textContent=String(world.score);
    $("hudCombo").textContent="x"+String(world.combo);
    $("hudStreak").textContent=String(world.streak);
    $("hudTime").textContent=String(world.timeLeft);
    $("hudBonus").textContent="+"+String(world.bonus);

    if(world.fever>0){
      $("hudFever").style.display="inline-flex";
      $("hudFeverT").textContent=Math.ceil(world.fever/1000);
    }else{
      $("hudFever").style.display="none";
    }
  }

  function reset(){
    world.running=true; world.ended=false;
    world.t=0; world.timeLeft=60;
    world.score=0; world.streak=0; world.combo=1; world.comboT=0;
    world.bonus=0;
    world.fever=0; world.rage=0;
    world.humans.length=0; world.horde.length=0; world.parts.length=0; world.pickups.length=0;
    shake=0;

    world.player={x:world.bounds.w*0.5,y:world.bounds.h*0.45,vx:0,vy:0,r:18,ang:0,dashCd:0};
    world.cam.x=world.player.x; world.cam.y=world.player.y;

    for(let i=0;i<26;i++) world.humans.push(makeHuman(Math.random()<0.18));

    // initial pickups
    for(let i=0;i<3;i++) spawnPickup();

    hud();
    hideSummary();
  }

  function makeHuman(elite=false){
    const x = 120 + Math.random()*(world.bounds.w-240);
    const y = 220 + Math.random()*(world.bounds.h-440);
    const a = Math.random()*Math.PI*2;
    const sp = elite ? 85+Math.random()*22 : 56+Math.random()*16;
    return {x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,r:elite?15:13,elite,turnT:600+Math.random()*1000,alive:true};
  }
  function makeFollower(x,y){
    return {x,y,vx:0,vy:0,r:14,ang:0,wob:Math.random()*1000};
  }

  function radial(c,x,y,r,color){
    const g=c.createRadialGradient(x,y,0,x,y,r);
    g.addColorStop(0,color);
    g.addColorStop(1,"rgba(0,0,0,0)");
    c.fillStyle=g;
    c.beginPath(); c.arc(x,y,r,0,Math.PI*2); c.fill();
  }

  function spawnParts(x,y,color,n=18,sp=280){
    for(let i=0;i<n;i++){
      const a=Math.random()*Math.PI*2;
      const s=sp*(0.35+Math.random()*0.65);
      world.parts.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:0.35+Math.random()*0.55,max:1,size:2+Math.random()*3,color});
    }
  }

  function spawnPickup(){
    const type = Math.random()<0.5 ? "spore" : "rage";
    world.pickups.push({
      x: 160 + Math.random()*(world.bounds.w-320),
      y: 260 + Math.random()*(world.bounds.h-520),
      type,
      r: 18
    });
  }

  function calcBonus(score, streak){
    // strong motivation: bonus scales a bit more
    return Math.floor(score/18) + Math.floor(streak/14) + Math.floor(Math.max(0,world.combo-1)/3);
  }

  function startFever(){
    if(world.fever>0) return;
    world.fever=4500;
    toast("FEVER MODE üî•", 1200);
    SFX.success();
  }

  function infectHuman(h, power=1){
    if(!h.alive) return;
    h.alive=false;

    const addBase = h.elite ? 4 : 1;
    const feverBoost = world.fever>0 ? 1 : 0;
    const add = (addBase + feverBoost) * world.combo * power;

    world.score += add;
    world.streak += 1;
    world.combo = Math.min(18, world.combo + (h.elite ? 3 : 1));
    world.comboT = 90;

    if(world.combo>=10) startFever();

    // FX
    shake = Math.min(16, shake + (h.elite?8:5));
    spawnParts(h.x,h.y, skinAccent(), 24+addBase*10, 360);
    world.horde.push(makeFollower(h.x,h.y));

    SFX.tap();
    hud();
  }

  function sporeBomb(x,y){
    // AoE infect
    shake = Math.min(20, shake + 10);
    spawnParts(x,y,"rgba(32,255,154,.26)", 60, 480);
    const r=190 + (world.fever>0 ? 80 : 0);
    let hit=0;
    for(const h of world.humans){
      if(!h.alive) continue;
      const d=Math.hypot(h.x-x,h.y-y);
      if(d<r){ infectHuman(h, 1); hit++; }
    }
    toast(`SPORE BOMB ‚Ä¢ +${hit} infected`, 1200);
    SFX.success();
  }

  function endRun(){
    if(world.ended) return;
    world.ended=true; world.running=false;

    world.bonus = calcBonus(world.score, world.streak);
    hud();

    state.me.bestRun = Math.max(state.me.bestRun||0, world.score);
    state.players[state.me.id].infected = (state.players[state.me.id].infected||0) + world.bonus;

    // contract #1 reward: if reached >=1 and not yet granted, give +2 once
    if(!state.me._c1 && infectedCount()>=1){
      state.me._c1=true;
      state.players[state.me.id].infected += 2;
      toast("CONTRACT #1 COMPLETE ‚Ä¢ +2 INFECTED", 1800);
      SFX.success();
    }

    // unlock skins by infected
    unlockByInfected(infectedCount());

    save();
    updateMotivationUI();
    showSummary();
    SFX.success();
  }

  function ensurePopulation(){
    const target = 24 + Math.min(28, Math.floor(world.score/12));
    const missing = target - world.humans.length;
    if(missing>0){
      for(let i=0;i<Math.min(3,missing);i++) world.humans.push(makeHuman(Math.random()<0.18));
    }
    // keep pickups
    if(world.pickups.length<3 && Math.random()<0.02) spawnPickup();
  }

  function drawBackground(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle="rgba(0,0,0,.18)";
    ctx.fillRect(0,0,W,H);

    const gx=world.cam.x - W/2;
    const gy=world.cam.y - H/2;

    // grid
    const step=60;
    ctx.strokeStyle="rgba(255,255,255,.04)";
    ctx.lineWidth=1;
    const sx=Math.floor(gx/step)*step;
    const sy=Math.floor(gy/step)*step;
    ctx.beginPath();
    for(let x=sx; x<gx+W+step; x+=step){ const px=x-gx; ctx.moveTo(px,0); ctx.lineTo(px,H); }
    for(let y=sy; y<gy+H+step; y+=step){ const py=y-gy; ctx.moveTo(0,py); ctx.lineTo(W,py); }
    ctx.stroke();

    // subtle fever tint
    if(world.fever>0){
      ctx.fillStyle="rgba(255,47,109,.05)";
      ctx.fillRect(0,0,W,H);
    }
  }

  function drawGlow(){
    gctx.clearRect(0,0,W,H);
    const gx=world.cam.x - W/2;
    const gy=world.cam.y - H/2;

    radial(gctx, world.player.x-gx, world.player.y-gy, 52, skinAccent());
    for(const z of world.horde) radial(gctx, z.x-gx, z.y-gy, 30, skinAccent());
    for(const h of world.humans) radial(gctx, h.x-gx, h.y-gy, h.elite?32:24, h.elite?"rgba(255,213,106,.14)":"rgba(255,255,255,.05)");
    for(const p of world.parts) radial(gctx, p.x-gx, p.y-gy, p.size*4.2, p.color);

    // pickups glow
    for(const p of world.pickups){
      const c = p.type==="spore" ? "rgba(32,255,154,.18)" : "rgba(255,47,109,.16)";
      radial(gctx, p.x-gx, p.y-gy, 34, c);
    }
  }

  function roundedPath(c,x,y,w,h,r){
    c.moveTo(x+r,y);
    c.arcTo(x+w,y, x+w,y+h, r);
    c.arcTo(x+w,y+h, x,y+h, r);
    c.arcTo(x,y+h, x,y, r);
    c.arcTo(x,y, x+w,y, r);
  }

  function skinBody(){
    return (SKINS[state.me.skin]||SKINS.classic).body;
  }
  function skinEye(){
    return (SKINS[state.me.skin]||SKINS.classic).eye;
  }
  function skinAccent(){
    return (SKINS[state.me.skin]||SKINS.classic).accent;
  }

  function drawZombie(x,y,size,ang,isKing=false){
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(ang);

    ctx.fillStyle=skinBody();
    ctx.strokeStyle="rgba(255,255,255,.14)";
    ctx.lineWidth=2;
    ctx.beginPath();
    roundedPath(ctx, -size*0.55, -size*0.70, size*1.1, size*1.45, size*0.42);
    ctx.fill(); ctx.stroke();

    // face
    ctx.fillStyle="rgba(0,0,0,.28)";
    ctx.strokeStyle="rgba(255,255,255,.10)";
    ctx.lineWidth=1;
    ctx.beginPath();
    roundedPath(ctx, -size*0.42, -size*0.18, size*0.84, size*0.70, size*0.28);
    ctx.fill(); ctx.stroke();

    // eyes
    ctx.fillStyle=skinEye();
    ctx.beginPath(); ctx.arc(-size*0.18, -size*0.02, size*0.10, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( size*0.18, -size*0.02, size*0.10, 0, Math.PI*2); ctx.fill();

    // fever crown glow
    if(isKing || world.fever>0){
      ctx.fillStyle= isKing ? "rgba(255,213,106,.88)" : "rgba(255,47,109,.55)";
      ctx.beginPath();
      ctx.moveTo(-size*0.55, -size*0.68);
      ctx.lineTo(-size*0.20, -size*1.05);
      ctx.lineTo( 0,         -size*0.70);
      ctx.lineTo( size*0.20, -size*1.12);
      ctx.lineTo( size*0.55, -size*0.68);
      ctx.closePath();
      ctx.fill();
    }
    ctx.restore();
  }

  function drawHuman(x,y,elite){
    ctx.save(); ctx.translate(x,y);
    ctx.fillStyle = elite ? "rgba(255,213,106,.88)" : "rgba(255,255,255,.72)";
    ctx.strokeStyle = elite ? "rgba(255,213,106,.22)" : "rgba(255,255,255,.14)";
    ctx.lineWidth=2;

    ctx.beginPath(); roundedPath(ctx,-14,-10,28,38,14); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(0,-22,10,0,Math.PI*2); ctx.fill();

    if(elite){
      ctx.strokeStyle="rgba(32,255,154,.28)";
      ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(0,4,24,0,Math.PI*2); ctx.stroke();
    }
    ctx.restore();
  }

  function drawPickup(x,y,type){
    ctx.save(); ctx.translate(x,y);
    ctx.strokeStyle="rgba(255,255,255,.18)";
    ctx.lineWidth=2;
    if(type==="spore"){
      ctx.fillStyle="rgba(32,255,154,.85)";
      ctx.beginPath(); ctx.arc(0,0,14,0,Math.PI*2); ctx.fill(); ctx.stroke();
      ctx.fillStyle="rgba(0,0,0,.28)";
      ctx.beginPath(); ctx.arc(0,0,6,0,Math.PI*2); ctx.fill();
    }else{
      ctx.fillStyle="rgba(255,47,109,.85)";
      ctx.beginPath(); ctx.moveTo(0,-16); ctx.lineTo(14,0); ctx.lineTo(0,16); ctx.lineTo(-14,0); ctx.closePath();
      ctx.fill(); ctx.stroke();
    }
    ctx.restore();
  }

  function render(){
    drawBackground();
    drawGlow();

    // composite glow
    ctx.save();
    ctx.globalCompositeOperation="lighter";
    ctx.filter="blur(10px)";
    ctx.drawImage(glow,0,0,W,H);
    ctx.filter="none";
    ctx.globalAlpha=0.75;
    ctx.drawImage(glow,0,0,W,H);
    ctx.globalAlpha=1;
    ctx.globalCompositeOperation="source-over";
    ctx.restore();

    const gx=world.cam.x - W/2;
    const gy=world.cam.y - H/2;

    // shake
    const sx = (Math.random()*2-1)*shake;
    const sy = (Math.random()*2-1)*shake;

    ctx.save();
    ctx.translate(sx,sy);

    // pickups
    for(const p of world.pickups) drawPickup(p.x-gx, p.y-gy, p.type);

    // humans
    for(const h of world.humans){ if(h.alive) drawHuman(h.x-gx,h.y-gy,h.elite); }

    // horde
    for(const z of world.horde) drawZombie(z.x-gx,z.y-gy,15,z.ang,false);

    // player (king if many followers)
    const king = world.horde.length>=16;
    drawZombie(world.player.x-gx, world.player.y-gy, 20, world.player.ang, king);

    // particles
    ctx.globalCompositeOperation="lighter";
    for(const p of world.parts){
      const a=clamp(p.life/p.max,0,1);
      ctx.globalAlpha=a;
      ctx.fillStyle=p.color;
      ctx.beginPath(); ctx.arc(p.x-gx,p.y-gy,p.size,0,Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha=1;
    ctx.globalCompositeOperation="source-over";

    ctx.restore();

    // decay shake
    shake = Math.max(0, shake*0.86);
  }

  function update(dt){
    world.t += dt;

    if(world.running && !world.ended){
      world._sec=(world._sec||0)+dt;
      if(world._sec>=1000){
        world._sec-=1000;
        world.timeLeft--;
        if(world.timeLeft<=0) endRun();
        hud();
      }
    }

    // fever & rage timers
    if(world.fever>0) world.fever=Math.max(0, world.fever-dt);
    if(world.rage>0) world.rage=Math.max(0, world.rage-dt);

    // combo decay
    if(world.comboT>0) world.comboT--;
    else world.combo=Math.max(1, world.combo-1);

    ensurePopulation();

    const p=world.player;
    const vlen=Math.hypot(joy.x,joy.y);

    const speedBase = 300 + Math.min(170, world.horde.length*3);
    const rageBoost = world.rage>0 ? 1.25 : 1.0;
    const feverBoost = world.fever>0 ? 1.10 : 1.0;

    if(vlen>0.08 && world.running && !world.ended){
      const nx=joy.x/vlen, ny=joy.y/vlen;
      p.vx += nx*speedBase*rageBoost*feverBoost*(dt/1000);
      p.vy += ny*speedBase*rageBoost*feverBoost*(dt/1000);
      p.ang = Math.atan2(ny,nx);
    }else{
      p.vx *= Math.pow(0.002, dt/1000);
      p.vy *= Math.pow(0.002, dt/1000);
    }

    // dash
    p.dashCd=Math.max(0, p.dashCd-dt);
    if(dashPressed && p.dashCd<=0 && world.running && !world.ended){
      dashPressed=false;
      p.dashCd=880;
      const dnx=vlen>0.08 ? joy.x/vlen : Math.cos(p.ang);
      const dny=vlen>0.08 ? joy.y/vlen : Math.sin(p.ang);
      p.vx += dnx*760;
      p.vy += dny*760;
      spawnParts(p.x,p.y,"rgba(255,47,109,.22)", 26, 460);
      shake = Math.min(18, shake + 8);
      SFX.tap();
    }

    // friction + clamp
    const fr=Math.pow(0.03, dt/1000);
    p.vx*=fr; p.vy*=fr;
    const pv=Math.hypot(p.vx,p.vy);
    const vmax=540*(world.rage>0?1.1:1.0);
    if(pv>vmax){ p.vx=p.vx/pv*vmax; p.vy=p.vy/pv*vmax; }

    // integrate
    p.x+=p.vx*(dt/1000);
    p.y+=p.vy*(dt/1000);
    p.x=clamp(p.x,80,world.bounds.w-80);
    p.y=clamp(p.y,120,world.bounds.h-160);

    // humans wander + avoid
    for(const h of world.humans){
      if(!h.alive) continue;
      h.turnT-=dt;
      if(h.turnT<=0){
        h.turnT=600+Math.random()*1200;
        const a=Math.random()*Math.PI*2;
        const sp=h.elite ? 80+Math.random()*22 : 54+Math.random()*16;
        h.vx=Math.cos(a)*sp; h.vy=Math.sin(a)*sp;
      }
      const dx=h.x-p.x, dy=h.y-p.y;
      const dist=Math.hypot(dx,dy);
      if(dist<150){
        const inv=1/Math.max(1,dist);
        const ax=dx*inv, ay=dy*inv;
        const sp=h.elite?130:96;
        h.vx=lerp(h.vx, ax*sp, 0.08);
        h.vy=lerp(h.vy, ay*sp, 0.08);
      }
      h.x += h.vx*(dt/1000);
      h.y += h.vy*(dt/1000);
      if(h.x<90||h.x>world.bounds.w-90) h.vx*=-1;
      if(h.y<160||h.y>world.bounds.h-220) h.vy*=-1;
      h.x=clamp(h.x,90,world.bounds.w-90);
      h.y=clamp(h.y,160,world.bounds.h-220);
    }

    // horde follow chain
    let leadX=p.x, leadY=p.y, leadAng=p.ang;
    const spacing=30;
    for(const z of world.horde){
      const tx=leadX - Math.cos(leadAng)*spacing;
      const ty=leadY - Math.sin(leadAng)*spacing;
      z.x += (tx - z.x)*0.12;
      z.y += (ty - z.y)*0.12;
      z.ang = Math.atan2(leadY - z.y, leadX - z.x);
      leadX=z.x; leadY=z.y; leadAng=z.ang;
    }

    // collisions (player + horde)
    if(world.running && !world.ended){
      const feverRadius = world.fever>0 ? 12 : 0;

      for(const h of world.humans){
        if(!h.alive) continue;
        if(Math.hypot(h.x-p.x,h.y-p.y) < h.r + p.r + 2 + feverRadius) infectHuman(h,1);
      }
      for(const z of world.horde){
        for(const h of world.humans){
          if(!h.alive) continue;
          if(Math.hypot(h.x-z.x,h.y-z.y) < h.r + z.r + 2 + feverRadius) infectHuman(h,1);
        }
      }

      // pickups
      for(let i=world.pickups.length-1;i>=0;i--){
        const pu=world.pickups[i];
        if(Math.hypot(pu.x-p.x, pu.y-p.y) < pu.r + p.r + 6){
          world.pickups.splice(i,1);
          if(pu.type==="spore") sporeBomb(pu.x,pu.y);
          else{
            world.rage=5200;
            toast("RAGE BOOST ‚ö°", 1200);
            spawnParts(pu.x,pu.y,"rgba(255,47,109,.20)", 40, 520);
            SFX.success();
          }
        }
      }
    }

    // cleanup dead humans sometimes
    if(world.t % 400 < dt) world.humans=world.humans.filter(h=>h.alive);

    // particles
    for(const pt of world.parts){
      pt.life -= dt/1000;
      pt.x += pt.vx*(dt/1000);
      pt.y += pt.vy*(dt/1000);
      pt.vx *= Math.pow(0.20, dt/1000);
      pt.vy *= Math.pow(0.20, dt/1000);
    }
    world.parts=world.parts.filter(p=>p.life>0);

    // camera follow
    world.cam.x=lerp(world.cam.x, p.x, 0.08);
    world.cam.y=lerp(world.cam.y, p.y, 0.08);

    render();
  }

  function loop(ts){
    if(!last) last=ts;
    const dt=Math.min(32, ts-last);
    last=ts;
    update(dt);
    raf=requestAnimationFrame(loop);
  }

  // controls
  function initControls(){
    const stick=$("stick");
    const knob=$("knob");
    const dash=$("dash");
    let active=false, pid=null, base={x:0,y:0};

    const setKnob=(dx,dy)=>{
      const max=46;
      const dist=Math.hypot(dx,dy);
      const k=dist>max ? (max/dist) : 1;
      const x=dx*k, y=dy*k;
      knob.style.transform=`translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      joy.x = clamp(x/max,-1,1);
      joy.y = clamp(y/max,-1,1);
    };
    const resetJoy=()=>{
      knob.style.transform="translate(-50%,-50%)";
      joy.x=0; joy.y=0;
    };

    stick.addEventListener("pointerdown",(e)=>{
      active=true; pid=e.pointerId;
      stick.setPointerCapture(pid);
      const r=stick.getBoundingClientRect();
      base.x=r.left+r.width/2; base.y=r.top+r.height/2;
      setKnob(e.clientX-base.x, e.clientY-base.y);
    });
    stick.addEventListener("pointermove",(e)=>{
      if(!active || e.pointerId!==pid) return;
      setKnob(e.clientX-base.x, e.clientY-base.y);
    });
    stick.addEventListener("pointerup",(e)=>{
      if(e.pointerId!==pid) return;
      active=false; pid=null; resetJoy();
    });
    stick.addEventListener("pointercancel",()=>{ active=false; pid=null; resetJoy(); });

    dash.addEventListener("pointerdown",()=>{
      dashPressed=true;
      SFX.tap();
      setTimeout(()=>dashPressed=false, 140);
    });
  }

  // summary overlay
  function showSummary(){
    $("sumScore").textContent=String(world.score);
    $("sumStreak").textContent=String(world.streak);
    $("sumBonus").textContent="+"+String(world.bonus);
    $("runSummary").classList.add("show");
  }
  function hideSummary(){
    $("runSummary").classList.remove("show");
  }

  $("sumAgain").addEventListener("click", ()=>{
    SFX.unlock(); SFX.tap();
    reset();
    toast("–ù–æ–≤—ã–π –∑–∞–±–µ–≥");
  });
  $("sumShare").addEventListener("click", async ()=>{
    SFX.unlock(); SFX.tap();
    const link=myRefLink();
    const text=`ü¶† Viral Link RUN\nScore: ${world.score}\nBonus: +${world.bonus} INFECTED\nInfect via: ${link}`;
    const ok=await shareLink(text, link);
    if(!ok){ await copyToClipboard(text); toast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"); }
    else toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
    SFX.success();
  });

  $("btnRestart").addEventListener("click", ()=>{
    SFX.unlock(); SFX.tap();
    reset();
    toast("–ù–æ–≤—ã–π –∑–∞–±–µ–≥");
  });
  $("btnShareRun").addEventListener("click", async ()=>{
    SFX.unlock(); SFX.tap();
    const link=myRefLink();
    const text=`ü¶† Viral Link RUN ‚Ä¢ Score ${world.score} ‚Ä¢ Bonus +${world.bonus}\n${link}`;
    const ok=await shareLink(text, link);
    if(!ok){ await copyToClipboard(text); toast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"); }
    else toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
    SFX.success();
  });

  function boot(){
    resize();
    window.addEventListener("resize", resize);
    initControls();
    reset();
    raf=requestAnimationFrame(loop);
  }
  boot();

  return { reset, endRun };
})();

/* ---- Hook endRun when time ends already inside game ---- */

/* ---- First render + intro show once ---- */
function renderAll(){
  $("nickInput").value = state.me.nick || "";
  $("bioInput").value  = state.me.bio || "";
  $("link1").value = state.me.links?.[0] || "";
  $("link2").value = state.me.links?.[1] || "";
  $("link3").value = state.me.links?.[2] || "";
  renderChat(false);
  updateMotivationUI();
}
renderAll();

// Intro: show if not seen
if(localStorage.getItem("introSeen")!=="1") showIntro();
else $("intro").classList.add("hidden");

/* ---- Global tap unlock ---- */
document.addEventListener("pointerdown", ()=>SFX.unlock(), {once:false});

/* ---- After infected changes, unlock skins etc ---- */
function unlockByInfected(n){
  for(const key of Object.keys(SKINS)){
    const s=SKINS[key];
    if(n>=s.req && !state.me.unlocked.includes(key)){
      state.me.unlocked.push(key);
      toast(`UNLOCKED: ${s.name} SKIN`);
      SFX.success();
    }
  }
  save();
}

// ensure skins unlocked for existing infected
unlockByInfected(infectedCount());
updateMotivationUI();
</script>
</body>
</html>
