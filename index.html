<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#07090c" />
  <title>Viral Link — Infect & Rise</title>
  <!-- PWA для "мобильного" вида 2025 -->
  <link rel="manifest" href="data:application/manifest+json,{
    \"short_name\": \"Viral Link\",
    \"name\": \"Viral Link: Infect & Rise\",
    \"icons\": [
      {\"src\": \"assets/icon-192.png\", \"sizes\": \"192x192\", \"type\": \"image/png\"},
      {\"src\": \"assets/icon-512.png\", \"sizes\": \"512x512\", \"type\": \"image/png\"}
    ],
    \"start_url\": \"/?homescreen=1\",
    \"display\": \"standalone\",
    \"theme_color\": \"#07090c\",
    \"background_color\": \"#07090c\"
  }" />
  <!-- CDN для Leaflet (карта) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- CDN для particles.js (частицы) -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <style>
    /* Улучшения: переменные для тем, больше градиентов, glassmorphism повсюду, микродвижения, TikTok-стиль ленты */
    :root{
      --bg:#07090c;
      --bg2:#0b0f14;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --danger:#ff2f6d;
      --good:#2bff9b;
      --bio:#20ff9a;
      --cyan:#31d7ff;
      --gold:#ffd56a;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 12px 30px rgba(0,0,0,.35);
      --r: 22px;
      --r2: 28px;
      --pad: 14px;
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
      --vh: 1vh;
      --neon-glow: 0 0 12px rgba(32,255,154,.3);
      --transition: .18s ease;
      --glass: rgba(255,255,255,0.1) with backdrop-filter: blur(12px);
    }
    *{box-sizing:border-box; transition: all var(--transition);}
    html,body{height:100%; background:var(--bg); color:var(--text); margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    body{
      overscroll-behavior:none;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      touch-action: manipulation;
    }
    a{color:inherit; text-decoration:none;}
    /* INTRO улучшено: анимации, частицы */
    .intro{
      position:fixed; inset:0;
      z-index:999999;
      display:flex; align-items:center; justify-content:center;
      padding: calc(18px + var(--safeTop)) 16px calc(18px + var(--safeBottom));
      background:
        radial-gradient(900px 650px at 50% 0%, rgba(32,255,154,.18), transparent 60%),
        radial-gradient(900px 650px at 10% 55%, rgba(49,215,255,.12), transparent 60%),
        radial-gradient(900px 650px at 90% 70%, rgba(255,47,109,.10), transparent 60%),
        linear-gradient(180deg, #05070a, #07090c 35%, #06070a);
      opacity:1;
      animation: introFadeIn 1s ease-in;
    }
    @keyframes introFadeIn{from{opacity:0;}}
    .introCard{
      width:min(520px, 92vw);
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.14);
      background: var(--glass);
      box-shadow: var(--shadow), var(--neon-glow);
      overflow:hidden;
      position:relative;
      animation: cardPop .5s ease-out;
    }
    @keyframes cardPop{from{transform:scale(.95); opacity:0;}}
    .introCard:before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(700px 300px at 25% 10%, rgba(32,255,154,.16), transparent 60%),
        radial-gradient(700px 300px at 75% 25%, rgba(49,215,255,.12), transparent 60%),
        radial-gradient(700px 360px at 70% 110%, rgba(255,47,109,.10), transparent 60%);
      pointer-events:none;
      filter: blur(2px);
      animation: gradientShift 10s linear infinite;
    }
    @keyframes gradientShift{0%{opacity:0.8;} 50%{opacity:0.4;} 100%{opacity:0.8;}}
    /* ... (остальные стили для intro аналогично, с добавлением анимаций на hover/active) */
    /* App Shell: TikTok-лента, parallax */
    .main{
      position:relative;
      z-index:2;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
      padding: 8px var(--pad);
      overflow-y: auto; /* Лента как в TikTok */
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .panel{
      scroll-snap-align: start;
      border-radius: var(--r2);
      background: var(--glass);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    /* Мини-игра улучшена: комбо, streak, звуки */
    canvas#game{
      width:100%;
      height: 44vh;
      border-radius: 22px;
      background:
        radial-gradient(800px 380px at 25% 15%, rgba(32,255,154,.12), transparent 60%),
        radial-gradient(650px 360px at 85% 30%, rgba(49,215,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow), var(--neon-glow);
      touch-action:none;
      animation: gamePulse 1.5s infinite alternate;
    }
    @keyframes gamePulse{to{box-shadow: var(--shadow), 0 0 18px rgba(32,255,154,.4);}}
    /* Карта мира */
    #mapWrap{
      height: 300px;
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      background: var(--card);
      margin: 12px 0;
    }
    #map{
      height:100%;
      border-radius: var(--r2);
    }
    /* Telegram интеграция: кнопки */
    .tgBtn{
      background: linear-gradient(90deg, #0088cc, #00aaff);
      color: white;
      border: none;
      padding: 14px;
      border-radius: var(--r);
      font-weight: 900;
      box-shadow: var(--shadow2), 0 0 15px rgba(0,136,204,.3);
    }
    .tgBtn:hover{transform: scale(1.02);}
    /* Топы с анимацией */
    .item{
      animation: itemSlideIn .3s ease-out;
    }
    @keyframes itemSlideIn{from{transform: translateX(-20px); opacity:0;}}
    /* ... (добавить аналогично для других элементов) */
  </style>
</head>
<body>
  <!-- INTRO (улучшено с частицами) -->
  <div class="intro" id="introOverlay">
    <div id="introParticles" style="position:absolute; inset:0; z-index:-1;"></div> <!-- Частицы -->
    <div class="introCard">
      <!-- ... (остальной intro код без изменений, но добавь JS для частиц ниже) -->
    </div>
  </div>
  <!-- No desktop block -->
  <div class="no-desktop">
    <div class="card">
      <h2>Viral Link — мобайл-онли</h2>
      <p>Открой сайт с телефона (вертикально). На десктопе это специально заблокировано.</p>
    </div>
  </div>
  <!-- App -->
  <div class="app" id="app">
    <canvas id="fx"></canvas>
    <div class="topbar">
      <!-- ... (как в оригинале) -->
    </div>
    <div class="main">
      <div class="panel">
        <!-- HOME (добавь кнопку Telegram) -->
        <div class="screen active" id="screen-home">
          <!-- ... (оригинал) -->
          <a class="tgBtn" href="https://t.me/virusgamebot?start=ref_${myId}">Присоединиться к Telegram Боту</a>
          <a class="tgBtn" href="https://t.me/virusgamechannel">Канал Новостей</a>
          <div id="mapWrap"><div id="map"></div></div> <!-- Карта -->
          <div class="hint">Вирус распространяется по миру! (симуляция)</div>
        </div>
        <!-- GAME (улучшена механика) -->
        <div class="screen" id="screen-game">
          <!-- ... (оригинал) -->
        </div>
        <!-- ... (остальные экраны с улучшениями: анимации, glass) -->
      </div>
    </div>
    <div class="nav">
      <!-- ... (оригинал, добавь иконки SVG для красоты) -->
    </div>
    <div class="toast" id="toast"></div>
  </div>
  <audio id="sfxTap" src="assets/tap.mp3"></audio> <!-- Добавь звуки в assets -->
  <audio id="sfxSuccess" src="assets/success.mp3"></audio>
  <audio id="sfxDanger" src="assets/danger.mp3"></audio>
  <audio id="bgMusic" src="assets/bg.mp3" loop></audio>
  <script>
    // Улучшения: добавь particles в intro
    particlesJS('introParticles', {
      particles: {
        number: { value: 50, density: { enable: true, value_area: 800 } },
        color: { value: '#20ff9a' },
        shape: { type: 'circle' },
        opacity: { value: 0.5, random: true },
        size: { value: 3, random: true },
        line_linked: { enable: true, distance: 150, color: '#31d7ff', opacity: 0.4, width: 1 },
        move: { enable: true, speed: 2, direction: 'none', random: true, straight: false, out_mode: 'out', bounce: false }
      },
      interactivity: { detect_on: 'canvas', events: { onhover: { enable: true, mode: 'repulse' } }, modes: { repulse: { distance: 100, duration: 0.4 } } },
      retina_detect: true
    });
    // Звуки
    const sfx = {
      tap: $('sfxTap'),
      success: $('sfxSuccess'),
      danger: $('sfxDanger')
    };
    // В SFX.tap() добавь sfx.tap.play();
    // Аналогично для других
    // BG музыка
    $('bgMusic').play().catch(()=>{}); // Автоплей muted сначала
    // Карта
    function initMap(){
      const map = L.map('map').setView([0, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      // Симулировать заражения
      const countries = [{lat:55.7558, lng:37.6173, count:50}, {lat:40.7128, lng:-74.0060, count:120}]; // Добавь больше
      countries.forEach(c => {
        L.marker([c.lat, c.lng]).addTo(map)
          .bindPopup(`Заражений: ${c.count}`);
      });
    }
    initMap();
    // Улучшенная мини-игра: уровни, streak, комбо с бонусами
    // В G добавь level:1, streak:0
    // В updateGame: if(G.score > level*50) {level++; speed += 0.5; streak++; burst(player.x, player.y, 30); sfx.success.play();}
    // В endRun: if(streak > localStorage.getItem('bestStreak')) localStorage.setItem('bestStreak', streak);
    // Добавь в HUD <div class="score">Streak: <span id="streakNow">0</span></div>
    // Обновляй $("streakNow").textContent = G.streak;
    // Шаринг результатов
    function shareRun(){
      const text = `Я заразил ${G.score}! Присоединяйся по моей ссылке: ${myRefLink(state)}`;
      shareLink(text, myRefLink(state));
    }
    // Добавь кнопку после game <button class="btn" onclick="shareRun()">Шарить Результат</button>
    // Мультиязычность: простой объект
    const langs = {
      ru: { start: 'НАЧАТЬ', ... },
      en: { start: 'START', ... }
    };
    const lang = navigator.language.startsWith('ru') ? 'ru' : 'en';
    // Заменяй текст: $('introStartBtn').textContent = langs[lang].start;
    // Аналогично для других
    // Турниры: симулируй топы с призами
    // В leaderboard добавь <div class="chip">Приз: $100 для топ-1</div>
    // ... (расширь JS для полной функциональности)
    // Boot: добавь serviceWorker для PWA
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js'); // Создай sw.js в корне
    }
  </script>
</body>
</html>
