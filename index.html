<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#07090c" />
  <title>Viral Link ‚Äî Infect & Rise</title>

  <style>
    :root{
      --bg:#07090c;
      --bg2:#05070a;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --bio:#20ff9a;
      --cyan:#31d7ff;
      --pink:#ff2f6d;
      --gold:#ffd56a;
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --shadow2:0 12px 28px rgba(0,0,0,.35);
      --r:22px;
      --r2:28px;
      --pad:14px;
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{overflow:hidden;-webkit-tap-highlight-color:transparent;user-select:none}
    a{color:inherit}

    /* Mobile-only lock */
    @media (min-width: 820px) and (min-height: 520px){
      body:before{
        content:"Viral Link ‚Äî mobile only (vertical). Open on phone.";
        position:fixed; inset:0; z-index:99999;
        display:grid; place-items:center;
        background:linear-gradient(180deg,#05070a,#07090c);
        color:rgba(255,255,255,.82);
        font-weight:900; letter-spacing:.4px;
      }
    }

    /* Background */
    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1100px 700px at 50% 0%, rgba(32,255,154,.14), transparent 55%),
        radial-gradient(900px 700px at 12% 52%, rgba(49,215,255,.12), transparent 55%),
        radial-gradient(1000px 700px at 88% 64%, rgba(255,47,109,.10), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg) 35%, var(--bg2));
    }
    .noise{
      position:absolute; inset:0; opacity:.06; mix-blend-mode:overlay; pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.30'/%3E%3C/svg%3E");
    }

    /* App shell */
    .app{
      position:fixed; inset:0;
      display:flex; flex-direction:column; gap:10px;
      padding-top:calc(10px + var(--safeTop));
      padding-bottom:calc(10px + var(--safeBottom));
    }

    .topbar{
      padding:0 var(--pad);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      z-index:3;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .sigil{
      width:40px; height:40px; border-radius:15px;
      border:1px solid rgba(255,255,255,.16);
      box-shadow: var(--shadow2);
      position:relative; overflow:hidden;
      background:
        radial-gradient(circle at 30% 30%, rgba(32,255,154,.85), rgba(32,255,154,0) 60%),
        radial-gradient(circle at 70% 60%, rgba(49,215,255,.65), rgba(49,215,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.02));
    }
    .sigil:after{
      content:"";
      position:absolute; inset:-70%;
      background:conic-gradient(from 220deg, rgba(32,255,154,0), rgba(32,255,154,.25), rgba(49,215,255,0), rgba(255,47,109,.18), rgba(32,255,154,0));
      filter:blur(10px);
      animation:spin 6.4s linear infinite;
      opacity:.95;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .t{display:flex; flex-direction:column; line-height:1.05}
    .title{font-weight:950; letter-spacing:.8px; font-size:14px}
    .sub{font-size:11px; color:var(--muted)}

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:9px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
    }
    .dot{
      width:10px;height:10px;border-radius:99px;
      background:radial-gradient(circle at 30% 30%, rgba(32,255,154,1), rgba(32,255,154,.25));
      box-shadow:0 0 18px rgba(32,255,154,.35);
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;letter-spacing:.6px}

    .panel{
      margin:0 var(--pad);
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      flex:1;
      position:relative;
      z-index:2;
    }

    /* Screens */
    .screen{
      height:100%;
      display:none;
      flex-direction:column;
    }
    .screen.active{display:flex}

    .content{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      height:100%;
    }

    .hero{
      padding:16px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(700px 260px at 20% 10%, rgba(32,255,154,.18), transparent 60%),
        radial-gradient(700px 260px at 80% 30%, rgba(49,215,255,.12), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .hero:after{
      content:"";
      position:absolute; inset:-80%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform:rotate(22deg) translateX(-40%);
      animation:shine 2.6s ease-in-out infinite;
      opacity:.7;
      pointer-events:none;
    }
    @keyframes shine{
      0%{transform:rotate(22deg) translateX(-65%); opacity:0}
      18%{opacity:.55}
      55%{opacity:.35}
      100%{transform:rotate(22deg) translateX(65%); opacity:0}
    }
    .hero h1{margin:0 0 6px;font-size:18px;letter-spacing:.2px}
    .hero p{margin:0;color:rgba(255,255,255,.74);font-size:12.5px;line-height:1.35}
    .glowline{
      height:1px; margin:12px 0;
      background:linear-gradient(90deg, transparent, rgba(32,255,154,.65), rgba(49,215,255,.55), rgba(255,47,109,.30), transparent);
      opacity:.9;
    }

    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      font-size:12px;
    }
    .chip b{color:rgba(255,255,255,.96)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .stat{
      border-radius:20px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
    }
    .stat .k{font-size:11px;color:rgba(255,255,255,.65)}
    .stat .v{margin-top:3px;font-size:18px;font-weight:950}

    /* AAA Buttons */
    .btn{
      border:none; outline:none;
      width:100%;
      padding:14px 14px;
      border-radius:18px;
      font-weight:950;
      letter-spacing:.2px;
      color:rgba(0,0,0,.92);
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(140% 140% at 20% 20%, rgba(255,255,255,.55), rgba(255,255,255,0) 38%),
        linear-gradient(90deg, rgba(32,255,154,1), rgba(49,215,255,1));
      box-shadow:
        0 16px 40px rgba(0,0,0,.45),
        0 0 0 1px rgba(255,255,255,.20) inset,
        0 0 40px rgba(32,255,154,.18);
      transform: translateZ(0);
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:active{transform:scale(.985);filter:brightness(.98)}
    .btn.secondary{
      color:rgba(255,255,255,.92);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
    }
    .btn.danger{
      color:rgba(255,255,255,.92);
      background: linear-gradient(90deg, rgba(255,47,109,1), rgba(255,144,99,1));
      box-shadow:
        0 16px 40px rgba(0,0,0,.45),
        0 0 0 1px rgba(255,255,255,.16) inset,
        0 0 40px rgba(255,47,109,.18);
    }
    .btn .shine{
      position:absolute; inset:-70%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
      transform: rotate(25deg) translateX(-40%);
      animation: btnshine 2.4s ease-in-out infinite;
      opacity:.75;
      pointer-events:none;
    }
    @keyframes btnshine{
      0%{transform: rotate(25deg) translateX(-70%); opacity:0}
      20%{opacity:.55}
      60%{opacity:.35}
      100%{transform: rotate(25deg) translateX(70%); opacity:0}
    }

    /* Tabs */
    .tabs{
      padding:10px var(--pad);
      display:flex; gap:10px;
      z-index:3;
    }
    .tab{
      flex:1;
      padding:10px 10px;
      border-radius:16px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.72);
      font-weight:950;
      text-align:center;
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
      transition: transform .12s ease, background .12s ease, color .12s ease;
    }
    .tab.active{
      color: rgba(0,0,0,.88);
      background: linear-gradient(90deg, rgba(32,255,154,.95), rgba(49,215,255,.95));
      box-shadow: 0 14px 34px rgba(0,0,0,.35), 0 0 30px rgba(32,255,154,.14);
      border-color: rgba(255,255,255,.14);
    }
    .tab:active{transform:scale(.99)}

    /* Game container */
    #phaserWrap{
      flex:1;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      box-shadow: 0 20px 60px rgba(0,0,0,.40);
      overflow:hidden;
      position:relative;
    }
    #phaser{position:absolute; inset:0}

    /* HUD overlay (game) */
    .hud{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .hudBox{
      flex:1;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
      display:flex; align-items:center; justify-content:space-between;
      font-size:12px;
    }

    /* Virtual joystick */
    .joy{
      position:absolute;
      left:14px;
      bottom:14px;
      width:140px; height:140px;
      border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      touch-action:none;
    }
    .joy:before{
      content:"";
      position:absolute; inset:16px;
      border-radius:999px;
      border:1px dashed rgba(255,255,255,.10);
      opacity:.7;
    }
    .knob{
      position:absolute;
      left:50%; top:50%;
      width:56px; height:56px;
      transform:translate(-50%,-50%);
      border-radius:18px;
      background:
        radial-gradient(120% 120% at 20% 20%, rgba(255,255,255,.18), rgba(255,255,255,0) 45%),
        linear-gradient(90deg, rgba(32,255,154,.85), rgba(49,215,255,.85));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 16px 40px rgba(0,0,0,.45), 0 0 30px rgba(32,255,154,.15);
    }

    .dash{
      position:absolute;
      right:14px;
      bottom:16px;
      width:92px; height:92px;
      border-radius:26px;
      background:
        radial-gradient(140% 140% at 20% 20%, rgba(255,255,255,.16), rgba(255,255,255,0) 45%),
        linear-gradient(90deg, rgba(255,47,109,.95), rgba(255,144,99,.90));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 20px 60px rgba(0,0,0,.45), 0 0 34px rgba(255,47,109,.16);
      display:grid; place-items:center;
      font-weight:950;
      letter-spacing:.6px;
      color:rgba(255,255,255,.92);
      touch-action:none;
    }
    .dash:active{transform:scale(.985)}

    /* Chat */
    .chatBox{display:flex;flex-direction:column;gap:10px;flex:1}
    .chatList{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;gap:8px;padding-right:2px}
    .msg{align-self:flex-start;max-width:86%;padding:10px 12px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);box-shadow:0 10px 20px rgba(0,0,0,.18)}
    .msg.mine{align-self:flex-end;background:rgba(32,255,154,.10);border-color:rgba(32,255,154,.18)}
    .msg .h{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:4px}
    .msg .h b{font-size:11px}
    .msg .h span{font-size:10px;color:rgba(255,255,255,.60)}
    .msg p{margin:0;font-size:12.5px;color:rgba(255,255,255,.88);line-height:1.3;word-break:break-word}
    .msg audio{width:100%;margin-top:6px}
    .chatInput{display:flex;gap:10px;align-items:center;padding:10px;border-radius:18px;background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.10);box-shadow:0 12px 26px rgba(0,0,0,.24)}
    .chatInput input{flex:1;background:transparent;border:none;outline:none;color:rgba(255,255,255,.92);font-size:13px}
    .iconBtn{width:44px;height:44px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);display:grid;place-items:center;box-shadow:0 10px 22px rgba(0,0,0,.20)}
    .icon{width:18px;height:18px;opacity:.9;fill:none;stroke:rgba(255,255,255,.90);stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
    .recDot{width:10px;height:10px;border-radius:99px;background:rgba(255,47,109,1);box-shadow:0 0 18px rgba(255,47,109,.55);display:none}

    /* Profile fields */
    .field{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:20px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);box-shadow:0 10px 24px rgba(0,0,0,.22)}
    .field label{font-size:11px;color:rgba(255,255,255,.68)}
    .field input,.field textarea{width:100%;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.10);color:rgba(255,255,255,.92);border-radius:14px;padding:10px 12px;font-size:13px;outline:none;resize:none}
    .field textarea{min-height:72px;line-height:1.25}
    .tiny{font-size:11px;color:rgba(255,255,255,.62)}
    .muted{color:rgba(255,255,255,.66)}

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:calc(86px + var(--safeBottom));
      z-index:9999;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      color: rgba(255,255,255,.88);
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      max-width:92vw;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}

    /* INTRO overlay (video if exists, else cinematic) */
    .intro{
      position:fixed; inset:0; z-index:9998;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg,#05070a,#07090c);
    }
    .introVideo{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover;
      opacity:0;
      transition:opacity .35s ease;
      filter:contrast(1.05) saturate(1.05);
    }
    .introOn .introVideo{opacity:1}
    .intro:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 600px at 50% 10%, rgba(32,255,154,.16), transparent 60%),
        radial-gradient(900px 700px at 10% 60%, rgba(49,215,255,.12), transparent 60%),
        radial-gradient(900px 700px at 90% 70%, rgba(255,47,109,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.92), rgba(0,0,0,.18), rgba(0,0,0,.92));
      pointer-events:none;
    }
    .scan{
      position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(255,255,255,.04), rgba(255,255,255,0) 35%, rgba(255,255,255,.03));
      background-size: 100% 8px;
      opacity:.22;
      mix-blend-mode: overlay;
      pointer-events:none;
      animation:scan 1.2s linear infinite;
    }
    @keyframes scan{to{background-position:0 8px}}

    .introCard{
      position:relative;
      width:min(560px,92vw);
      border-radius:26px;
      padding:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .introCard:after{
      content:"";
      position:absolute; inset:-100%;
      background: conic-gradient(from 180deg, rgba(32,255,154,0), rgba(32,255,154,.18), rgba(49,215,255,0), rgba(255,47,109,.12), rgba(32,255,154,0));
      filter: blur(14px);
      animation:spin 8s linear infinite;
      opacity:.9;
      pointer-events:none;
    }
    .introCard h2{position:relative;margin:0 0 6px;font-size:18px;letter-spacing:1.2px;font-weight:950}
    .introCard p{position:relative;margin:0;color:rgba(255,255,255,.72);font-size:12.5px;line-height:1.35}
    .kbd{position:relative;display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.28)}
    .bar{position:relative;height:8px;border-radius:999px;background:rgba(255,255,255,.10);margin-top:12px;overflow:hidden;border:1px solid rgba(255,255,255,.10)}
    .bar > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--bio),var(--cyan));box-shadow:0 0 30px rgba(32,255,154,.25)}
    .fadeOut{animation:fadeOut .25s ease forwards}
    @keyframes fadeOut{to{opacity:0;transform:scale(1.01)}}
  </style>
</head>

<body>
  <div class="bg"><div class="noise"></div></div>

  <!-- INTRO -->
  <div class="intro" id="intro">
    <video class="introVideo" id="introVid" autoplay muted playsinline webkit-playsinline>
      <source src="assets/intro.webm" type="video/webm">
      <source src="assets/intro.mp4" type="video/mp4">
    </video>
    <div class="scan"></div>

    <div class="introCard">
      <h2>VIRAL LINK</h2>
      <p>
        –¢–≤–æ—è —Å—Å—ã–ª–∫–∞ ‚Äî –≤–∏—Ä—É—Å. –õ—é–±–æ–π, –∫—Ç–æ –æ—Ç–∫—Ä—ã–ª –∏–≥—Ä—É –ø–æ <span class="kbd mono">?ref=–¢–í–û–ô_ID</span>,
        —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ç–≤–æ–π <b>INFECTED</b>. <br/>
        –¢—ã —Å—Ç–∞–Ω–µ—à—å #1 —Ç–æ–ª—å–∫–æ —Ç–∞–∫: <b>–®–∞—Ä—å —Å—Å—ã–ª–∫—É ‚Üí –∑–∞—Ä–∞–∂–∞–π ‚Üí —Ä–∞—Å—Ç—ë—à—å</b>.
      </p>
      <div class="bar"><i id="introBar"></i></div>
      <div class="grid2" style="position:relative;margin-top:12px">
        <button class="btn" id="introStart">
          TAP TO START <span class="shine" aria-hidden="true"></span>
        </button>
        <button class="btn secondary" id="introSkip">SKIP</button>
      </div>
      <div class="tiny" style="position:relative;margin-top:8px">
        –ù–∞–∂–º–∏ START —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫ (–∞–≤—Ç–æ–ø–ª–µ–π –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è). –í–∏–¥–µ–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ ‚Äî –±–µ–∑ –Ω–µ–≥–æ –∏–Ω—Ç—Ä–æ —Ç–æ–∂–µ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –∑–∞—Å—Ç–∞–≤–∫–∞.
      </div>
    </div>
  </div>

  <div class="app" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="sigil" aria-hidden="true"></div>
        <div class="t">
          <div class="title">VIRAL LINK</div>
          <div class="sub">Infect ‚Ä¢ Rise ‚Ä¢ Rule</div>
        </div>
      </div>

      <div class="pill">
        <div class="dot"></div>
        <div style="font-size:11px;color:var(--muted)">ID</div>
        <div class="mono" id="myId">‚Äî</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-go="home">Home</div>
      <div class="tab" data-go="play">Play</div>
      <div class="tab" data-go="skins">Skins</div>
      <div class="tab" data-go="rank">Rank</div>
      <div class="tab" data-go="chat">Chat</div>
      <div class="tab" data-go="profile">Profile</div>
    </div>

    <div class="panel">
      <!-- HOME -->
      <div class="screen active" id="screen-home">
        <div class="content">
          <div class="hero">
            <h1>–¢–≤–æ—è —Å—Å—ã–ª–∫–∞ ‚Äî –≤–∏—Ä—É—Å.</h1>
            <p>
              –ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –∏–≥—Ä–æ–∫, –ø—Ä–∏—à–µ–¥—à–∏–π –ø–æ —Ç–≤–æ–µ–π —Å—Å—ã–ª–∫–µ, –¥–∞—ë—Ç —Ç–µ–±–µ +1 <b>INFECTED</b>.
              –í –∏–≥—Ä–µ —Ç—ã –µ—â—ë –ø–æ–ª—É—á–∞–µ—à—å –±–æ–Ω—É—Å—ã –∫ —Ä–∞–Ω–≥—É –∑–∞ –º–æ—â–Ω—ã–µ –∑–∞–±–µ–≥–∏.
            </p>
            <div class="glowline"></div>
            <div class="chips">
              <span class="chip"><span class="mono">REF</span><b id="refLabel">‚Äî</b></span>
              <span class="chip"><span class="mono">INFECTED</span><b id="infectedCount">0</b></span>
              <span class="chip"><span class="mono">FROM</span><b class="mono" id="infectedBy">‚Äî</b></span>
            </div>
          </div>

          <div class="grid2">
            <div class="stat">
              <div class="k">–¢–≤–æ–π –Ω–∏–∫</div>
              <div class="v" id="nickStat">PatientZero</div>
            </div>
            <div class="stat">
              <div class="k">–õ—É—á—à–∏–π –∑–∞–±–µ–≥</div>
              <div class="v"><span class="mono" id="bestRun">0</span></div>
            </div>
          </div>

          <button class="btn" id="btnGoPlay">
            PLAY ‚Ä¢ INFECT <span class="shine" aria-hidden="true"></span>
          </button>

          <div class="grid2">
            <button class="btn secondary" id="btnCopyLink">COPY VIRUS LINK</button>
            <button class="btn secondary" id="btnShare">SHARE</button>
          </div>

          <div class="tiny" style="text-align:center">
            –ü–æ–¥—Å–∫–∞–∑–∫–∞: –≤ –∫–æ–Ω—Ü–µ –∑–∞–±–µ–≥–∞ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å <b>RUN BONUS</b> –∫ INFECTED (–¥–µ–º–æ –ª–æ–∫–∞–ª—å–Ω–æ; –ø–æ–¥ —Å–µ—Ä–≤–µ—Ä ‚Äî –≥–æ—Ç–æ–≤–æ).
          </div>

          <button class="btn danger" id="btnReset">RESET DEMO</button>
        </div>
      </div>

      <!-- PLAY -->
      <div class="screen" id="screen-play">
        <div class="content" style="gap:12px">
          <div class="hero">
            <h1>Infect the City</h1>
            <p>
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ª–µ–≤—ã–π —Å—Ç–∏–∫ ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ. –ö–Ω–æ–ø–∫–∞ —Å–ø—Ä–∞–≤–∞ ‚Äî <b>DASH</b>. <br/>
              –ö–æ—Å–Ω–∏—Å—å –ª—é–¥–µ–π ‚Üí –æ–Ω–∏ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ —Ç–≤–æ—é –æ—Ä–¥—É. –≠–ª–∏—Ç–∞ –¥–∞—ë—Ç <b>–º—É–ª—å—Ç–∏-–±—É—Å—Ç</b>.
            </p>
            <div class="glowline"></div>
            <div class="chips">
              <span class="chip"><span class="mono">SCORE</span><b id="hudScore">0</b></span>
              <span class="chip"><span class="mono">COMBO</span><b id="hudCombo">x1</b></span>
              <span class="chip"><span class="mono">STREAK</span><b id="hudStreak">0</b></span>
              <span class="chip"><span class="mono">TIME</span><b id="hudTime">60</b></span>
            </div>
          </div>

          <div id="phaserWrap">
            <div id="phaser"></div>
            <div class="joy" id="joy"><div class="knob" id="knob"></div></div>
            <div class="dash" id="dash">DASH</div>
          </div>

          <div class="grid2">
            <button class="btn secondary" id="btnRestart">RESTART</button>
            <button class="btn" id="btnShareRun">SHARE RUN <span class="shine" aria-hidden="true"></span></button>
          </div>
        </div>
      </div>

      <!-- SKINS -->
      <div class="screen" id="screen-skins">
        <div class="content">
          <div class="hero">
            <h1>–°–∫–∏–Ω—ã</h1>
            <p>–≠—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –º–µ–Ω—è–µ—Ç –≤–∏–¥ –∑–æ–º–±–∏ (–∞—É—Ä–∞/–º–∞—Å–∫–∞/–≥–ª–∞–∑–∞/–∫–æ—Ä–æ–Ω–∞). –í—ã–±–µ—Ä–∏ –∏ –∏–≥—Ä–∞–π.</p>
            <div class="glowline"></div>
            <div class="chips">
              <span class="chip"><span class="mono">SELECTED</span><b id="skinSelected">classic</b></span>
              <span class="chip"><span class="mono">RARITY</span><b id="skinRarity">COMMON</b></span>
            </div>
          </div>

          <div class="grid2" id="skinGrid"></div>
          <button class="btn" id="btnSaveSkin">SAVE SKIN <span class="shine" aria-hidden="true"></span></button>
        </div>
      </div>

      <!-- RANK -->
      <div class="screen" id="screen-rank">
        <div class="content">
          <div class="hero">
            <h1>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</h1>
            <p>–ö—Ç–æ –∑–∞—Ä–∞–∑–∏–ª –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ª—é–¥–µ–π —Å—Å—ã–ª–∫–∞–º–∏ + –±–æ–Ω—É—Å—ã –∑–∞–±–µ–≥–æ–≤.</p>
            <div class="glowline"></div>
            <div class="chips">
              <span class="chip"><span class="mono">YOU</span><b id="youRank">‚Äî</b></span>
              <span class="chip"><span class="mono">TOTAL</span><b id="totalPlayers">‚Äî</b></span>
            </div>
          </div>

          <div class="field" id="rankList" style="gap:10px"></div>
          <div class="grid2">
            <button class="btn secondary" id="btnSeed">SEED DEMO PLAYERS</button>
            <button class="btn secondary" id="btnCopyLink2">COPY LINK</button>
          </div>
        </div>
      </div>

      <!-- CHAT -->
      <div class="screen" id="screen-chat">
        <div class="content">
          <div class="hero">
            <h1>Global Chat</h1>
            <p><b>–°—Å—ã–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã</b>. –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç + –≥–æ–ª–æ—Å–æ–≤—ã–µ. URL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Ä–µ–∂–µ—Ç—Å—è.</p>
            <div class="glowline"></div>
            <div class="chips">
              <span class="chip"><span class="mono">MODE</span><b>TEXT+VOICE</b></span>
              <span class="chip"><span class="mono">FILTER</span><b>NO URL</b></span>
            </div>
          </div>

          <div class="chatBox">
            <div class="chatList" id="chatList"></div>

            <div class="chatInput">
              <input id="chatText" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å—Å—ã–ª–∫–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã)" maxlength="220" />
              <button class="iconBtn" id="btnRec" title="Voice" aria-label="Voice">
                <span class="recDot" id="recDot"></span>
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3Z"></path>
                  <path d="M19 11a7 7 0 0 1-14 0"></path>
                  <path d="M12 18v3"></path>
                </svg>
              </button>
              <button class="iconBtn" id="btnSend" title="Send" aria-label="Send">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M22 2 11 13"></path>
                  <path d="M22 2 15 22 11 13 2 9 22 2Z"></path>
                </svg>
              </button>
            </div>

            <div class="tiny muted">–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–¥–µ–º–æ). –í –ø—Ä–æ–¥–µ ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.</div>
          </div>
        </div>
      </div>

      <!-- PROFILE -->
      <div class="screen" id="screen-profile">
        <div class="content">
          <div class="hero">
            <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
            <p>–¢—É—Ç –º–æ–∂–Ω–æ –±–∏–æ + —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏. –í —á–∞—Ç–µ ‚Äî –Ω–µ–ª—å–∑—è.</p>
            <div class="glowline"></div>
            <div class="chips">
              <span class="chip"><span class="mono">ID</span><b class="mono" id="profileId">‚Äî</b></span>
              <span class="chip"><span class="mono">SKIN</span><b id="profileSkin">‚Äî</b></span>
            </div>
          </div>

          <div class="field">
            <label>–ù–∏–∫ (–¥–æ 16)</label>
            <input id="nickInput" maxlength="16" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: PatientZero" />
          </div>

          <div class="field">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ (bio)</label>
            <textarea id="bioInput" maxlength="220" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ —Å–µ–±–µ..."></textarea>
          </div>

          <div class="field">
            <label>–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (–¥–æ 3) ‚Äî —Ç–æ–ª—å–∫–æ —Ç—É—Ç</label>
            <input id="link1" placeholder="https://..." />
            <input id="link2" placeholder="https://..." />
            <input id="link3" placeholder="https://..." />
            <div class="tiny muted">–î–æ–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ http/https. –û—Å—Ç–∞–ª—å–Ω–æ–µ –≤—ã—Ä–µ–∂–µ—Ç—Å—è.</div>
          </div>

          <button class="btn" id="btnSaveProfile">SAVE PROFILE <span class="shine" aria-hidden="true"></span></button>

          <div class="stat">
            <div class="k">–¢–≤–æ—è –≤–∏—Ä—É—Å-—Å—Å—ã–ª–∫–∞</div>
            <div class="v"><span class="mono" id="profileRef">‚Äî</span></div>
          </div>

          <button class="btn secondary" id="btnCopyProfileRef">COPY LINK</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <!-- Phaser -->
  <script src="https://unpkg.com/phaser@3.70.0/dist/phaser.min.js"></script>

  <script>
  /* =========================================================
     Viral Link ‚Äî single-file "real game" frontend (mobile only)
     - Core idea: ?ref=ID is virus referral
     - Clear onboarding + AAA intro
     - Actual 2D zombie infection game (top-down)
     - Skins really change zombie sprite (generated textures)
     - Local demo: leaderboard/chat/profile
     - Ready to swap storage to backend later
     ========================================================= */

  // ---------- tiny utils ----------
  const $ = (id)=>document.getElementById(id);
  const qa = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const nowTime=()=>new Date().toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
  const toast=(msg,ms=1600)=>{const t=$("toast");t.textContent=msg;t.classList.add("show");clearTimeout(toast._t);toast._t=setTimeout(()=>t.classList.remove("show"),ms)};
  const escapeHtml=(s)=>String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  const urlRe=/https?:\/\/[^\s]+|www\.[^\s]+|\b[\w.-]+\.[a-z]{2,}\b/ig;
  const stripUrls=(t)=>String(t||"").replace(urlRe,"[no-link]");

  // ---------- micro SFX (no files) ----------
  const SFX = (() => {
    let ctx=null;
    const beep=(f=220,ms=30,g=0.04)=>{
      try{
        ctx=ctx||new (window.AudioContext||window.webkitAudioContext)();
        const o=ctx.createOscillator(), gain=ctx.createGain();
        o.type="sine"; o.frequency.value=f; gain.gain.value=g;
        o.connect(gain); gain.connect(ctx.destination);
        o.start(); setTimeout(()=>o.stop(), ms);
      }catch(e){}
    };
    return {
      tap(){navigator.vibrate?.(10);beep(240,22,0.035);},
      success(){navigator.vibrate?.([18,10,18]);beep(420,40,0.045);},
      danger(){navigator.vibrate?.([25,12,25]);beep(140,70,0.05);},
    };
  })();

  // ---------- state / storage ----------
  const STORE="viral_link_ultra_v1";
  const genId=()=>{
    const a="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out=""; for(let i=0;i<8;i++) out+=a[(Math.random()*a.length)|0];
    return out;
  };
  const defaultState=()=>({
    me:{ id:genId(), nick:"PatientZero", skin:"classic", bio:"", links:[], infectedBy:null, bestRun:0 },
    players:{}, // id -> {id,nick,skin,infected}
    chat:[]     // {id,fromId,fromNick,t,text?,audioDataUrl?}
  });
  const loadState=()=>{
    try{
      const raw=localStorage.getItem(STORE);
      if(!raw){
        const s=defaultState();
        s.players[s.me.id]={id:s.me.id,nick:s.me.nick,skin:s.me.skin,infected:0};
        localStorage.setItem(STORE, JSON.stringify(s));
        return s;
      }
      const s=JSON.parse(raw);
      if(!s.me?.id) throw new Error("bad state");
      s.players=s.players||{};
      s.chat=s.chat||[];
      if(!s.players[s.me.id]) s.players[s.me.id]={id:s.me.id,nick:s.me.nick,skin:s.me.skin,infected:0};
      return s;
    }catch(e){
      const s=defaultState();
      s.players[s.me.id]={id:s.me.id,nick:s.me.nick,skin:s.me.skin,infected:0};
      localStorage.setItem(STORE, JSON.stringify(s));
      return s;
    }
  };
  const saveState=()=>localStorage.setItem(STORE, JSON.stringify(state));
  let state = loadState();

  // ---------- referral (virus link) ----------
  const getParam=(n)=>new URL(location.href).searchParams.get(n);
  const myRefLink=()=>{
    const base = location.origin + location.pathname;
    return `${base}?ref=${encodeURIComponent(state.me.id)}`;
  };
  (function applyReferral(){
    const ref=getParam("ref");
    if(!ref) return;
    if(ref===state.me.id) return;
    if(state.me.infectedBy) return;

    state.me.infectedBy=ref;
    state.players[ref]=state.players[ref] || {id:ref,nick:"Unknown",skin:"classic",infected:0};
    state.players[ref].infected = (state.players[ref].infected||0) + 1;
    saveState();
    toast("–¢—ã –∑–∞—Ä–∞–∂—ë–Ω –æ—Ç "+ref, 1800);
    SFX.success();
  })();

  // ---------- render UI ----------
  function renderTop(){
    $("myId").textContent=state.me.id;
  }
  function renderHome(){
    renderTop();
    $("refLabel").textContent="?ref="+state.me.id;
    $("infectedBy").textContent=state.me.infectedBy || "‚Äî";
    $("infectedCount").textContent=String(state.players[state.me.id]?.infected||0);
    $("nickStat").textContent=state.me.nick || "PatientZero";
    $("bestRun").textContent=String(state.me.bestRun||0);
  }

  // ---------- navigation ----------
  const screens=["home","play","skins","rank","chat","profile"];
  function showScreen(name){
    screens.forEach(s=>{
      const el=$("screen-"+s);
      if(el) el.classList.toggle("active", s===name);
    });
    qa(".tab").forEach(t=>t.classList.toggle("active", t.dataset.go===name));
    SFX.tap();

    if(name==="home") renderHome();
    if(name==="skins") renderSkins();
    if(name==="rank") renderRank();
    if(name==="chat") renderChat(true);
    if(name==="profile") renderProfile();
    if(name==="play") startGameIfNeeded();
  }
  qa(".tab").forEach(t=>t.addEventListener("click", ()=>showScreen(t.dataset.go)));

  // ---------- intro logic ----------
  const intro=$("intro"), introVid=$("introVid"), introBar=$("introBar");
  let introHasVideo=false;

  function tickIntroBar(){
    if(!intro) return;
    const d = introVid?.duration || 0;
    if(d>0){
      introHasVideo=true;
      intro.classList.add("introOn");
      introBar.style.width = clamp((introVid.currentTime/d)*100, 0, 100) + "%";
    }else{
      // cinematic fallback "fake progress"
      const t = (Date.now()%3600)/3600;
      introBar.style.width = (t*100) + "%";
    }
    requestAnimationFrame(tickIntroBar);
  }
  tickIntroBar();

  function closeIntro(){
    intro.classList.add("fadeOut");
    setTimeout(()=>intro.remove(), 220);
  }

  $("introSkip").addEventListener("click", ()=>{SFX.tap(); closeIntro();});
  $("introStart").addEventListener("click", async ()=>{
    SFX.success();
    try{
      introVid.muted=false;
      await introVid.play();
    }catch(e){}
    closeIntro();
  });

  introVid?.addEventListener("ended", closeIntro);

  // ---------- copy / share ----------
  async function copyToClipboard(text){
    try{ await navigator.clipboard.writeText(text); return true; }
    catch(e){
      const ta=document.createElement("textarea");
      ta.value=text; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy");
      ta.remove(); return true;
    }
  }
  async function shareLink(text, url){
    if(navigator.share){
      try{ await navigator.share({title:"Viral Link", text, url}); return true; }
      catch(e){ return false; }
    }
    return false;
  }

  $("btnGoPlay").addEventListener("click", ()=>showScreen("play"));
  $("btnCopyLink").addEventListener("click", async ()=>{
    await copyToClipboard(myRefLink());
    toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
    SFX.success();
  });
  $("btnCopyLink2").addEventListener("click", async ()=>{
    await copyToClipboard(myRefLink());
    toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
    SFX.success();
  });
  $("btnShare").addEventListener("click", async ()=>{
    const link=myRefLink();
    const ok = await shareLink("–ó–∞–π–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ ‚Äî –∏ —Ç—ã –∑–∞—Ä–∞–∂—ë–Ω üòà", link);
    if(!ok){ await copyToClipboard(link); toast("Share –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞"); }
    else toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
    SFX.success();
  });
  $("btnReset").addEventListener("click", ()=>{
    localStorage.removeItem(STORE);
    toast("–°–±—Ä–æ—à–µ–Ω–æ");
    SFX.danger();
    setTimeout(()=>location.href=location.pathname, 450);
  });

  // ---------- skins ----------
  const SKINS=[
    {id:"classic", name:"Classic Rot", rarity:"COMMON", aura:"bio"},
    {id:"neon",    name:"Neon Plague", rarity:"RARE",   aura:"cyan"},
    {id:"toxic",   name:"Toxic Bloom", rarity:"EPIC",   aura:"bio"},
    {id:"void",    name:"Void Carrier",rarity:"LEGEND", aura:"pink"},
    {id:"gold",    name:"Gilded Infection", rarity:"MYTHIC", aura:"gold"},
  ];
  const skinById=(id)=>SKINS.find(s=>s.id===id)||SKINS[0];
  let skinPick = skinById(state.me.skin);

  function auraGradient(aura){
    if(aura==="bio")  return "linear-gradient(90deg, rgba(32,255,154,.95), rgba(49,215,255,.70))";
    if(aura==="cyan") return "linear-gradient(90deg, rgba(49,215,255,.95), rgba(32,255,154,.70))";
    if(aura==="pink") return "linear-gradient(90deg, rgba(255,47,109,.95), rgba(255,144,99,.80))";
    if(aura==="gold") return "linear-gradient(90deg, rgba(255,213,106,.95), rgba(32,255,154,.80))";
    return "linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04))";
  }

  function renderSkins(){
    renderTop();
    skinPick = skinById(state.me.skin);
    $("skinSelected").textContent = skinPick.id;
    $("skinRarity").textContent = skinPick.rarity;

    const grid=$("skinGrid");
    grid.innerHTML="";
    SKINS.forEach(s=>{
      const btn=document.createElement("button");
      btn.className="btn secondary";
      btn.style.padding="12px";
      btn.style.background = "linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04))";
      btn.style.position="relative";
      btn.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:44px;height:44px;border-radius:16px;border:1px solid rgba(255,255,255,.14);
            background:${auraGradient(s.aura)}; box-shadow:0 12px 26px rgba(0,0,0,.28)"></div>
          <div style="text-align:left;flex:1">
            <div style="font-weight:950">${escapeHtml(s.name)}</div>
            <div style="font-size:11px;color:rgba(255,255,255,.62)">${escapeHtml(s.rarity)}</div>
          </div>
          <div style="font-weight:950;color:${s.id===state.me.skin ? 'rgba(32,255,154,.95)' : 'rgba(255,255,255,.72)'}">
            ${s.id===state.me.skin ? "EQUIP" : "PICK"}
          </div>
        </div>
      `;
      btn.addEventListener("click", ()=>{
        skinPick=s;
        $("skinSelected").textContent = s.id;
        $("skinRarity").textContent = s.rarity;
        toast("–í—ã–±—Ä–∞–Ω: "+s.name);
        SFX.tap();
      });
      grid.appendChild(btn);
    });
  }

  $("btnSaveSkin").addEventListener("click", ()=>{
    state.me.skin = skinPick.id;
    state.players[state.me.id].skin = state.me.skin;
    saveState();
    toast("–°–∫–∏–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω: "+skinPick.name);
    SFX.success();
    if(game?.scene?.keys?.City) game.scene.keys.City.events.emit("skinChanged");
    renderHome();
    renderProfile();
    renderSkins();
  });

  // ---------- rank ----------
  function computeRank(){
    const arr=Object.values(state.players||{}).map(p=>({
      id:p.id, nick:p.nick||"Unknown", skin:p.skin||"classic", infected:Number(p.infected||0)
    }));
    arr.sort((a,b)=>b.infected-a.infected || a.id.localeCompare(b.id));
    return arr;
  }
  function renderRank(){
    renderTop();
    const arr=computeRank();
    $("totalPlayers").textContent = String(arr.length);
    const myIndex = arr.findIndex(x=>x.id===state.me.id);
    $("youRank").textContent = myIndex>=0 ? "#"+(myIndex+1) : "‚Äî";

    const box=$("rankList");
    box.innerHTML="";
    arr.slice(0, 12).forEach((p,i)=>{
      const s=skinById(p.skin);
      const row=document.createElement("div");
      row.style.display="flex";
      row.style.alignItems="center";
      row.style.justifyContent="space-between";
      row.style.gap="10px";
      row.style.padding="12px";
      row.style.borderRadius="18px";
      row.style.background="rgba(255,255,255,.05)";
      row.style.border="1px solid rgba(255,255,255,.10)";
      row.style.boxShadow="0 10px 22px rgba(0,0,0,.20)";
      row.innerHTML=`
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:34px;height:34px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
            background:${auraGradient(s.aura)}"></div>
          <div>
            <div style="font-weight:950">${i+1}. ${escapeHtml(p.nick)}</div>
            <div class="mono" style="font-size:11px;color:rgba(255,255,255,.62)">${escapeHtml(p.id)}</div>
          </div>
        </div>
        <div style="min-width:74px;text-align:center;font-weight:950;border-radius:14px;padding:8px 10px;
          color:rgba(0,0,0,.90); background:linear-gradient(90deg, rgba(255,213,106,1), rgba(32,255,154,1));
          box-shadow:0 12px 28px rgba(0,0,0,.28)">${p.infected}</div>
      `;
      box.appendChild(row);
    });
  }
  $("btnSeed").addEventListener("click", ()=>{
    const names=["GraveRunner","NightBite","ZeroPulse","BioHaze","CyanFang","RotKing","PlagueMuse","VoidEcho","SporeWave","Wasteland"];
    for(let i=0;i<16;i++){
      const id=genId();
      state.players[id]={
        id,
        nick: names[(Math.random()*names.length)|0] + (10+((Math.random()*89)|0)),
        skin: SKINS[(Math.random()*SKINS.length)|0].id,
        infected: (Math.random()*60)|0
      };
    }
    saveState();
    toast("–î–µ–º–æ-–∏–≥—Ä–æ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã");
    SFX.success();
    renderRank();
  });

  // ---------- profile ----------
  function normalizeLinks(arr){
    const out=[];
    for(const raw of arr){
      if(!raw) continue;
      let s=String(raw).trim();
      if(!s) continue;
      if(!/^https?:\/\//i.test(s)) continue;
      if(s.length>120) s=s.slice(0,120);
      out.push(s);
      if(out.length>=3) break;
    }
    return out;
  }
  function renderProfile(){
    renderTop();
    $("profileId").textContent = state.me.id;
    $("profileSkin").textContent = skinById(state.me.skin).name;
    $("profileRef").textContent = myRefLink();

    $("nickInput").value = state.me.nick || "";
    $("bioInput").value = state.me.bio || "";
    $("link1").value = state.me.links?.[0] || "";
    $("link2").value = state.me.links?.[1] || "";
    $("link3").value = state.me.links?.[2] || "";
  }
  $("btnSaveProfile").addEventListener("click", ()=>{
    const nick = ($("nickInput").value||"").trim().slice(0,16) || "PatientZero";
    const bio  = ($("bioInput").value||"").trim().slice(0,220);
    const links= normalizeLinks([$("link1").value,$("link2").value,$("link3").value]);

    state.me.nick=nick; state.me.bio=bio; state.me.links=links;
    state.players[state.me.id]=state.players[state.me.id]||{id:state.me.id,nick,skin:state.me.skin,infected:0};
    state.players[state.me.id].nick=nick;
    state.players[state.me.id].skin=state.me.skin;

    saveState();
    toast("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
    SFX.success();
    renderHome(); renderProfile(); renderRank();
  });
  $("btnCopyProfileRef").addEventListener("click", async ()=>{
    await copyToClipboard(myRefLink());
    toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
    SFX.success();
  });

  // ---------- chat (text + voice, no links) ----------
  function addChat(msg){
    state.chat.push(msg);
    if(state.chat.length>80) state.chat=state.chat.slice(-80);
    saveState();
    renderChat(true);
  }
  function renderChat(keepScroll){
    renderTop();
    const list=$("chatList");
    const atBottom = list.scrollTop + list.clientHeight >= list.scrollHeight - 20;

    list.innerHTML="";
    (state.chat||[]).forEach(m=>{
      const div=document.createElement("div");
      div.className="msg"+(m.fromId===state.me.id?" mine":"");
      div.innerHTML=`
        <div class="h">
          <b>${escapeHtml(m.fromNick||"Unknown")}</b>
          <span>${escapeHtml(m.t||"")}</span>
        </div>
        ${m.text ? `<p>${escapeHtml(m.text)}</p>` : ``}
        ${m.audioDataUrl ? `<audio controls src="${m.audioDataUrl}"></audio>` : ``}
      `;
      list.appendChild(div);
    });

    if(keepScroll){
      if(atBottom) list.scrollTop=list.scrollHeight;
    }else{
      list.scrollTop=list.scrollHeight;
    }
  }
  function cryptoId(){
    try{ const a=new Uint8Array(8); crypto.getRandomValues(a); return Array.from(a).map(x=>x.toString(16).padStart(2,"0")).join(""); }
    catch(e){ return String(Math.random()).slice(2); }
  }
  function sendText(){
    const inp=$("chatText");
    let text=(inp.value||"").trim();
    if(!text) return;

    const cleaned=stripUrls(text);
    if(cleaned!==text){ toast("–°—Å—ã–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã ‚Äî —É–¥–∞–ª–µ–Ω–æ"); SFX.danger(); }
    text=cleaned.slice(0,220);

    addChat({id:cryptoId(),fromId:state.me.id,fromNick:state.me.nick,t:nowTime(),text});
    inp.value="";
    SFX.tap();
  }
  $("btnSend").addEventListener("click", sendText);
  $("chatText").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendText(); } });

  // voice
  let rec={active:false, mediaRecorder:null, chunks:[], stream:null};
  async function blobToDataURL(blob){
    return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); });
  }
  async function toggleRecord(){
    if(rec.active){
      try{rec.mediaRecorder.stop();}catch(e){}
      rec.active=false; $("recDot").style.display="none";
      toast("–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
      SFX.tap();
      return;
    }
    if(!navigator.mediaDevices?.getUserMedia){ toast("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"); SFX.danger(); return; }
    try{
      rec.stream=await navigator.mediaDevices.getUserMedia({audio:true});
      rec.chunks=[];
      rec.mediaRecorder=new MediaRecorder(rec.stream);
      rec.mediaRecorder.ondataavailable=(e)=>{ if(e.data && e.data.size>0) rec.chunks.push(e.data); };
      rec.mediaRecorder.onstop=async ()=>{
        try{rec.stream?.getTracks()?.forEach(t=>t.stop());}catch(e){}
        const blob=new Blob(rec.chunks,{type:"audio/webm"});
        const dataUrl=await blobToDataURL(blob);
        addChat({id:cryptoId(),fromId:state.me.id,fromNick:state.me.nick,t:nowTime(),audioDataUrl:dataUrl});
        SFX.success();
      };
      rec.mediaRecorder.start();
      rec.active=true; $("recDot").style.display="inline-block";
      toast("–ó–∞–ø–∏—Å—å... –Ω–∞–∂–º–∏ –µ—â—ë —Ä–∞–∑ —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å");
      SFX.tap();
    }catch(e){
      toast("–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω");
      SFX.danger();
    }
  }
  $("btnRec").addEventListener("click", toggleRecord);

  // ---------- GAME (Phaser) ----------
  let game=null;
  let joyVec={x:0,y:0}; // -1..1
  let dashPressed=false;

  // Virtual joystick
  (function initJoystick(){
    const joy=$("joy"), knob=$("knob"), dash=$("dash");
    let active=false, base={x:0,y:0}, pid=null;

    const setKnob=(dx,dy)=>{
      const max=46;
      const dist=Math.hypot(dx,dy);
      const k=dist>max ? (max/dist) : 1;
      const x=dx*k, y=dy*k;
      knob.style.transform=`translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      joyVec.x = clamp(x/max, -1, 1);
      joyVec.y = clamp(y/max, -1, 1);
    };
    const reset=()=>{
      knob.style.transform="translate(-50%,-50%)";
      joyVec.x=0; joyVec.y=0;
    };

    joy.addEventListener("pointerdown",(e)=>{
      active=true; pid=e.pointerId; joy.setPointerCapture(pid);
      const r=joy.getBoundingClientRect();
      base.x=r.left+r.width/2; base.y=r.top+r.height/2;
      const dx=e.clientX-base.x, dy=e.clientY-base.y;
      setKnob(dx,dy);
    });
    joy.addEventListener("pointermove",(e)=>{
      if(!active || e.pointerId!==pid) return;
      const dx=e.clientX-base.x, dy=e.clientY-base.y;
      setKnob(dx,dy);
    });
    joy.addEventListener("pointerup",(e)=>{
      if(e.pointerId!==pid) return;
      active=false; pid=null; reset();
    });
    joy.addEventListener("pointercancel",()=>{active=false; pid=null; reset();});

    dash.addEventListener("pointerdown",()=>{
      dashPressed=true;
      SFX.tap();
      setTimeout(()=>dashPressed=false, 140);
    });
  })();

  function startGameIfNeeded(){
    if(game) return;
    const cfg={
      type: Phaser.AUTO,
      parent: "phaser",
      backgroundColor: "rgba(0,0,0,0)",
      scale: { mode: Phaser.Scale.RESIZE, autoCenter: Phaser.Scale.CENTER_BOTH },
      physics: { default: "arcade", arcade: { gravity: {y:0}, debug:false } },
      scene: CityScene
    };
    game=new Phaser.Game(cfg);
  }

  function CityScene(){
    Phaser.Scene.call(this, { key:"City" });
  }
  CityScene.prototype = Object.create(Phaser.Scene.prototype);
  CityScene.prototype.constructor = CityScene;

  // generate "AAA neon sprites" (no external PNG needed)
  function makeZombieTexture(scene, key, aura){
    const g=scene.make.graphics({x:0,y:0,add:false});
    const W=96,H=96;

    const colors={
      bio:  {core:0x20ff9a, glow:0x20ff9a, eye:0x06130d, accent:0x31d7ff},
      cyan: {core:0x31d7ff, glow:0x31d7ff, eye:0x071014, accent:0x20ff9a},
      pink: {core:0xff2f6d, glow:0xff2f6d, eye:0x14060b, accent:0xff9063},
      gold: {core:0xffd56a, glow:0xffd56a, eye:0x151106, accent:0x20ff9a},
    };
    const c=colors[aura]||colors.bio;

    // glow blob
    g.fillStyle(c.glow, 0.18);
    g.fillCircle(W*0.50,H*0.52, 42);

    // body
    g.fillStyle(c.core, 0.95);
    g.fillRoundedRect(22,18,52,60, 18);
    g.lineStyle(2, 0xffffff, 0.16);
    g.strokeRoundedRect(22,18,52,60, 18);

    // face plate
    g.fillStyle(0x000000, 0.25);
    g.fillRoundedRect(28,30,40,32, 12);
    g.lineStyle(1, 0xffffff, 0.12);
    g.strokeRoundedRect(28,30,40,32, 12);

    // eyes
    g.fillStyle(c.accent, 0.85);
    g.fillCircle(40,44,4);
    g.fillCircle(56,44,4);
    g.fillStyle(c.eye, 0.50);
    g.fillCircle(40,44,2);
    g.fillCircle(56,44,2);

    // mouth
    g.lineStyle(2, c.accent, 0.35);
    g.beginPath();
    g.moveTo(38,56); g.lineTo(58,56);
    g.strokePath();

    // accessories by aura
    if(aura==="pink"){ // "void mask"
      g.fillStyle(0x000000, 0.35);
      g.fillRoundedRect(30,26,36,40, 14);
      g.lineStyle(2, c.core, 0.25);
      g.strokeRoundedRect(30,26,36,40, 14);
    }
    if(aura==="gold"){ // crown
      g.fillStyle(c.core, 0.88);
      g.fillTriangle(28,20, 40,8, 44,20);
      g.fillTriangle(44,20, 52,6, 60,20);
      g.fillTriangle(60,20, 68,10, 76,22);
      g.lineStyle(2, 0xffffff, 0.14);
      g.strokePath();
    }

    // render texture
    const tex=scene.textures.createCanvas(key, W, H);
    tex.context.clearRect(0,0,W,H);
    g.generateTexture(key, W, H);
    g.destroy();
  }

  function makeHumanTexture(scene, key, elite=false){
    const g=scene.make.graphics({x:0,y:0,add:false});
    const W=64,H=64;

    const core = elite ? 0xffd56a : 0xffffff;
    const alpha= elite ? 0.85 : 0.70;

    // soft glow
    g.fillStyle(core, elite ? 0.14 : 0.10);
    g.fillCircle(W*0.50,H*0.55, elite ? 26 : 22);

    // body
    g.fillStyle(core, alpha);
    g.fillRoundedRect(18,16,28,38, 14);
    g.lineStyle(2, core, elite ? 0.20 : 0.16);
    g.strokeRoundedRect(18,16,28,38, 14);

    // head
    g.fillStyle(core, alpha);
    g.fillCircle(32,16,10);

    // elite ring
    if(elite){
      g.lineStyle(2, 0x20ff9a, 0.30);
      g.strokeCircle(32, 34, 24);
    }

    g.generateTexture(key, W, H);
    g.destroy();
  }

  CityScene.prototype.preload = function(){
    // generate textures
    // (we generate once in create; preload stays empty)
  };

  CityScene.prototype.create = function(){
    const scene=this;

    // textures (only once)
    const auraMap = {
      classic:"bio", neon:"cyan", toxic:"bio", void:"pink", gold:"gold"
    };
    const aura = auraMap[state.me.skin] || "bio";

    // create textures for all skins (so switching is instant)
    const allAura={
      classic:"bio", neon:"cyan", toxic:"bio", void:"pink", gold:"gold"
    };
    Object.keys(allAura).forEach(skin=>{
      const a=allAura[skin];
      const key="z_"+skin;
      if(!scene.textures.exists(key)) makeZombieTexture(scene, key, a);
    });
    if(!scene.textures.exists("h")) makeHumanTexture(scene,"h",false);
    if(!scene.textures.exists("e")) makeHumanTexture(scene,"e",true);

    // world
    scene.w = scene.scale.width;
    scene.h = scene.scale.height;

    // background grid
    scene.bg = scene.add.graphics().setDepth(0);
    scene.drawBG = ()=>{
      const W=scene.scale.width,H=scene.scale.height;
      scene.bg.clear();
      scene.bg.fillStyle(0x000000, 0.14);
      scene.bg.fillRoundedRect(14,14,W-28,H-28,22);
      scene.bg.lineStyle(2, 0xffffff, 0.06);
      scene.bg.strokeRoundedRect(14,14,W-28,H-28,22);

      // faint grid
      scene.bg.lineStyle(1, 0xffffff, 0.05);
      const step = Math.max(44, Math.floor(Math.min(W,H)/10));
      for(let x=0;x<W;x+=step){ scene.bg.lineBetween(x,0,x,H); }
      for(let y=0;y<H;y+=step){ scene.bg.lineBetween(0,y,W,y); }

      // arcs glow
      scene.bg.lineStyle(2, 0x20ff9a, 0.07);
      scene.bg.strokeCircle(W*0.24,H*0.34, Math.min(W,H)*0.42);
      scene.bg.lineStyle(2, 0x31d7ff, 0.07);
      scene.bg.strokeCircle(W*0.78,H*0.62, Math.min(W,H)*0.36);
    };
    scene.drawBG();
    scene.scale.on("resize", scene.drawBG);

    // player
    scene.player = scene.physics.add.sprite(scene.scale.width*0.5, scene.scale.height*0.5, "z_"+state.me.skin).setDepth(5);
    scene.player.setCollideWorldBounds(true);
    scene.player.setDamping(true);
    scene.player.setDrag(600,600);
    scene.player.setMaxVelocity(420,420);

    // groups
    scene.humans = scene.physics.add.group();
    scene.zombies = scene.physics.add.group(); // followers
    scene.spawnTimer=0;

    // particles
    scene.p = scene.add.particles(0xffffff).setDepth(6);
    scene.em = scene.p.createEmitter({
      speed:{min:80,max:260},
      lifespan:{min:240,max:560},
      scale:{start:.7,end:0},
      alpha:{start:.35,end:0},
      quantity:0,
      blendMode:"ADD"
    });

    // game stats
    scene.score=0;
    scene.combo=1;
    scene.comboT=0;
    scene.streak=0;
    scene.timeLeft=60; // seconds
    scene.bestLocal=0;
    scene.runEnded=false;

    // spawn humans
    scene.spawnHuman = ()=>{
      const elite = Math.random() < 0.14;
      const x = Math.random()*(scene.scale.width-80)+40;
      const y = Math.random()*(scene.scale.height-200)+80; // avoid joystick region a bit
      const h = scene.humans.create(x,y, elite?"e":"h").setDepth(3);
      h.elite=elite;
      h.hit=false;
      h.speed = elite ? 68 : 52;
      h.dir = new Phaser.Math.Vector2(Math.random()*2-1, Math.random()*2-1).normalize();
      h.nextTurn = 0;
      h.setCircle(elite?18:16, elite?14:16, elite?14:16);
      h.setImmovable(true);
    };

    // initial population
    for(let i=0;i<18;i++) scene.spawnHuman();

    // infect logic (player + followers)
    const infect = (hu, byX, byY)=>{
      if(hu.hit) return;
      hu.hit=true;

      const add = hu.elite ? 4 : 1;
      scene.score += add * scene.combo;
      scene.combo = Math.min(14, scene.combo + (hu.elite ? 3 : 1));
      scene.comboT = 80;
      scene.streak += 1;

      scene.em.explode(26 + add*10, hu.x, hu.y);

      // turn into follower zombie
      const f = scene.zombies.create(hu.x, hu.y, "z_"+state.me.skin).setDepth(4);
      f.setAlpha(0.92);
      f.setScale(0.64);
      f.followIndex = scene.zombies.getLength();
      f.setCircle(16, 16, 16);

      hu.destroy();
      SFX.tap();
      updateHUD();
    };

    scene.physics.add.overlap(scene.player, scene.humans, (_,hu)=>infect(hu, scene.player.x, scene.player.y));
    scene.physics.add.overlap(scene.zombies, scene.humans, (z,hu)=>infect(hu, z.x, z.y));

    // skin changes live
    scene.events.on("skinChanged", ()=>{
      scene.player.setTexture("z_"+state.me.skin);
      scene.zombies.children.each(z=>{ if(z?.active) z.setTexture("z_"+state.me.skin); });
    });

    // timer
    scene.time.addEvent({
      delay:1000,
      loop:true,
      callback:()=>{
        if(scene.runEnded) return;
        scene.timeLeft--;
        updateHUD();
        if(scene.timeLeft<=0) endRun();
      }
    });

    function updateHUD(){
      $("hudScore").textContent = String(scene.score);
      $("hudCombo").textContent = "x"+String(scene.combo);
      $("hudStreak").textContent = String(scene.streak);
      $("hudTime").textContent = String(scene.timeLeft);
    }
    updateHUD();

    function endRun(){
      scene.runEnded=true;

      // best run
      state.me.bestRun = Math.max(state.me.bestRun||0, scene.score);

      // RUN BONUS to infected (every 25 score => +1)
      const bonus = Math.floor(scene.score / 25);
      if(bonus>0){
        state.players[state.me.id].infected = (state.players[state.me.id].infected||0) + bonus;
      }
      saveState();
      renderHome();
      renderRank();

      toast(`RUN OVER ‚Ä¢ SCORE ${scene.score} ‚Ä¢ BONUS +${bonus} INFECTED`, 2400);
      SFX.success();
    }

    $("btnRestart").onclick=()=>{
      SFX.tap();
      scene.scene.restart();
      setTimeout(()=>{ // reset HUD text quickly
        $("hudScore").textContent="0";
        $("hudCombo").textContent="x1";
        $("hudStreak").textContent="0";
        $("hudTime").textContent="60";
      }, 30);
    };

    $("btnShareRun").onclick=async ()=>{
      const link=myRefLink();
      const text=`Viral Link ‚Äî my score: ${scene.score}. Infect via my link: ${link}`;
      const ok=await shareLink(text, link);
      if(!ok){ await copyToClipboard(text); toast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"); }
      SFX.success();
    };
  };

  CityScene.prototype.update = function(_, dt){
    const scene=this;
    if(!scene.player) return;

    // spawn flow
    scene.spawnTimer += dt;
    const targetPop = 18 + Math.min(18, Math.floor(scene.score/12));
    const need = targetPop - scene.humans.getLength();
    if(need>0 && scene.spawnTimer > 220){
      scene.spawnTimer = 0;
      for(let i=0;i<Math.min(3,need);i++) scene.spawnHuman();
    }

    // combo decay
    if(scene.comboT>0) scene.comboT--;
    else scene.combo = Math.max(1, scene.combo - 1);

    // player movement from joystick
    const v = new Phaser.Math.Vector2(joyVec.x, joyVec.y);
    const speedBase = 280 + Math.min(140, scene.zombies.getLength()*3);
    if(v.length()>0.08){
      v.normalize();
      scene.player.setAcceleration(v.x*speedBase, v.y*speedBase);
      scene.player.setRotation(Math.atan2(v.y, v.x));
    }else{
      scene.player.setAcceleration(0,0);
    }

    // dash
    if(dashPressed && !scene.runEnded){
      dashPressed=false;
      const dir = v.length()>0.08 ? v.normalize() : new Phaser.Math.Vector2(Math.cos(scene.player.rotation), Math.sin(scene.player.rotation));
      scene.player.setVelocity(dir.x*620, dir.y*620);
      scene.em.explode(24, scene.player.x, scene.player.y);
      SFX.tap();
    }

    // humans wander + avoid zombies
    const px=scene.player.x, py=scene.player.y;
    scene.humans.children.each(hu=>{
      if(!hu?.active) return;
      hu.nextTurn -= dt;
      if(hu.nextTurn<=0){
        hu.nextTurn = 600 + Math.random()*900;
        hu.dir = new Phaser.Math.Vector2(Math.random()*2-1, Math.random()*2-1).normalize();
      }

      // avoid
      const dx=hu.x-px, dy=hu.y-py;
      const dist=Math.hypot(dx,dy);
      if(dist < 120){
        const away = new Phaser.Math.Vector2(dx,dy).normalize();
        hu.dir = away;
        hu.nextTurn = 300;
      }

      const sp = hu.speed;
      hu.x += hu.dir.x * sp * (dt/1000);
      hu.y += hu.dir.y * sp * (dt/1000);

      // bounds
      const W=scene.scale.width, H=scene.scale.height;
      hu.x = clamp(hu.x, 28, W-28);
      hu.y = clamp(hu.y, 28, H-28);
    });

    // follower trail (simple snake)
    const trailDist = 26;
    let leadX=scene.player.x, leadY=scene.player.y;
    scene.zombies.children.each((z,i)=>{
      if(!z?.active) return;
      const tx = leadX - Math.cos(scene.player.rotation)*trailDist;
      const ty = leadY - Math.sin(scene.player.rotation)*trailDist;
      const dx = tx - z.x, dy = ty - z.y;
      const d = Math.hypot(dx,dy);
      const k = d>1 ? 1 : 0;
      z.x += dx * 0.10;
      z.y += dy * 0.10;
      z.rotation = Math.atan2(leadY - z.y, leadX - z.x);
      leadX = z.x; leadY = z.y;
    });
  };

  // ---------- boot ----------
  function renderAll(){
    // ensure me in players
    state.players[state.me.id]=state.players[state.me.id]||{id:state.me.id,nick:state.me.nick,skin:state.me.skin,infected:0};
    state.players[state.me.id].nick = state.me.nick;
    state.players[state.me.id].skin = state.me.skin;
    saveState();
    renderHome(); renderSkins(); renderRank(); renderChat(); renderProfile();
  }

  // bind some buttons
  $("btnCopyLink2").addEventListener("click", async ()=>{
    await copyToClipboard(myRefLink());
    toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
    SFX.success();
  });

  // initial
  renderAll();

  // wake lock (best effort)
  (async ()=>{ try{ if("wakeLock" in navigator){ await navigator.wakeLock.request("screen"); } }catch(e){} })();

  </script>
</body>
</html>
