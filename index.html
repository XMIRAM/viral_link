import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";

/**
 * Viral Link — mobile-only vertical AAA-ish frontend (no backend).
 * - Referral-as-virus: ?ref=INFECTION_ID
 * - Leaderboard (mock + local)
 * - 2D mini-game (canvas) focused on infecting
 * - Skins
 * - Global chat: text + voice ONLY (links blocked)
 * - Profile: bio + allowed links (NOT in global chat)
 *
 * Drop into a Next.js page or Vite React app.
 */

const LS = {
  me: "vl_me_v1",
  chat: "vl_chat_v1",
  leaderboard: "vl_lb_v1",
  settings: "vl_settings_v1",
};

function clamp(n, a, b) {
  return Math.max(a, Math.min(b, n));
}

function randId(len = 7) {
  const alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let s = "";
  for (let i = 0; i < len; i++) s += alphabet[Math.floor(Math.random() * alphabet.length)];
  return s;
}

function nowTs() {
  return Date.now();
}

function formatCompact(n) {
  if (n < 1000) return String(n);
  if (n < 1_000_000) return `${(n / 1000).toFixed(n >= 10_000 ? 0 : 1)}K`;
  return `${(n / 1_000_000).toFixed(n >= 10_000_000 ? 0 : 1)}M`;
}

function safeJsonParse(s, fallback) {
  try {
    const v = JSON.parse(s);
    return v ?? fallback;
  } catch {
    return fallback;
  }
}

function getQueryParam(name) {
  if (typeof window === "undefined") return null;
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

function setQueryParam(name, value) {
  if (typeof window === "undefined") return;
  const url = new URL(window.location.href);
  if (!value) url.searchParams.delete(name);
  else url.searchParams.set(name, value);
  window.history.replaceState({}, "", url.toString());
}

function looksLikeLink(text) {
  // Strict-ish URL detection; blocks http(s), www, and typical domain patterns.
  const urlLike = /(https?:\/\/|www\.)\S+/i;
  const domainLike = /\b[a-z0-9-]+\.(com|net|org|io|gg|ru|de|at|uk|ua|me|app|dev|xyz|store|site|link|info|biz|tv)\b/i;
  return urlLike.test(text) || domainLike.test(text);
}

function useLocalStorageState(key, initialValue) {
  const [state, setState] = useState(() => {
    if (typeof window === "undefined") return initialValue;
    const raw = window.localStorage.getItem(key);
    return raw ? safeJsonParse(raw, initialValue) : initialValue;
  });

  useEffect(() => {
    if (typeof window === "undefined") return;
    window.localStorage.setItem(key, JSON.stringify(state));
  }, [key, state]);

  return [state, setState];
}

function useHaptics() {
  return {
    tap: (ms = 18) => {
      try {
        if (navigator.vibrate) navigator.vibrate(ms);
      } catch {}
    },
  };
}

function GlowBg() {
  return (
    <div className="pointer-events-none absolute inset-0 overflow-hidden">
      <div className="absolute -top-24 left-1/2 h-64 w-[36rem] -translate-x-1/2 rounded-full bg-emerald-500/20 blur-3xl" />
      <div className="absolute top-44 -left-28 h-72 w-72 rounded-full bg-cyan-400/12 blur-3xl" />
      <div className="absolute bottom-[-10rem] right-[-10rem] h-[28rem] w-[28rem] rounded-full bg-emerald-400/12 blur-3xl" />
      <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_20%,rgba(16,185,129,0.08),transparent_45%),radial-gradient(circle_at_20%_70%,rgba(34,211,238,0.06),transparent_40%),radial-gradient(circle_at_80%_80%,rgba(16,185,129,0.06),transparent_40%)]" />
      <div className="absolute inset-0 opacity-[0.06] [background-image:linear-gradient(to_right,rgba(255,255,255,0.12)_1px,transparent_1px),linear-gradient(to_bottom,rgba(255,255,255,0.12)_1px,transparent_1px)] [background-size:22px_22px]" />
    </div>
  );
}

function NeonCard({ children, className = "" }) {
  return (
    <div
      className={
        "relative rounded-3xl border border-white/10 bg-white/[0.03] shadow-[0_0_0_1px_rgba(16,185,129,0.08),0_18px_60px_rgba(0,0,0,0.55)] backdrop-blur-xl " +
        className
      }
    >
      <div className="pointer-events-none absolute inset-0 rounded-3xl bg-[radial-gradient(circle_at_30%_20%,rgba(16,185,129,0.10),transparent_55%),radial-gradient(circle_at_70%_80%,rgba(34,211,238,0.08),transparent_55%)]" />
      <div className="relative">{children}</div>
    </div>
  );
}

function NeonButton({ children, onClick, disabled, variant = "primary", className = "" }) {
  const base =
    "relative w-full select-none rounded-2xl px-4 py-3 text-sm font-semibold tracking-wide transition active:scale-[0.99]";
  const styles = {
    primary:
      "text-black bg-emerald-400 hover:bg-emerald-300 shadow-[0_0_0_1px_rgba(16,185,129,0.35),0_14px_40px_rgba(16,185,129,0.22)]",
    ghost:
      "text-white bg-white/[0.04] hover:bg-white/[0.06] border border-white/10 shadow-[0_0_0_1px_rgba(34,211,238,0.10)]",
    danger:
      "text-white bg-red-500/90 hover:bg-red-500 shadow-[0_0_0_1px_rgba(239,68,68,0.35),0_14px_40px_rgba(239,68,68,0.18)]",
  };
  const ring =
    variant === "primary"
      ? "before:content-[''] before:absolute before:inset-0 before:rounded-2xl before:opacity-60 before:blur-md before:bg-emerald-400/30"
      : variant === "danger"
      ? "before:content-[''] before:absolute before:inset-0 before:rounded-2xl before:opacity-60 before:blur-md before:bg-red-500/25"
      : "";

  return (
    <button
      disabled={disabled}
      onClick={onClick}
      className={`${base} ${styles[variant]} ${ring} ${disabled ? "opacity-50" : ""} ${className}`}
    >
      <span className="relative z-10">{children}</span>
    </button>
  );
}

function Segmented({ value, onChange, options }) {
  return (
    <div className="grid grid-cols-3 gap-2 rounded-2xl border border-white/10 bg-white/[0.03] p-2">
      {options.map((opt) => (
        <button
          key={opt.value}
          onClick={() => onChange(opt.value)}
          className={
            "rounded-xl px-3 py-2 text-xs font-semibold transition " +
            (value === opt.value
              ? "bg-emerald-400 text-black shadow-[0_0_0_1px_rgba(16,185,129,0.25)]"
              : "text-white/80 hover:bg-white/[0.04]")
          }
        >
          {opt.label}
        </button>
      ))}
    </div>
  );
}

function BottomNav({ tab, setTab }) {
  const items = [
    { k: "home", label: "Hub" },
    { k: "play", label: "Play" },
    { k: "skins", label: "Skins" },
    { k: "chat", label: "Chat" },
    { k: "profile", label: "Profile" },
  ];
  return (
    <div className="fixed bottom-0 left-0 right-0 z-50 mx-auto max-w-md px-4 pb-4">
      <NeonCard className="p-2">
        <div className="grid grid-cols-5 gap-1">
          {items.map((it) => (
            <button
              key={it.k}
              onClick={() => setTab(it.k)}
              className={
                "rounded-2xl px-2 py-3 text-[11px] font-semibold transition " +
                (tab === it.k
                  ? "bg-emerald-400 text-black shadow-[0_0_0_1px_rgba(16,185,129,0.25)]"
                  : "text-white/70 hover:bg-white/[0.04]")
              }
            >
              {it.label}
            </button>
          ))}
        </div>
      </NeonCard>
    </div>
  );
}

function Toast({ toast, clear }) {
  return (
    <AnimatePresence>
      {toast ? (
        <motion.div
          initial={{ y: 20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          exit={{ y: 20, opacity: 0 }}
          className="fixed left-0 right-0 top-4 z-[60] mx-auto max-w-md px-4"
        >
          <NeonCard className="p-3">
            <div className="flex items-start justify-between gap-3">
              <div>
                <div className="text-xs font-semibold text-emerald-300">{toast.title}</div>
                <div className="mt-1 text-sm text-white/90">{toast.msg}</div>
              </div>
              <button
                onClick={clear}
                className="rounded-xl bg-white/[0.05] px-3 py-2 text-xs font-semibold text-white/80 hover:bg-white/[0.08]"
              >
                OK
              </button>
            </div>
          </NeonCard>
        </motion.div>
      ) : null}
    </AnimatePresence>
  );
}

function Modal({ open, title, children, onClose }) {
  return (
    <AnimatePresence>
      {open ? (
        <motion.div
          className="fixed inset-0 z-[70] flex items-end justify-center bg-black/70 px-4 pb-24 pt-16"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
        >
          <motion.div
            initial={{ y: 20, scale: 0.98, opacity: 0 }}
            animate={{ y: 0, scale: 1, opacity: 1 }}
            exit={{ y: 20, scale: 0.98, opacity: 0 }}
            className="w-full max-w-md"
          >
            <NeonCard className="p-5">
              <div className="flex items-start justify-between gap-3">
                <div>
                  <div className="text-xs font-semibold text-emerald-300">{title}</div>
                </div>
                <button
                  onClick={onClose}
                  className="rounded-xl bg-white/[0.05] px-3 py-2 text-xs font-semibold text-white/80 hover:bg-white/[0.08]"
                >
                  Close
                </button>
              </div>
              <div className="mt-4">{children}</div>
            </NeonCard>
          </motion.div>
        </motion.div>
      ) : null}
    </AnimatePresence>
  );
}

function StatPill({ label, value }) {
  return (
    <div className="rounded-2xl border border-white/10 bg-white/[0.03] px-3 py-2">
      <div className="text-[10px] font-semibold uppercase tracking-widest text-white/50">{label}</div>
      <div className="mt-0.5 text-lg font-extrabold text-white">{value}</div>
    </div>
  );
}

function SectionTitle({ kicker, title, right }) {
  return (
    <div className="flex items-end justify-between gap-3">
      <div>
        <div className="text-[10px] font-semibold uppercase tracking-[0.18em] text-emerald-300/80">
          {kicker}
        </div>
        <div className="mt-1 text-xl font-extrabold text-white">{title}</div>
      </div>
      {right}
    </div>
  );
}

function LobbyBanner({ me, onShare }) {
  const shareUrl = useMemo(() => {
    if (typeof window === "undefined") return "";
    const url = new URL(window.location.href);
    url.searchParams.set("ref", me.infectionId);
    return url.toString();
  }, [me.infectionId]);

  return (
    <NeonCard className="p-4">
      <div className="flex items-center justify-between gap-3">
        <div>
          <div className="text-[10px] font-semibold uppercase tracking-widest text-white/50">
            Your Infection ID
          </div>
          <div className="mt-1 font-mono text-2xl font-extrabold tracking-widest text-emerald-300">
            {me.infectionId}
          </div>
          <div className="mt-1 text-xs text-white/60">Share your link. Every new player = +1 infected.</div>
        </div>
        <div className="w-28">
          <NeonButton
            onClick={() => onShare(shareUrl)}
            className="py-3"
          >
            Share
          </NeonButton>
        </div>
      </div>
      <div className="mt-3 rounded-2xl border border-white/10 bg-black/30 p-3">
        <div className="text-[10px] font-semibold uppercase tracking-widest text-white/50">Link</div>
        <div className="mt-1 break-all font-mono text-xs text-white/80">{shareUrl}</div>
      </div>
    </NeonCard>
  );
}

function HomeScreen({ me, leaderboard, setTab, onShare }) {
  const top3 = [...leaderboard]
    .sort((a, b) => (b.infectedCount ?? 0) - (a.infectedCount ?? 0))
    .slice(0, 3);

  return (
    <div className="space-y-4">
      <SectionTitle
        kicker="Viral Link"
        title="Infection Hub"
        right={
          <div className="rounded-2xl border border-white/10 bg-white/[0.03] px-3 py-2 text-xs font-semibold text-white/70">
            Mobile-only
          </div>
        }
      />

      <div className="grid grid-cols-3 gap-2">
        <StatPill label="Rank" value={`#${me.rank}`} />
        <StatPill label="Infected" value={formatCompact(me.infectedCount)} />
        <StatPill label="Skin" value={me.skinName} />
      </div>

      <LobbyBanner me={me} onShare={onShare} />

      <NeonCard className="p-4">
        <div className="flex items-start justify-between gap-3">
          <div>
            <div className="text-[10px] font-semibold uppercase tracking-[0.18em] text-white/50">Today</div>
            <div className="mt-1 text-lg font-extrabold text-white">Daily Infection Run</div>
            <div className="mt-1 text-sm text-white/70">
              30 seconds. Infect as many humans as you can. Your score powers your profile.
            </div>
          </div>
          <div className="w-28">
            <NeonButton onClick={() => setTab("play")}>Play</NeonButton>
          </div>
        </div>
      </NeonCard>

      <NeonCard className="p-4">
        <div className="flex items-center justify-between">
          <div>
            <div className="text-[10px] font-semibold uppercase tracking-[0.18em] text-white/50">Leaderboard</div>
            <div className="mt-1 text-lg font-extrabold text-white">Top Infectors</div>
          </div>
          <button
            onClick={() => setTab("leaderboard")}
            className="rounded-xl bg-white/[0.05] px-3 py-2 text-xs font-semibold text-white/80 hover:bg-white/[0.08]"
          >
            See all
          </button>
        </div>
        <div className="mt-4 space-y-2">
          {top3.map((p, i) => (
            <div
              key={p.infectionId}
              className="flex items-center justify-between rounded-2xl border border-white/10 bg-white/[0.03] px-3 py-3"
            >
              <div className="flex items-center gap-3">
                <div className="grid h-10 w-10 place-items-center rounded-2xl bg-emerald-400/15 text-sm font-extrabold text-emerald-200">
                  {i + 1}
                </div>
                <div>
                  <div className="text-sm font-bold text-white">{p.name}</div>
                  <div className="mt-0.5 font-mono text-[11px] text-white/50">{p.infectionId}</div>
                </div>
              </div>
              <div className="text-right">
                <div className="text-sm font-extrabold text-emerald-200">{formatCompact(p.infectedCount)}</div>
                <div className="text-[10px] font-semibold uppercase tracking-[0.18em] text-white/45">infected</div>
              </div>
            </div>
          ))}
        </div>
      </NeonCard>

      <div className="grid grid-cols-2 gap-3">
        <NeonButton variant="ghost" onClick={() => setTab("skins")}>Change skin</NeonButton>
        <NeonButton variant="ghost" onClick={() => setTab("chat")}>Global chat</NeonButton>
      </div>

      <div className="pb-24" />
    </div>
  );
}

function LeaderboardScreen({ leaderboard, me, setTab }) {
  const sorted = [...leaderboard].sort((a, b) => (b.infectedCount ?? 0) - (a.infectedCount ?? 0));
  return (
    <div className="space-y-4">
      <SectionTitle kicker="Ranked" title="Global Leaderboard" right={
        <button
          onClick={() => setTab("home")}
          className="rounded-2xl border border-white/10 bg-white/[0.03] px-3 py-2 text-xs font-semibold text-white/70 hover:bg-white/[0.06]"
        >
          Back
        </button>
      } />
      <NeonCard className="p-4">
        <div className="text-sm text-white/70">Your position updates locally here (backend later). UI is ready.</div>
      </NeonCard>
      <NeonCard className="p-3">
        <div className="space-y-2">
          {sorted.map((p, idx) => {
            const isMe = p.infectionId === me.infectionId;
            return (
              <div
                key={p.infectionId}
                className={
                  "flex items-center justify-between rounded-2xl border px-3 py-3 " +
                  (isMe
                    ? "border-emerald-400/40 bg-emerald-400/10"
                    : "border-white/10 bg-white/[0.03]")
                }
              >
                <div className="flex items-center gap-3">
                  <div className={
                    "grid h-10 w-10 place-items-center rounded-2xl text-sm font-extrabold " +
                    (idx === 0
                      ? "bg-emerald-400 text-black"
                      : "bg-white/[0.05] text-white")
                  }>
                    {idx + 1}
                  </div>
                  <div>
                    <div className="text-sm font-extrabold text-white">
                      {p.name} {isMe ? <span className="ml-2 rounded-full bg-emerald-400/20 px-2 py-1 text-[10px] font-bold text-emerald-200">YOU</span> : null}
                    </div>
                    <div className="mt-0.5 font-mono text-[11px] text-white/50">{p.infectionId}</div>
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-sm font-extrabold text-emerald-200">{formatCompact(p.infectedCount)}</div>
                  <div className="text-[10px] font-semibold uppercase tracking-[0.18em] text-white/45">infected</div>
                </div>
              </div>
            );
          })}
        </div>
      </NeonCard>
      <div className="pb-24" />
    </div>
  );
}

function SkinsScreen({ skins, me, setMe, setToast }) {
  const { tap } = useHaptics();
  return (
    <div className="space-y-4">
      <SectionTitle kicker="Style" title="Choose your Zombie Skin" />

      <NeonCard className="p-4">
        <div className="text-sm text-white/70">
          Skins are cosmetic. Pick your vibe. (Art slots now — plug your real assets later.)
        </div>
      </NeonCard>

      <div className="grid grid-cols-2 gap-3">
        {skins.map((s) => {
          const selected = me.skinId === s.id;
          return (
            <button
              key={s.id}
              onClick={() => {
                tap();
                setMe((prev) => ({ ...prev, skinId: s.id, skinName: s.name }));
                setToast({ title: "Skin equipped", msg: `${s.name} is now active.` });
              }}
              className={
                "relative overflow-hidden rounded-3xl border p-3 text-left transition active:scale-[0.99] " +
                (selected
                  ? "border-emerald-400/45 bg-emerald-400/10"
                  : "border-white/10 bg-white/[0.03] hover:bg-white/[0.05]")
              }
            >
              <div className="pointer-events-none absolute inset-0 opacity-70" style={{ background: s.bg }} />
              <div className="relative">
                <div className="text-sm font-extrabold text-white drop-shadow">{s.name}</div>
                <div className="mt-1 text-xs font-semibold text-white/70">{s.tagline}</div>
                <div className="mt-3 flex items-center justify-between">
                  <div className="rounded-2xl bg-black/30 px-2 py-1 text-[10px] font-bold text-white/80">
                    {s.rarity}
                  </div>
                  {selected ? (
                    <div className="rounded-2xl bg-emerald-400 px-2 py-1 text-[10px] font-extrabold text-black">
                      EQUIPPED
                    </div>
                  ) : (
                    <div className="rounded-2xl bg-white/[0.06] px-2 py-1 text-[10px] font-bold text-white/80">
                      TAP
                    </div>
                  )}
                </div>
              </div>
            </button>
          );
        })}
      </div>

      <div className="pb-24" />
    </div>
  );
}

function useMediaRecorder() {
  const [status, setStatus] = useState("idle"); // idle | recording | blocked
  const [error, setError] = useState(null);
  const recorderRef = useRef(null);
  const chunksRef = useRef([]);

  async function start() {
    setError(null);
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const rec = new MediaRecorder(stream);
      chunksRef.current = [];
      rec.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) chunksRef.current.push(e.data);
      };
      rec.onstop = () => {
        try {
          stream.getTracks().forEach((t) => t.stop());
        } catch {}
      };
      recorderRef.current = rec;
      rec.start();
      setStatus("recording");
    } catch (e) {
      setStatus("blocked");
      setError(e);
    }
  }

  function stop() {
    const rec = recorderRef.current;
    if (!rec) return null;
    return new Promise((resolve) => {
      rec.onstop = () => {
        let blob = null;
        try {
          blob = new Blob(chunksRef.current, { type: "audio/webm" });
        } catch {
          blob = null;
        }
        resolve(blob);
      };
      try {
        rec.stop();
      } catch {
        resolve(null);
      }
      setStatus("idle");
    });
  }

  return { status, error, start, stop };
}

function ChatScreen({ me, chat, setChat, setToast }) {
  const [text, setText] = useState("");
  const [mode, setMode] = useState("text"); // text | voice
  const listRef = useRef(null);
  const { tap } = useHaptics();
  const rec = useMediaRecorder();

  useEffect(() => {
    // auto scroll bottom
    const el = listRef.current;
    if (!el) return;
    el.scrollTop = el.scrollHeight;
  }, [chat.length]);

  function sendText() {
    const msg = text.trim();
    if (!msg) return;
    if (looksLikeLink(msg)) {
      setToast({ title: "Links blocked", msg: "Global chat запрещает ссылки и домены. Только текст и голосовые." });
      return;
    }
    tap();
    setChat((prev) => [
      ...prev,
      {
        id: randId(10),
        type: "text",
        from: { id: me.infectionId, name: me.name, skin: me.skinName },
        ts: nowTs(),
        text: msg,
      },
    ]);
    setText("");
  }

  async function startVoice() {
    tap();
    await rec.start();
    if (rec.error) {
      setToast({ title: "Mic blocked", msg: "Разреши микрофон в браузере, чтобы отправлять голосовые." });
    }
  }

  async function stopVoiceAndSend() {
    tap();
    const blob = await rec.stop();
    if (!blob) {
      setToast({ title: "Voice failed", msg: "Не удалось записать голосовое. Попробуй ещё раз." });
      return;
    }
    const url = URL.createObjectURL(blob);
    setChat((prev) => [
      ...prev,
      {
        id: randId(10),
        type: "voice",
        from: { id: me.infectionId, name: me.name, skin: me.skinName },
        ts: nowTs(),
        audioUrl: url,
      },
    ]);
  }

  return (
    <div className="space-y-4">
      <SectionTitle kicker="Community" title="Global Chat" right={
        <div className="rounded-2xl border border-white/10 bg-white/[0.03] px-3 py-2 text-[11px] font-semibold text-white/70">
          No links • No files
        </div>
      } />

      <NeonCard className="p-4">
        <div className="text-sm text-white/70">
          Текст + голосовые. Любые ссылки/домены автоматически блокируются.
        </div>
      </NeonCard>

      <NeonCard className="p-0 overflow-hidden">
        <div ref={listRef} className="max-h-[52vh] overflow-y-auto p-4 space-y-3">
          {chat.length === 0 ? (
            <div className="rounded-3xl border border-white/10 bg-white/[0.02] p-5 text-center">
              <div className="text-sm font-extrabold text-white">No messages yet</div>
              <div className="mt-1 text-xs text-white/60">Say something. Start the infection.</div>
            </div>
          ) : null}

          {chat.map((m) => (
            <div key={m.id} className="rounded-3xl border border-white/10 bg-white/[0.03] p-3">
              <div className="flex items-start justify-between gap-2">
                <div>
                  <div className="text-sm font-extrabold text-white">
                    {m.from.name}
                    <span className="ml-2 rounded-full bg-white/[0.06] px-2 py-1 text-[10px] font-bold text-white/70">
                      {m.from.skin}
                    </span>
                  </div>
                  <div className="mt-0.5 font-mono text-[10px] text-white/45">{m.from.id}</div>
                </div>
                <div className="text-[10px] font-semibold text-white/45">{new Date(m.ts).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</div>
              </div>
              <div className="mt-2">
                {m.type === "text" ? (
                  <div className="text-sm text-white/90 whitespace-pre-wrap">{m.text}</div>
                ) : (
                  <audio controls src={m.audioUrl} className="w-full" />
                )}
              </div>
            </div>
          ))}
        </div>

        <div className="border-t border-white/10 bg-black/40 p-3">
          <Segmented
            value={mode}
            onChange={setMode}
            options={[
              { value: "text", label: "Text" },
              { value: "voice", label: "Voice" },
              { value: "rules", label: "Rules" },
            ]}
          />

          <div className="mt-3">
            {mode === "text" ? (
              <div className="flex gap-2">
                <input
                  value={text}
                  onChange={(e) => setText(e.target.value)}
                  placeholder="Write… (no links)"
                  className="w-full rounded-2xl border border-white/10 bg-white/[0.03] px-4 py-3 text-sm text-white placeholder:text-white/35 outline-none focus:border-emerald-400/40"
                />
                <button
                  onClick={sendText}
                  className="rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-black"
                >
                  Send
                </button>
              </div>
            ) : mode === "voice" ? (
              <div className="space-y-2">
                {rec.status !== "recording" ? (
                  <NeonButton onClick={startVoice}>Hold to record (tap start)</NeonButton>
                ) : (
                  <div className="grid grid-cols-2 gap-2">
                    <NeonButton variant="danger" onClick={() => { rec.stop(); setToast({ title: "Canceled", msg: "Voice recording canceled." }); }}>Cancel</NeonButton>
                    <NeonButton onClick={stopVoiceAndSend}>Stop & Send</NeonButton>
                  </div>
                )}
                <div className="text-xs text-white/60">
                  Tip: use headphones. Voice messages are stored locally in this demo.
                </div>
              </div>
            ) : (
              <div className="rounded-2xl border border-white/10 bg-white/[0.03] p-3 text-sm text-white/75">
                <div className="font-extrabold text-white">Chat rules</div>
                <ul className="mt-2 list-disc pl-5 space-y-1">
                  <li>NO links / domains</li>
                  <li>NO file sharing</li>
                  <li>Text + voice only</li>
                </ul>
              </div>
            )}
          </div>
        </div>
      </NeonCard>

      <div className="pb-24" />
    </div>
  );
}

function ProfileScreen({ me, setMe, setToast }) {
  const [editing, setEditing] = useState(false);
  const [name, setName] = useState(me.name);
  const [bio, setBio] = useState(me.bio);
  const [links, setLinks] = useState(me.links.join("\n"));

  function save() {
    const nextLinks = links
      .split("\n")
      .map((l) => l.trim())
      .filter(Boolean)
      .slice(0, 5);

    // allow http(s) links in profile (allowed area)
    const normalized = nextLinks.map((l) => {
      if (/^https?:\/\//i.test(l)) return l;
      // if user pastes without scheme, add https
      if (/^[a-z0-9-]+\./i.test(l)) return `https://${l}`;
      return l; // keep as-is (could be @handle)
    });

    setMe((prev) => ({
      ...prev,
      name: name.trim().slice(0, 18) || prev.name,
      bio: bio.trim().slice(0, 240),
      links: normalized,
    }));
    setEditing(false);
    setToast({ title: "Profile updated", msg: "Bio & links saved." });
  }

  return (
    <div className="space-y-4">
      <SectionTitle
        kicker="Identity"
        title="Your Profile"
        right={
          <button
            onClick={() => setEditing((v) => !v)}
            className="rounded-2xl border border-white/10 bg-white/[0.03] px-3 py-2 text-xs font-semibold text-white/70 hover:bg-white/[0.06]"
          >
            {editing ? "Cancel" : "Edit"}
          </button>
        }
      />

      <NeonCard className="p-4">
        <div className="flex items-center justify-between gap-3">
          <div>
            <div className="text-[10px] font-semibold uppercase tracking-[0.18em] text-white/50">Infection ID</div>
            <div className="mt-1 font-mono text-xl font-extrabold tracking-widest text-emerald-300">{me.infectionId}</div>
          </div>
          <div className="text-right">
            <div className="text-[10px] font-semibold uppercase tracking-[0.18em] text-white/50">Infected</div>
            <div className="mt-1 text-xl font-extrabold text-white">{formatCompact(me.infectedCount)}</div>
          </div>
        </div>
      </NeonCard>

      <NeonCard className="p-4">
        {editing ? (
          <div className="space-y-3">
            <div>
              <div className="text-[10px] font-semibold uppercase tracking-[0.18em] text-white/50">Display name</div>
              <input
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="mt-1 w-full rounded-2xl border border-white/10 bg-white/[0.03] px-4 py-3 text-sm text-white outline-none focus:border-emerald-400/40"
                placeholder="Your name"
              />
            </div>
            <div>
              <div className="text-[10px] font-semibold uppercase tracking-[0.18em] text-white/50">Bio</div>
              <textarea
                value={bio}
                onChange={(e) => setBio(e.target.value)}
                rows={4}
                className="mt-1 w-full resize-none rounded-2xl border border-white/10 bg-white/[0.03] px-4 py-3 text-sm text-white outline-none focus:border-emerald-400/40"
                placeholder="Tell the world who you are…"
              />
            </div>
            <div>
              <div className="text-[10px] font-semibold uppercase tracking-[0.18em] text-white/50">Allowed links (profile only) — max 5 lines</div>
              <textarea
                value={links}
                onChange={(e) => setLinks(e.target.value)}
                rows={5}
                className="mt-1 w-full resize-none rounded-2xl border border-white/10 bg-white/[0.03] px-4 py-3 font-mono text-xs text-white outline-none focus:border-emerald-400/40"
                placeholder="https://your-site\nhttps://twitter.com/...\n@telegram"
              />
            </div>
            <div className="grid grid-cols-2 gap-2">
              <NeonButton variant="ghost" onClick={() => setEditing(false)}>Cancel</NeonButton>
              <NeonButton onClick={save}>Save</NeonButton>
            </div>
          </div>
        ) : (
          <div>
            <div className="flex items-center justify-between">
              <div>
                <div className="text-xl font-extrabold text-white">{me.name}</div>
                <div className="mt-1 text-sm text-white/70">{me.bio || "No bio yet."}</div>
              </div>
              <div className="rounded-2xl bg-white/[0.05] px-3 py-2 text-xs font-semibold text-white/80">{me.skinName}</div>
            </div>

            <div className="mt-4">
              <div className="text-[10px] font-semibold uppercase tracking-[0.18em] text-white/50">Links (profile only)</div>
              <div className="mt-2 space-y-2">
                {me.links.length === 0 ? (
                  <div className="rounded-2xl border border-white/10 bg-white/[0.03] p-3 text-sm text-white/60">
                    Add links in Edit.
                  </div>
                ) : (
                  me.links.map((l, idx) => (
                    <a
                      key={idx}
                      href={l}
                      target="_blank"
                      rel="noreferrer"
                      className="block rounded-2xl border border-white/10 bg-white/[0.03] p-3 text-sm font-semibold text-emerald-200 hover:bg-white/[0.06]"
                    >
                      {l}
                    </a>
                  ))
                )}
              </div>
              <div className="mt-3 text-xs text-white/55">
                Links здесь разрешены. В глобальном чате — запрещены.
              </div>
            </div>
          </div>
        )}
      </NeonCard>

      <div className="pb-24" />
    </div>
  );
}

function useGameEngine({ running, onFinish }) {
  const canvasRef = useRef(null);
  const rafRef = useRef(null);
  const stateRef = useRef(null);
  const joystickRef = useRef({ active: false, dx: 0, dy: 0 });

  function reset() {
    const W = 360;
    const H = 560;
    const humans = Array.from({ length: 18 }).map((_, i) => ({
      id: `h${i}`,
      x: Math.random() * (W - 40) + 20,
      y: Math.random() * (H - 80) + 40,
      v: (Math.random() * 0.6 + 0.25) * (Math.random() < 0.5 ? -1 : 1),
      infected: false,
    }));
    stateRef.current = {
      W,
      H,
      t0: performance.now(),
      durationMs: 30_000,
      zombie: { x: W * 0.5, y: H * 0.72, r: 15, speed: 2.25 },
      humans,
      score: 0,
    };
  }

  function draw(ctx, s) {
    ctx.clearRect(0, 0, s.W, s.H);

    // background
    const g = ctx.createLinearGradient(0, 0, s.W, s.H);
    g.addColorStop(0, "rgba(16,185,129,0.08)");
    g.addColorStop(1, "rgba(34,211,238,0.05)");
    ctx.fillStyle = "rgba(0,0,0,0.65)";
    ctx.fillRect(0, 0, s.W, s.H);
    ctx.fillStyle = g;
    ctx.fillRect(0, 0, s.W, s.H);

    // scan lines
    ctx.fillStyle = "rgba(255,255,255,0.03)";
    for (let y = 0; y < s.H; y += 10) ctx.fillRect(0, y, s.W, 1);

    // humans
    s.humans.forEach((h) => {
      ctx.beginPath();
      ctx.arc(h.x, h.y, 10, 0, Math.PI * 2);
      ctx.fillStyle = h.infected ? "rgba(16,185,129,0.95)" : "rgba(255,255,255,0.65)";
      ctx.fill();
      ctx.beginPath();
      ctx.arc(h.x + 4, h.y - 3, 2, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(0,0,0,0.45)";
      ctx.fill();
    });

    // zombie
    ctx.beginPath();
    ctx.arc(s.zombie.x, s.zombie.y, s.zombie.r, 0, Math.PI * 2);
    ctx.fillStyle = "rgba(16,185,129,1)";
    ctx.shadowColor = "rgba(16,185,129,0.65)";
    ctx.shadowBlur = 16;
    ctx.fill();
    ctx.shadowBlur = 0;
    ctx.beginPath();
    ctx.arc(s.zombie.x - 5, s.zombie.y - 4, 3, 0, Math.PI * 2);
    ctx.arc(s.zombie.x + 5, s.zombie.y - 4, 3, 0, Math.PI * 2);
    ctx.fillStyle = "rgba(0,0,0,0.55)";
    ctx.fill();

    // HUD
    const t = performance.now() - s.t0;
    const left = Math.max(0, s.durationMs - t);
    ctx.fillStyle = "rgba(0,0,0,0.55)";
    ctx.fillRect(10, 10, s.W - 20, 38);
    ctx.strokeStyle = "rgba(255,255,255,0.12)";
    ctx.strokeRect(10, 10, s.W - 20, 38);
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.font = "800 14px ui-sans-serif, system-ui";
    ctx.fillText(`INFECTED: ${s.score}`, 20, 35);
    ctx.textAlign = "right";
    ctx.fillText(`TIME: ${Math.ceil(left / 1000)}s`, s.W - 20, 35);
    ctx.textAlign = "left";

    // joystick hint
    ctx.fillStyle = "rgba(255,255,255,0.55)";
    ctx.font = "700 12px ui-sans-serif, system-ui";
    ctx.fillText("Drag anywhere to move", 20, s.H - 18);
  }

  function step() {
    const c = canvasRef.current;
    if (!c) return;
    const ctx = c.getContext("2d");
    if (!ctx) return;
    const s = stateRef.current;
    if (!s) return;

    // move zombie by joystick
    const j = joystickRef.current;
    const sp = s.zombie.speed;
    s.zombie.x += j.dx * sp;
    s.zombie.y += j.dy * sp;
    s.zombie.x = clamp(s.zombie.x, 20, s.W - 20);
    s.zombie.y = clamp(s.zombie.y, 60, s.H - 30);

    // move humans
    s.humans.forEach((h) => {
      h.x += h.v;
      if (h.x < 20 || h.x > s.W - 20) h.v *= -1;
      // infect if close
      if (!h.infected) {
        const dx = h.x - s.zombie.x;
        const dy = h.y - s.zombie.y;
        if (dx * dx + dy * dy < 26 * 26) {
          h.infected = true;
          s.score += 1;
          try { navigator.vibrate?.(12); } catch {}
        }
      }
    });

    draw(ctx, s);

    const t = performance.now() - s.t0;
    if (t >= s.durationMs) {
      cancelAnimationFrame(rafRef.current);
      rafRef.current = null;
      onFinish?.(s.score);
      return;
    }

    rafRef.current = requestAnimationFrame(step);
  }

  useEffect(() => {
    const c = canvasRef.current;
    if (!c) return;
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const W = 360;
    const H = 560;
    c.style.width = "100%";
    c.style.height = "560px";
    c.width = Math.floor(W * dpr);
    c.height = Math.floor(H * dpr);
    const ctx = c.getContext("2d");
    if (ctx) ctx.scale(dpr, dpr);
  }, []);

  useEffect(() => {
    if (!running) {
      // stop loop
      if (rafRef.current) cancelAnimationFrame(rafRef.current);
      rafRef.current = null;
      return;
    }
    reset();
    rafRef.current = requestAnimationFrame(step);
    return () => {
      if (rafRef.current) cancelAnimationFrame(rafRef.current);
      rafRef.current = null;
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [running]);

  function onPointer(e) {
    const c = canvasRef.current;
    if (!c || !stateRef.current) return;
    const rect = c.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const cx = rect.width * 0.5;
    const cy = rect.height * 0.65;
    const dx = (x - cx) / 140;
    const dy = (y - cy) / 140;
    const mag = Math.hypot(dx, dy);
    const nx = mag > 1 ? dx / mag : dx;
    const ny = mag > 1 ? dy / mag : dy;
    joystickRef.current.dx = clamp(nx, -1, 1);
    joystickRef.current.dy = clamp(ny, -1, 1);
  }

  function stopPointer() {
    joystickRef.current.dx = 0;
    joystickRef.current.dy = 0;
  }

  return { canvasRef, onPointer, stopPointer };
}

function PlayScreen({ me, setMe, setToast }) {
  const [running, setRunning] = useState(false);
  const [lastScore, setLastScore] = useState(null);

  const { canvasRef, onPointer, stopPointer } = useGameEngine({
    running,
    onFinish: (score) => {
      setRunning(false);
      setLastScore(score);
      setMe((prev) => ({ ...prev, bestScore: Math.max(prev.bestScore || 0, score) }));
      setToast({ title: "Run finished", msg: `You infected ${score} humans.` });
    },
  });

  return (
    <div className="space-y-4">
      <SectionTitle kicker="Arcade" title="Infection Run" right={
        <div className="rounded-2xl border border-white/10 bg-white/[0.03] px-3 py-2 text-xs font-semibold text-white/70">
          30s
        </div>
      } />

      <NeonCard className="p-4">
        <div className="grid grid-cols-3 gap-2">
          <StatPill label="Skin" value={me.skinName} />
          <StatPill label="Best" value={formatCompact(me.bestScore || 0)} />
          <StatPill label="Last" value={formatCompact(lastScore ?? 0)} />
        </div>
      </NeonCard>

      <NeonCard className="p-4">
        <div className="text-sm text-white/70">
          Drag anywhere to move the zombie. Touch humans to infect them.
        </div>
      </NeonCard>

      <NeonCard className="p-3">
        <div className="overflow-hidden rounded-3xl border border-white/10 bg-black/30">
          <canvas
            ref={canvasRef}
            className="w-full"
            onPointerDown={(e) => {
              if (!running) return;
              onPointer(e);
            }}
            onPointerMove={(e) => {
              if (!running) return;
              onPointer(e);
            }}
            onPointerUp={stopPointer}
            onPointerCancel={stopPointer}
          />
        </div>

        <div className="mt-3 grid grid-cols-2 gap-2">
          {!running ? (
            <>
              <NeonButton onClick={() => { setLastScore(null); setRunning(true); }}>Start Run</NeonButton>
              <NeonButton variant="ghost" onClick={() => setToast({ title: "Pro tip", msg: "Fast zig-zag + corner trapping = max infections." })}>Tips</NeonButton>
            </>
          ) : (
            <>
              <NeonButton variant="danger" onClick={() => { setRunning(false); setToast({ title: "Run stopped", msg: "You aborted the run." }); }}>Abort</NeonButton>
              <NeonButton variant="ghost" onClick={() => setToast({ title: "Focus", msg: "Stay close to groups. Touch = infect." })}>Focus</NeonButton>
            </>
          )}
        </div>

        <div className="mt-3 rounded-2xl border border-white/10 bg-white/[0.03] p-3 text-xs text-white/60">
          This is a frontend-only demo. Your score can later be posted to backend and affect matchmaking/leaderboards.
        </div>
      </NeonCard>

      <div className="pb-24" />
    </div>
  );
}

function getInitialSkins() {
  return [
    {
      id: "lab",
      name: "Bio-Lab Specimen",
      tagline: "Sterile. Lethal. Clean.",
      rarity: "Rare",
      bg: "linear-gradient(135deg, rgba(16,185,129,0.35), rgba(34,211,238,0.18), rgba(0,0,0,0.2))",
    },
    {
      id: "street",
      name: "Street Walker",
      tagline: "No mercy in the alley.",
      rarity: "Common",
      bg: "linear-gradient(135deg, rgba(34,211,238,0.22), rgba(255,255,255,0.06), rgba(0,0,0,0.2))",
    },
    {
      id: "alpha",
      name: "Alpha Warlord",
      tagline: "Leader of the horde.",
      rarity: "Epic",
      bg: "linear-gradient(135deg, rgba(16,185,129,0.42), rgba(0,0,0,0.15), rgba(16,185,129,0.12))",
    },
    {
      id: "neon",
      name: "Neon Ghoul",
      tagline: "Glow in the dark.",
      rarity: "Uncommon",
      bg: "linear-gradient(135deg, rgba(34,211,238,0.25), rgba(16,185,129,0.25), rgba(0,0,0,0.2))",
    },
    {
      id: "hazmat",
      name: "HazMat Zero",
      tagline: "Containment failed.",
      rarity: "Rare",
      bg: "linear-gradient(135deg, rgba(255,255,255,0.10), rgba(16,185,129,0.25), rgba(0,0,0,0.25))",
    },
    {
      id: "king",
      name: "Horde King",
      tagline: "Crown of infection.",
      rarity: "Legendary",
      bg: "linear-gradient(135deg, rgba(16,185,129,0.55), rgba(34,211,238,0.18), rgba(255,255,255,0.06))",
    },
  ];
}

function seedLeaderboard(me) {
  // Mock global players + include me.
  const mocks = [
    { infectionId: "K9Q2X3B", name: "Marauder", infectedCount: 431, skinName: "Horde King" },
    { infectionId: "D7H8W2M", name: "Null", infectedCount: 388, skinName: "Neon Ghoul" },
    { infectionId: "R4N2P9V", name: "Biolock", infectedCount: 305, skinName: "HazMat Zero" },
    { infectionId: "Z3T6L8C", name: "Cutter", infectedCount: 192, skinName: "Street Walker" },
    { infectionId: "Q8F1S6K", name: "Echo", infectedCount: 117, skinName: "Bio-Lab Specimen" },
  ];

  // Insert me (local) if not present.
  const exists = mocks.some((p) => p.infectionId === me.infectionId);
  const mine = { infectionId: me.infectionId, name: me.name, infectedCount: me.infectedCount, skinName: me.skinName };
  return exists ? mocks.map((p) => (p.infectionId === me.infectionId ? mine : p)) : [mine, ...mocks];
}

function computeRank(leaderboard, infectionId) {
  const sorted = [...leaderboard].sort((a, b) => (b.infectedCount ?? 0) - (a.infectedCount ?? 0));
  const idx = sorted.findIndex((p) => p.infectionId === infectionId);
  return idx === -1 ? sorted.length + 1 : idx + 1;
}

export default function ViralLinkFrontend() {
  const [toast, setToast] = useState(null);

  const [me, setMe] = useLocalStorageState(LS.me, {
    infectionId: "",
    infectedBy: null,
    infectedCount: 0,
    bestScore: 0,
    name: "Player",
    bio: "",
    links: [],
    skinId: "lab",
    skinName: "Bio-Lab Specimen",
    rank: 999,
  });

  const [chat, setChat] = useLocalStorageState(LS.chat, []);
  const [leaderboard, setLeaderboard] = useLocalStorageState(LS.leaderboard, []);
  const [tab, setTab] = useState("home");
  const [modal, setModal] = useState({ claim: false, how: false });

  const skins = useMemo(() => getInitialSkins(), []);

  // First load: claim infection, handle referral
  useEffect(() => {
    // init infectionId
    if (!me.infectionId) {
      const ref = getQueryParam("ref");
      const id = randId(7);
      setMe((prev) => ({
        ...prev,
        infectionId: id,
        infectedBy: ref && ref !== id ? ref : null,
        name: prev.name && prev.name !== "Player" ? prev.name : `Player-${id.slice(0, 3)}`,
      }));
      setModal((m) => ({ ...m, claim: true }));
      return;
    }

    // if opened via ref after already claimed, show small toast
    const ref = getQueryParam("ref");
    if (ref && ref !== me.infectionId) {
      setToast({ title: "You were infected", msg: `Infected by ${ref}. Your ID: ${me.infectionId}` });
    }

    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Keep leaderboard synced with me
  useEffect(() => {
    const lb = leaderboard.length ? leaderboard : seedLeaderboard(me);
    const next = lb.map((p) =>
      p.infectionId === me.infectionId
        ? { ...p, name: me.name, infectedCount: me.infectedCount, skinName: me.skinName }
        : p
    );
    const rank = computeRank(next, me.infectionId);
    setLeaderboard(next);
    setMe((prev) => ({ ...prev, rank }));
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [me.name, me.infectedCount, me.skinName]);

  function clearToast() {
    setToast(null);
  }

  async function onShare(url) {
    try {
      if (navigator.share) {
        await navigator.share({ title: "Viral Link", text: "Join the infection.", url });
      } else {
        await navigator.clipboard.writeText(url);
        setToast({ title: "Copied", msg: "Link copied to clipboard." });
      }
    } catch {
      try {
        await navigator.clipboard.writeText(url);
        setToast({ title: "Copied", msg: "Link copied to clipboard." });
      } catch {
        setToast({ title: "Share failed", msg: "Your browser blocked sharing." });
      }
    }
  }

  // Demo-only: simulate a new infected player locally (for UI testing)
  function debugSimulateInfect() {
    setMe((prev) => ({ ...prev, infectedCount: (prev.infectedCount || 0) + 1 }));
    setToast({ title: "Simulated infection", msg: "+1 infected (demo)" });
  }

  const content = (
    <AnimatePresence mode="wait">
      <motion.div
        key={tab}
        initial={{ opacity: 0, y: 8 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, y: 8 }}
        transition={{ duration: 0.18 }}
      >
        {tab === "home" ? (
          <HomeScreen me={me} leaderboard={leaderboard} setTab={setTab} onShare={onShare} />
        ) : tab === "leaderboard" ? (
          <LeaderboardScreen leaderboard={leaderboard} me={me} setTab={setTab} />
        ) : tab === "play" ? (
          <PlayScreen me={me} setMe={setMe} setToast={setToast} />
        ) : tab === "skins" ? (
          <SkinsScreen skins={skins} me={me} setMe={setMe} setToast={setToast} />
        ) : tab === "chat" ? (
          <ChatScreen me={me} chat={chat} setChat={setChat} setToast={setToast} />
        ) : (
          <ProfileScreen me={me} setMe={setMe} setToast={setToast} />
        )}
      </motion.div>
    </AnimatePresence>
  );

  return (
    <div className="min-h-screen bg-[#070A0D] text-white">
      <div className="mx-auto max-w-md px-4 pb-28 pt-6">
        <div className="relative">
          <GlowBg />

          <div className="relative">
            <div className="mb-4 flex items-center justify-between">
              <div>
                <div className="text-[11px] font-semibold uppercase tracking-[0.22em] text-white/55">
                  Viral Link
                </div>
                <div className="mt-1 text-2xl font-extrabold">
                  <span className="text-emerald-300">INFECTION</span>
                  <span className="text-white/90">/</span>
                  <span className="text-cyan-200">MODE</span>
                </div>
              </div>
              <button
                onClick={() => setModal((m) => ({ ...m, how: true }))}
                className="rounded-2xl border border-white/10 bg-white/[0.03] px-3 py-2 text-xs font-semibold text-white/70 hover:bg-white/[0.06]"
              >
                How it works
              </button>
            </div>

            {content}
          </div>
        </div>

        <Toast toast={toast} clear={clearToast} />

        <Modal
          open={modal.claim}
          title="You are infected"
          onClose={() => setModal((m) => ({ ...m, claim: false }))}
        >
          <div className="space-y-3">
            <div className="rounded-2xl border border-white/10 bg-white/[0.03] p-3 text-sm text-white/80">
              Your Infection ID was created:
              <div className="mt-2 font-mono text-xl font-extrabold tracking-widest text-emerald-300">{me.infectionId || "…"}</div>
              {me.infectedBy ? (
                <div className="mt-2 text-xs text-white/65">Infected by: <span className="font-mono text-emerald-200">{me.infectedBy}</span></div>
              ) : (
                <div className="mt-2 text-xs text-white/65">Origin: you (no ref detected)</div>
              )}
            </div>
            <NeonButton onClick={() => setModal((m) => ({ ...m, claim: false }))}>Enter Hub</NeonButton>
            <NeonButton variant="ghost" onClick={() => { setModal((m) => ({ ...m, claim: false })); setTab("play"); }}>Play first</NeonButton>
          </div>
        </Modal>

        <Modal
          open={modal.how}
          title="Referral = Virus"
          onClose={() => setModal((m) => ({ ...m, how: false }))}
        >
          <div className="space-y-3 text-sm text-white/80">
            <div className="rounded-2xl border border-white/10 bg-white/[0.03] p-3">
              <div className="font-extrabold text-white">Core loop</div>
              <ol className="mt-2 list-decimal pl-5 space-y-1">
                <li>Player opens the game via someone’s link: <span className="font-mono">?ref=ID</span></li>
                <li>New player gets their own Infection ID</li>
                <li>Backend (later) credits the referrer with +1 infected</li>
                <li>Leaderboard ranks who infected the most</li>
              </ol>
            </div>
            <div className="rounded-2xl border border-white/10 bg-white/[0.03] p-3">
              <div className="font-extrabold text-white">Chat rule</div>
              <div className="mt-1">Global chat blocks links & file sharing. Text + voice only.</div>
            </div>
            <div className="grid grid-cols-2 gap-2">
              <NeonButton variant="ghost" onClick={debugSimulateInfect}>Demo: +1 infected</NeonButton>
              <NeonButton onClick={() => setModal((m) => ({ ...m, how: false }))}>Got it</NeonButton>
            </div>
            <div className="text-xs text-white/55">
              Note: This is frontend-only. For real global infection counts, connect endpoints: claimID, postInfection(ref), getLeaderboard, postChat, postVoice.
            </div>
          </div>
        </Modal>

        <BottomNav tab={tab} setTab={(k) => {
          if (k === "leaderboard") setTab("leaderboard");
          else setTab(k);
        }} />

        {/* Hidden route mapping: keep a tab for leaderboard */}
        <div className="hidden" aria-hidden>
          <button onClick={() => setTab("leaderboard")}>lb</button>
        </div>
      </div>
    </div>
  );
}
