<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#07090c" />
  <title>Viral Link ‚Äî Infect & Rise</title>

  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    :root{
      --bg:#07090c;
      --bg2:#05070a;
      --panel: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --bio: #20ff9a;
      --cyan:#31d7ff;
      --pink:#ff2f6d;
      --gold:#ffd56a;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 12px 28px rgba(0,0,0,.35);
      --r: 22px;
      --r2: 28px;

      --pad: 14px;
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    body{ overflow:hidden; -webkit-tap-highlight-color: transparent; user-select:none; }
    button,input,textarea{ font-family:inherit; }
    a{ color:inherit; }

    /* ============ MOBILE ONLY LOCK ============ */
    @media (min-width: 900px) and (min-height: 600px){
      body:before{
        content:"Viral Link ‚Äî mobile only (vertical). Open on phone.";
        position:fixed; inset:0; z-index:99999;
        display:grid; place-items:center;
        background:linear-gradient(180deg,#05070a,#07090c);
        color:rgba(255,255,255,.82);
        font-weight:950;
        letter-spacing:.4px;
        padding:28px;
        text-align:center;
      }
    }

    /* ============ BACKGROUND ============ */
    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1100px 700px at 50% 0%, rgba(32,255,154,.14), transparent 55%),
        radial-gradient(900px 700px at 12% 52%, rgba(49,215,255,.12), transparent 55%),
        radial-gradient(1000px 700px at 88% 64%, rgba(255,47,109,.10), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg) 35%, var(--bg2));
    }
    .noise{
      position:absolute; inset:0; opacity:.06; mix-blend-mode:overlay; pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.30'/%3E%3C/svg%3E");
    }

    /* ============ APP SHELL ============ */
    .app{
      position:fixed; inset:0;
      display:flex; flex-direction:column; gap:10px;
      padding-top:calc(10px + var(--safeTop));
      padding-bottom:calc(10px + var(--safeBottom));
    }

    .topbar{
      padding:0 var(--pad);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      z-index:3;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .sigil{
      width:40px; height:40px; border-radius:15px;
      border:1px solid rgba(255,255,255,.16);
      box-shadow: var(--shadow2);
      position:relative; overflow:hidden;
      background:
        radial-gradient(circle at 30% 30%, rgba(32,255,154,.85), rgba(32,255,154,0) 60%),
        radial-gradient(circle at 70% 60%, rgba(49,215,255,.65), rgba(49,215,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.02));
    }
    .sigil:after{
      content:"";
      position:absolute; inset:-70%;
      background:conic-gradient(from 220deg, rgba(32,255,154,0), rgba(32,255,154,.25), rgba(49,215,255,0), rgba(255,47,109,.18), rgba(32,255,154,0));
      filter:blur(10px);
      animation:spin 6.4s linear infinite;
      opacity:.95;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    .t{ display:flex; flex-direction:column; line-height:1.05; }
    .title{ font-weight:950; letter-spacing:.8px; font-size:14px; }
    .sub{ font-size:11px; color:var(--muted); }

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:9px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
    }
    .dot{
      width:10px;height:10px;border-radius:99px;
      background:radial-gradient(circle at 30% 30%, rgba(32,255,154,1), rgba(32,255,154,.25));
      box-shadow:0 0 18px rgba(32,255,154,.35);
    }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; letter-spacing:.6px; }

    .panel{
      margin:0 var(--pad);
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      flex:1;
      position:relative;
      z-index:2;
    }

    /* ============ TABS ============ */
    .tabs{
      padding:10px var(--pad);
      display:flex; gap:10px;
      z-index:3;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{ display:none; }
    .tab{
      flex:0 0 auto;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.72);
      font-weight:950;
      text-align:center;
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
      transition: transform .12s ease, background .12s ease, color .12s ease;
      min-width:84px;
    }
    .tab.active{
      color: rgba(0,0,0,.88);
      background: linear-gradient(90deg, rgba(32,255,154,.95), rgba(49,215,255,.95));
      box-shadow: 0 14px 34px rgba(0,0,0,.35), 0 0 30px rgba(32,255,154,.14);
      border-color: rgba(255,255,255,.14);
    }
    .tab:active{ transform:scale(.99); }

    /* ============ SCREENS ============ */
    .screen{ height:100%; display:none; flex-direction:column; }
    .screen.active{ display:flex; }

    .content{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      height:100%;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    /* ============ HERO CARD ============ */
    .hero{
      padding:16px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(700px 260px at 20% 10%, rgba(32,255,154,.18), transparent 60%),
        radial-gradient(700px 260px at 80% 30%, rgba(49,215,255,.12), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .hero:after{
      content:"";
      position:absolute; inset:-80%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform:rotate(22deg) translateX(-40%);
      animation:shine 2.6s ease-in-out infinite;
      opacity:.7;
      pointer-events:none;
    }
    @keyframes shine{
      0%{ transform:rotate(22deg) translateX(-65%); opacity:0 }
      18%{ opacity:.55 }
      55%{ opacity:.35 }
      100%{ transform:rotate(22deg) translateX(65%); opacity:0 }
    }
    .hero h1{ margin:0 0 6px; font-size:18px; letter-spacing:.2px; }
    .hero p{ margin:0; color:rgba(255,255,255,.74); font-size:12.5px; line-height:1.35; }
    .glowline{
      height:1px; margin:12px 0;
      background:linear-gradient(90deg, transparent, rgba(32,255,154,.65), rgba(49,215,255,.55), rgba(255,47,109,.30), transparent);
      opacity:.9;
    }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      font-size:12px;
    }
    .chip b{ color:rgba(255,255,255,.96); }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .stat{
      border-radius:20px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
    }
    .stat .k{ font-size:11px; color:rgba(255,255,255,.65); }
    .stat .v{ margin-top:3px; font-size:18px; font-weight:950; }

    /* ============ AAA BUTTONS ============ */
    .btn{
      border:none; outline:none;
      width:100%;
      padding:14px 14px;
      border-radius:18px;
      font-weight:950;
      letter-spacing:.2px;
      color:rgba(0,0,0,.92);
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(140% 140% at 20% 20%, rgba(255,255,255,.55), rgba(255,255,255,0) 38%),
        linear-gradient(90deg, rgba(32,255,154,1), rgba(49,215,255,1));
      box-shadow:
        0 16px 40px rgba(0,0,0,.45),
        0 0 0 1px rgba(255,255,255,.20) inset,
        0 0 40px rgba(32,255,154,.18);
      transform: translateZ(0);
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:active{ transform:scale(.985); filter:brightness(.98); }
    .btn.secondary{
      color:rgba(255,255,255,.92);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
    }
    .btn.danger{
      color:rgba(255,255,255,.92);
      background: linear-gradient(90deg, rgba(255,47,109,1), rgba(255,144,99,1));
      box-shadow:
        0 16px 40px rgba(0,0,0,.45),
        0 0 0 1px rgba(255,255,255,.16) inset,
        0 0 40px rgba(255,47,109,.18);
    }
    .btn .shine{
      position:absolute; inset:-70%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
      transform: rotate(25deg) translateX(-40%);
      animation: btnshine 2.4s ease-in-out infinite;
      opacity:.75;
      pointer-events:none;
    }
    @keyframes btnshine{
      0%{ transform: rotate(25deg) translateX(-70%); opacity:0 }
      20%{ opacity:.55 }
      60%{ opacity:.35 }
      100%{ transform: rotate(25deg) translateX(70%); opacity:0 }
    }

    /* ============ FIELDS ============ */
    .field{
      display:flex; flex-direction:column; gap:8px;
      padding:12px;
      border-radius:20px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 10px 24px rgba(0,0,0,.22);
    }
    .field label{ font-size:11px; color:rgba(255,255,255,.68); }
    .field input,.field textarea{
      width:100%;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(255,255,255,.92);
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      outline:none;
      resize:none;
    }
    .field textarea{ min-height:72px; line-height:1.25; }

    .tiny{ font-size:11px; color:rgba(255,255,255,.62); }
    .muted{ color:rgba(255,255,255,.66); }

    /* ============ CHAT ============ */
    .chatBox{ display:flex; flex-direction:column; gap:10px; height: calc(100vh - 260px); min-height: 320px; }
    .chatList{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding-right:2px;
    }
    .msg{
      align-self:flex-start;
      max-width:88%;
      padding:10px 12px;
      border-radius:16px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 10px 20px rgba(0,0,0,.18);
    }
    .msg.mine{
      align-self:flex-end;
      background:rgba(32,255,154,.10);
      border-color:rgba(32,255,154,.18);
    }
    .msg .h{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:4px; }
    .msg .h b{ font-size:11px; }
    .msg .h span{ font-size:10px; color:rgba(255,255,255,.60); }
    .msg p{ margin:0; font-size:12.5px; color:rgba(255,255,255,.88); line-height:1.3; word-break:break-word; }
    .msg audio{ width:100%; margin-top:6px; }

    .chatInput{
      display:flex; gap:10px; align-items:center;
      padding:10px;
      border-radius:18px;
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 12px 26px rgba(0,0,0,.24);
    }
    .chatInput input{
      flex:1; background:transparent; border:none; outline:none;
      color:rgba(255,255,255,.92);
      font-size:13px;
    }
    .iconBtn{
      width:44px; height:44px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      display:grid; place-items:center;
      box-shadow:0 10px 22px rgba(0,0,0,.20);
      position:relative;
    }
    .icon{ width:18px; height:18px; opacity:.9; fill:none; stroke:rgba(255,255,255,.90); stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
    .recDot{
      position:absolute; top:10px; left:10px;
      width:10px;height:10px;border-radius:99px;
      background:rgba(255,47,109,1);
      box-shadow:0 0 18px rgba(255,47,109,.55);
      display:none;
    }

    /* ============ GAME CANVAS WRAP ============ */
    .gameWrap{
      position:relative;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      box-shadow: 0 20px 60px rgba(0,0,0,.40);
      overflow:hidden;
      height: 52vh;
      min-height: 320px;
    }
    canvas{ display:block; width:100%; height:100%; }

    .hudRow{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .hudBox{
      flex:1;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
      display:flex; align-items:center; justify-content:space-between;
      font-size:12px;
    }

    .joy{
      position:absolute;
      left:14px; bottom:14px;
      width:140px; height:140px;
      border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      touch-action:none;
    }
    .joy:before{
      content:"";
      position:absolute; inset:16px;
      border-radius:999px;
      border:1px dashed rgba(255,255,255,.10);
      opacity:.7;
    }
    .knob{
      position:absolute;
      left:50%; top:50%;
      width:56px; height:56px;
      transform:translate(-50%,-50%);
      border-radius:18px;
      background:
        radial-gradient(120% 120% at 20% 20%, rgba(255,255,255,.18), rgba(255,255,255,0) 45%),
        linear-gradient(90deg, rgba(32,255,154,.85), rgba(49,215,255,.85));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 16px 40px rgba(0,0,0,.45), 0 0 30px rgba(32,255,154,.15);
    }

    .dash{
      position:absolute;
      right:14px; bottom:16px;
      width:92px; height:92px;
      border-radius:26px;
      background:
        radial-gradient(140% 140% at 20% 20%, rgba(255,255,255,.16), rgba(255,255,255,0) 45%),
        linear-gradient(90deg, rgba(255,47,109,.95), rgba(255,144,99,.90));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 20px 60px rgba(0,0,0,.45), 0 0 34px rgba(255,47,109,.16);
      display:grid; place-items:center;
      font-weight:950;
      letter-spacing:.6px;
      color:rgba(255,255,255,.92);
      touch-action:none;
      transform: translateZ(0);
    }
    .dash:active{ transform:scale(.985); }

    /* ============ TOAST ============ */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:calc(86px + var(--safeBottom));
      z-index:9999;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      color: rgba(255,255,255,.88);
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      max-width:92vw;
      text-align:center;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

    /* ============ INTRO (AAA) ============ */
    .intro{
      position:fixed; inset:0; z-index:9998;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg,#05070a,#07090c);
      overflow:hidden;
    }
    .introVideo{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover;
      opacity:0;
      transition:opacity .35s ease;
      filter:contrast(1.05) saturate(1.05);
    }
    .introOn .introVideo{ opacity:1; }

    .intro:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 600px at 50% 10%, rgba(32,255,154,.16), transparent 60%),
        radial-gradient(900px 700px at 10% 60%, rgba(49,215,255,.12), transparent 60%),
        radial-gradient(900px 700px at 90% 70%, rgba(255,47,109,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.92), rgba(0,0,0,.18), rgba(0,0,0,.92));
      pointer-events:none;
    }
    .scan{
      position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(255,255,255,.04), rgba(255,255,255,0) 35%, rgba(255,255,255,.03));
      background-size: 100% 8px;
      opacity:.22;
      mix-blend-mode: overlay;
      pointer-events:none;
      animation:scan 1.2s linear infinite;
    }
    @keyframes scan{ to{ background-position:0 8px; } }

    .introCard{
      position:relative;
      width:min(560px,92vw);
      border-radius:26px;
      padding:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .introCard:after{
      content:"";
      position:absolute; inset:-100%;
      background: conic-gradient(from 180deg, rgba(32,255,154,0), rgba(32,255,154,.18), rgba(49,215,255,0), rgba(255,47,109,.12), rgba(32,255,154,0));
      filter: blur(14px);
      animation:spin 8s linear infinite;
      opacity:.9;
      pointer-events:none;
    }
    .introCard h2{ position:relative; margin:0 0 6px; font-size:18px; letter-spacing:1.2px; font-weight:950; }
    .introCard p{ position:relative; margin:0; color:rgba(255,255,255,.72); font-size:12.5px; line-height:1.35; }
    .kbd{
      position:relative; display:inline-flex; gap:6px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.28)
    }
    .bar{
      position:relative;
      height:8px; border-radius:999px;
      background:rgba(255,255,255,.10);
      margin-top:12px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .bar > i{
      display:block; height:100%; width:0%;
      background:linear-gradient(90deg,var(--bio),var(--cyan));
      box-shadow:0 0 30px rgba(32,255,154,.25);
    }
    .fadeOut{ animation:fadeOut .25s ease forwards; }
    @keyframes fadeOut{ to{ opacity:0; transform:scale(1.01); } }

    /* Small helpers */
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .hr{
      height:1px;
      background: rgba(255,255,255,.10);
      margin:8px 0;
    }

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce){
      .sigil:after, .hero:after, .scan, .btn .shine{ animation:none !important; }
    }
  </style>
</head>

<body>
  <div class="bg"><div class="noise"></div></div>

  <!-- INTRO -->
  <div class="intro" id="intro">
    <video class="introVideo" id="introVid" autoplay muted playsinline webkit-playsinline>
      <source src="assets/intro.webm" type="video/webm">
      <source src="assets/intro.mp4" type="video/mp4">
    </video>
    <div class="scan"></div>

    <div class="introCard">
      <h2>VIRAL LINK</h2>
      <p>
        –≠—Ç–æ ‚Äú–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –≤–∏—Ä—É—Å‚Äù. –¢–≤–æ—è —Å–∏–ª–∞ ‚Äî <b>—Å—Å—ã–ª–∫–∞</b>. <br>
        –õ—é–±–æ–π, –∫—Ç–æ –æ—Ç–∫—Ä—ã–ª –∏–≥—Ä—É –ø–æ <span class="kbd mono">?ref=–¢–í–û–ô_ID</span>,
        —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ç–≤–æ–π <b>INFECTED</b>.
      </p>
      <div class="bar"><i id="introBar"></i></div>
      <div class="grid2" style="position:relative;margin-top:12px">
        <button class="btn" id="introStart">
          TAP TO START <span class="shine" aria-hidden="true"></span>
        </button>
        <button class="btn secondary" id="introSkip">SKIP</button>
      </div>
      <div class="tiny" style="position:relative;margin-top:8px">
        –ó–≤—É–∫ –≤–∫–ª—é—á–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è. –ò–Ω—Ç—Ä–æ-–≤–∏–¥–µ–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç ‚Äî –±—É–¥–µ—Ç –∫–∏–Ω–µ–º–∞—Ç–∏–∫ —ç—Ñ—Ñ–µ–∫—Ç.
      </div>
    </div>
  </div>

  <div class="app" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="sigil" aria-hidden="true"></div>
        <div class="t">
          <div class="title">VIRAL LINK</div>
          <div class="sub">Infect ‚Ä¢ Rise ‚Ä¢ Rule</div>
        </div>
      </div>

      <div class="pill" title="Your Infection ID">
        <div class="dot"></div>
        <div style="font-size:11px;color:var(--muted)">ID</div>
        <div class="mono" id="myId">‚Äî</div>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-go="home">Home</div>
      <div class="tab" data-go="play">Play</div>
      <div class="tab" data-go="skins">Skins</div>
      <div class="tab" data-go="rank">Rank</div>
      <div class="tab" data-go="chat">Chat</div>
      <div class="tab" data-go="profile">Profile</div>
    </div>

    <div class="panel">
      <!-- HOME -->
      <div class="screen active" id="screen-home">
        <div class="content">
          <div class="hero">
            <h1>–¢–≤–æ—è —Å—Å—ã–ª–∫–∞ ‚Äî –≤–∏—Ä—É—Å.</h1>
            <p>
              –°—É—Ç—å –ø—Ä–æ—Å—Ç–∞—è: <b>Copy Link ‚Üí Share ‚Üí Infect</b>. <br>
              –í –∏–≥—Ä–µ —Ç—ã –º–æ–∂–µ—à—å –ø–æ–≤—ã—à–∞—Ç—å —Å–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —á–µ—Ä–µ–∑ <b>Run Bonus</b>.
            </p>
            <div class="glowline"></div>
            <div class="chips">
              <span class="chip"><span class="mono">REF</span><b id="refLabel">‚Äî</b></span>
              <span class="chip"><span class="mono">INFECTED</span><b id="infectedCount">0</b></span>
              <span class="chip"><span class="mono">FROM</span><b class="mono" id="infectedBy">‚Äî</b></span>
              <span class="chip"><span class="mono">MODE</span><b id="modeLabel">DEMO</b></span>
            </div>
          </div>

          <div class="grid2">
            <div class="stat">
              <div class="k">–¢–≤–æ–π –Ω–∏–∫</div>
              <div class="v" id="nickStat">PatientZero</div>
            </div>
            <div class="stat">
              <div class="k">–õ—É—á—à–∏–π –∑–∞–±–µ–≥</div>
              <div class="v"><span class="mono" id="bestRun">0</span></div>
            </div>
          </div>

          <button class="btn" id="btnGoPlay">
            PLAY ‚Ä¢ INFECT <span class="shine" aria-hidden="true"></span>
          </button>

          <div class="grid2">
            <button class="btn secondary" id="btnCopyLink">COPY VIRUS LINK</button>
            <button class="btn secondary" id="btnShare">SHARE</button>
          </div>

          <div class="field">
            <label>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</label>
            <div class="tiny">
              1) –¢—ã –ø–æ–ª—É—á–∞–µ—à—å ID. <br>
              2) –£ —Ç–µ–±—è –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞: <span class="mono" id="homeRefInline">‚Äî</span> <br>
              3) –õ—é–±–æ–π, –∫—Ç–æ –æ—Ç–∫—Ä—ã–ª –ø–æ –Ω–µ–π —Å–∞–π—Ç, ‚Äú–∑–∞—Ä–∞–∂–∞–µ—Ç—Å—è‚Äù –∏ –ø–æ–≤—ã—à–∞–µ—Ç —Ç–≤–æ–π INFECTED. <br>
              <span class="muted">–í DEMO (–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞) —Å—á—ë—Ç—á–∏–∫–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ. –ü–æ–¥ —Å–µ—Ä–≤–µ—Ä ‚Äî —Å—Ç–∞–Ω–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ.</span>
            </div>
          </div>

          <button class="btn danger" id="btnReset">RESET DEMO (LOCAL)</button>
        </div>
      </div>

      <!-- PLAY -->
      <div class="screen" id="screen-play">
        <div class="content">
          <div class="hero">
            <h1>Infect the City</h1>
            <p>
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ª–µ–≤—ã–π —Å—Ç–∏–∫ ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ. –°–ø—Ä–∞–≤–∞ ‚Äî <b>DASH</b>. <br>
              –ö–∞—Å–∞–π—Å—è –ª—é–¥–µ–π ‚Üí –æ–Ω–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Ç–≤–æ–µ–π –æ—Ä–¥–æ–π –∏ –∑–∞—Ä–∞–∂–∞—é—Ç –¥—Ä—É–≥–∏—Ö.
            </p>
            <div class="glowline"></div>
            <div class="chips">
              <span class="chip"><span class="mono">SCORE</span><b id="hudScore">0</b></span>
              <span class="chip"><span class="mono">COMBO</span><b id="hudCombo">x1</b></span>
              <span class="chip"><span class="mono">STREAK</span><b id="hudStreak">0</b></span>
              <span class="chip"><span class="mono">TIME</span><b id="hudTime">60</b></span>
              <span class="chip"><span class="mono">BONUS</span><b id="hudBonus">+0</b></span>
            </div>
          </div>

          <div class="gameWrap" id="gameWrap">
            <canvas id="glow"></canvas>
            <canvas id="game"></canvas>

            <div class="joy" id="joy"><div class="knob" id="knob"></div></div>
            <div class="dash" id="dash">DASH</div>
          </div>

          <div class="grid2">
            <button class="btn secondary" id="btnRestart">RESTART</button>
            <button class="btn" id="btnShareRun">SHARE RUN <span class="shine" aria-hidden="true"></span></button>
          </div>

          <div class="tiny muted">–°—É–ø–µ—Ä –ø–ª–∞–≤–Ω–æ, –±–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫. –í—Å—ë –Ω–∞ Canvas. –°–∫–∏–Ω –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–∏–∑—É–∞–ª –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã.</div>
        </div>
      </div>

      <!-- SKINS -->
      <div class="screen" id="screen-skins">
        <div class="content">
          <div class="hero">
            <h1>–°–∫–∏–Ω—ã</h1>
            <p>–ú–µ–Ω—è—é—Ç —Å—Ç–∏–ª—å: –∞—É—Ä–∞, –≥–ª–∞–∑–∞, –∫–æ—Ä–æ–Ω–∞/–º–∞—Å–∫–∞, —á–∞—Å—Ç–∏—Ü—ã, —Å–ª–µ–¥.</p>
            <div class="glowline"></div>
            <div class="chips">
              <span class="chip"><span class="mono">SELECTED</span><b id="skinSelected">classic</b></span>
              <span class="chip"><span class="mono">RARITY</span><b id="skinRarity">COMMON</b></span>
            </div>
          </div>

          <div class="grid2" id="skinGrid"></div>
          <button class="btn" id="btnSaveSkin">SAVE SKIN <span class="shine" aria-hidden="true"></span></button>
        </div>
      </div>

      <!-- RANK -->
      <div class="screen" id="screen-rank">
        <div class="content">
          <div class="hero">
            <h1>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</h1>
            <p>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ INFECTED. DEMO = –ª–æ–∫–∞–ª—å–Ω–æ. –ü–æ–¥ —Å–µ—Ä–≤–µ—Ä —Å—Ç–∞–Ω–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ.</p>
            <div class="glowline"></div>
            <div class="chips">
              <span class="chip"><span class="mono">YOU</span><b id="youRank">‚Äî</b></span>
              <span class="chip"><span class="mono">TOTAL</span><b id="totalPlayers">‚Äî</b></span>
            </div>
          </div>

          <div class="field" id="rankList" style="gap:10px"></div>

          <div class="grid2">
            <button class="btn secondary" id="btnSeed">SEED DEMO PLAYERS</button>
            <button class="btn secondary" id="btnCopyLink2">COPY LINK</button>
          </div>
        </div>
      </div>

      <!-- CHAT -->
      <div class="screen" id="screen-chat">
        <div class="content">
          <div class="hero">
            <h1>Global Chat</h1>
            <p><b>–°—Å—ã–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã</b>. –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç + –≥–æ–ª–æ—Å–æ–≤—ã–µ. URL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Ä–µ–∂–µ—Ç—Å—è.</p>
            <div class="glowline"></div>
            <div class="chips">
              <span class="chip"><span class="mono">MODE</span><b>TEXT+VOICE</b></span>
              <span class="chip"><span class="mono">FILTER</span><b>NO URL</b></span>
            </div>
          </div>

          <div class="chatBox">
            <div class="chatList" id="chatList"></div>

            <div class="chatInput">
              <input id="chatText" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å—Å—ã–ª–∫–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã)" maxlength="220" />
              <button class="iconBtn" id="btnRec" title="Voice" aria-label="Voice">
                <span class="recDot" id="recDot"></span>
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3Z"></path>
                  <path d="M19 11a7 7 0 0 1-14 0"></path>
                  <path d="M12 18v3"></path>
                </svg>
              </button>
              <button class="iconBtn" id="btnSend" title="Send" aria-label="Send">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M22 2 11 13"></path>
                  <path d="M22 2 15 22 11 13 2 9 22 2Z"></path>
                </svg>
              </button>
            </div>

            <div class="tiny muted" id="voiceHint">–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–¥–µ–º–æ). –í –ø—Ä–æ–¥–µ ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.</div>
          </div>
        </div>
      </div>

      <!-- PROFILE -->
      <div class="screen" id="screen-profile">
        <div class="content">
          <div class="hero">
            <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
            <p>–¢—É—Ç –º–æ–∂–Ω–æ bio + —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏. –í —á–∞—Ç–µ ‚Äî –Ω–µ–ª—å–∑—è.</p>
            <div class="glowline"></div>
            <div class="chips">
              <span class="chip"><span class="mono">ID</span><b class="mono" id="profileId">‚Äî</b></span>
              <span class="chip"><span class="mono">SKIN</span><b id="profileSkin">‚Äî</b></span>
            </div>
          </div>

          <div class="field">
            <label>–ù–∏–∫ (–¥–æ 16)</label>
            <input id="nickInput" maxlength="16" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: PatientZero" />
          </div>

          <div class="field">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ (bio)</label>
            <textarea id="bioInput" maxlength="220" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ —Å–µ–±–µ..."></textarea>
          </div>

          <div class="field">
            <label>–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (–¥–æ 3) ‚Äî —Ç–æ–ª—å–∫–æ —Ç—É—Ç</label>
            <input id="link1" placeholder="https://..." />
            <input id="link2" placeholder="https://..." />
            <input id="link3" placeholder="https://..." />
            <div class="tiny muted">–†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ http/https. –û—Å—Ç–∞–ª—å–Ω–æ–µ —Ä–µ–∂–µ—Ç—Å—è.</div>
          </div>

          <button class="btn" id="btnSaveProfile">SAVE PROFILE <span class="shine" aria-hidden="true"></span></button>

          <div class="stat">
            <div class="k">–¢–≤–æ—è –≤–∏—Ä—É—Å-—Å—Å—ã–ª–∫–∞</div>
            <div class="v"><span class="mono" id="profileRef">‚Äî</span></div>
          </div>

          <button class="btn secondary" id="btnCopyProfileRef">COPY LINK</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script>
  /* ============================================================
     VIRAL LINK ‚Äî Ultra Frontend (no libs)
     - Mobile-only vertical
     - AAA intro + optional assets/intro.mp4|webm
     - Referral virus link (?ref=ID)
     - Real 2D infection game on Canvas (top-down)
     - Skins with real visual differences
     - Profile + allowed links (only in profile)
     - Chat: text + voice, no links
     - Local-first demo storage + API layer placeholder
     - PWA: registers sw.js if available
     ============================================================ */

  // ---------- Utils ----------
  const $ = (id)=>document.getElementById(id);
  const qa = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const lerp=(a,b,t)=>a+(b-a)*t;
  const nowTime=()=>new Date().toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
  const escapeHtml=(s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  const urlRe=/https?:\/\/[^\s]+|www\.[^\s]+|\b[\w.-]+\.[a-z]{2,}\b/ig;
  const stripUrls=(t)=>String(t||"").replace(urlRe,"[no-link]");
  const rand=(a=1,b=0)=>Math.random()*(a-b)+b;
  const randi=(a,b=0)=>Math.floor(rand(a,b));
  const hypot=Math.hypot;

  const toast=(msg,ms=1600)=>{
    const t=$("toast");
    t.textContent=msg;
    t.classList.add("show");
    clearTimeout(toast._t);
    toast._t=setTimeout(()=>t.classList.remove("show"), ms);
  };

  // ---------- Micro SFX (procedural) ----------
  const SFX = (() => {
    let ctx=null;
    const ensure=()=>ctx || (ctx=new (window.AudioContext||window.webkitAudioContext)());
    const ping=(f=220,ms=35,type="sine",gain=0.045)=>{
      try{
        const c=ensure();
        const o=c.createOscillator();
        const g=c.createGain();
        o.type=type;
        o.frequency.value=f;
        g.gain.value=gain;
        o.connect(g); g.connect(c.destination);
        o.start();
        setTimeout(()=>o.stop(), ms);
      }catch(e){}
    };
    return {
      unlock(){ try{ ensure(); }catch(e){} },
      tap(){ navigator.vibrate?.(10); ping(240,22,"sine",0.03); },
      success(){ navigator.vibrate?.([18,10,18]); ping(420,40,"triangle",0.05); },
      danger(){ navigator.vibrate?.([25,12,25]); ping(140,70,"sawtooth",0.04); }
    };
  })();

  // ---------- Storage + Schema ----------
  const STORE_KEY="viral_link_ultra_v2";
  const SCHEMA=2;

  const genId=()=>{
    const a="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out="";
    for(let i=0;i<8;i++) out+=a[(Math.random()*a.length)|0];
    return out;
  };

  const defaultState=()=>({
    schema: SCHEMA,
    me:{
      id: genId(),
      nick: "PatientZero",
      skin: "classic",
      bio: "",
      links: [],
      infectedBy: null,
      bestRun: 0,
      createdAt: Date.now()
    },
    players:{
      // id -> {id,nick,skin,infected,createdAt,lastSeen}
    },
    chat:[
      // {id,fromId,fromNick,t,text?,audioDataUrl?}
    ],
    meta:{
      lastPlayedAt: 0,
      totalRuns: 0,
      totalScore: 0
    }
  });

  function loadState(){
    try{
      const raw=localStorage.getItem(STORE_KEY);
      if(!raw){
        const s=defaultState();
        s.players[s.me.id]={id:s.me.id,nick:s.me.nick,skin:s.me.skin,infected:0,createdAt:Date.now(),lastSeen:Date.now()};
        localStorage.setItem(STORE_KEY, JSON.stringify(s));
        return s;
      }
      const s=JSON.parse(raw);

      // migrate if needed
      if(!s.schema || s.schema<SCHEMA){
        const merged=defaultState();
        // shallow merge safe parts
        Object.assign(merged.me, s.me||{});
        merged.players = s.players || merged.players;
        merged.chat = s.chat || merged.chat;
        merged.meta = Object.assign(merged.meta, s.meta||{});
        merged.schema=SCHEMA;
        // ensure me in players
        merged.players[merged.me.id] = merged.players[merged.me.id] || {id:merged.me.id,nick:merged.me.nick,skin:merged.me.skin,infected:0,createdAt:Date.now(),lastSeen:Date.now()};
        localStorage.setItem(STORE_KEY, JSON.stringify(merged));
        return merged;
      }

      // sanity
      s.players=s.players||{};
      s.chat=s.chat||[];
      s.meta=s.meta||{lastPlayedAt:0,totalRuns:0,totalScore:0};
      if(!s.me?.id) throw new Error("bad state");
      if(!s.players[s.me.id]){
        s.players[s.me.id]={id:s.me.id,nick:s.me.nick,skin:s.me.skin,infected:0,createdAt:Date.now(),lastSeen:Date.now()};
      }
      return s;
    }catch(e){
      const s=defaultState();
      s.players[s.me.id]={id:s.me.id,nick:s.me.nick,skin:s.me.skin,infected:0,createdAt:Date.now(),lastSeen:Date.now()};
      localStorage.setItem(STORE_KEY, JSON.stringify(s));
      return s;
    }
  }

  function saveState(){
    state.players[state.me.id] = state.players[state.me.id] || {id:state.me.id,nick:state.me.nick,skin:state.me.skin,infected:0,createdAt:Date.now(),lastSeen:Date.now()};
    state.players[state.me.id].nick = state.me.nick;
    state.players[state.me.id].skin = state.me.skin;
    state.players[state.me.id].lastSeen = Date.now();
    localStorage.setItem(STORE_KEY, JSON.stringify(state));
  }

  let state = loadState();

  // ---------- API layer (placeholder) ----------
  // If you later add backend endpoints, switch DEMO -> LIVE here:
  const API = (() => {
    // set to true when you have server endpoints
    const LIVE=false;

    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));

    async function postJSON(url, data){
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(data)
      });
      if(!res.ok) throw new Error("HTTP "+res.status);
      return await res.json();
    }

    return {
      live: LIVE,
      async registerOpen({meId, refId}){
        if(!LIVE) return {ok:true, mode:"DEMO"};
        // return await postJSON("/api/open", {meId, refId});
        await sleep(180);
        return {ok:true, mode:"LIVE"};
      },
      async submitRun({meId, score, bonus}){
        if(!LIVE) return {ok:true};
        // return await postJSON("/api/run", {meId, score, bonus});
        await sleep(180);
        return {ok:true};
      },
      async sendChat(msg){
        if(!LIVE) return {ok:true};
        // return await postJSON("/api/chat", msg);
        await sleep(180);
        return {ok:true};
      },
      async getLeaderboard(){
        if(!LIVE) return {ok:true, players:null};
        // return await fetch("/api/leaderboard").then(r=>r.json());
        await sleep(180);
        return {ok:true, players:null};
      }
    };
  })();

  // ---------- Viral link logic ----------
  const getParam=(n)=>new URL(location.href).searchParams.get(n);
  const myRefLink=()=>{
    const base = location.origin + location.pathname;
    return `${base}?ref=${encodeURIComponent(state.me.id)}`;
  };

  (async function applyReferral(){
    const ref=getParam("ref");
    if(!ref) return;
    if(ref===state.me.id) return;
    if(state.me.infectedBy) return;

    state.me.infectedBy=ref;
    state.players[ref]=state.players[ref] || {id:ref,nick:"Unknown",skin:"classic",infected:0,createdAt:Date.now(),lastSeen:Date.now()};
    state.players[ref].infected = (state.players[ref].infected||0) + 1;

    saveState();
    toast("–¢—ã –∑–∞—Ä–∞–∂—ë–Ω –æ—Ç "+ref, 2000);
    SFX.success();

    try{
      await API.registerOpen({meId:state.me.id, refId:ref});
    }catch(e){}
  })();

  // ---------- Clipboard / Share ----------
  async function copyToClipboard(text){
    try{ await navigator.clipboard.writeText(text); return true; }
    catch(e){
      const ta=document.createElement("textarea");
      ta.value=text; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy");
      ta.remove(); return true;
    }
  }
  async function shareLink(text, url){
    if(navigator.share){
      try{ await navigator.share({title:"Viral Link", text, url}); return true; }
      catch(e){ return false; }
    }
    return false;
  }

  // ---------- UI render ----------
  function renderTop(){
    $("myId").textContent=state.me.id;
    $("modeLabel").textContent = API.live ? "LIVE" : "DEMO";
  }

  function renderHome(){
    renderTop();
    const meP = state.players[state.me.id] || {infected:0};
    $("refLabel").textContent="?ref="+state.me.id;
    $("infectedBy").textContent=state.me.infectedBy || "‚Äî";
    $("infectedCount").textContent=String(meP.infected||0);
    $("nickStat").textContent=state.me.nick || "PatientZero";
    $("bestRun").textContent=String(state.me.bestRun||0);
    $("homeRefInline").textContent=myRefLink();
  }

  const SKINS=[
    {id:"classic", name:"Classic Rot", rarity:"COMMON", aura:"bio"},
    {id:"neon",    name:"Neon Plague", rarity:"RARE",   aura:"cyan"},
    {id:"toxic",   name:"Toxic Bloom", rarity:"EPIC",   aura:"bio2"},
    {id:"void",    name:"Void Carrier",rarity:"LEGEND", aura:"pink"},
    {id:"gold",    name:"Gilded Infection", rarity:"MYTHIC", aura:"gold"},
  ];
  const skinById=(id)=>SKINS.find(s=>s.id===id)||SKINS[0];

  function auraGradient(aura){
    if(aura==="bio")  return "linear-gradient(90deg, rgba(32,255,154,.95), rgba(49,215,255,.70))";
    if(aura==="bio2") return "linear-gradient(90deg, rgba(32,255,154,.95), rgba(255,213,106,.75))";
    if(aura==="cyan") return "linear-gradient(90deg, rgba(49,215,255,.95), rgba(32,255,154,.70))";
    if(aura==="pink") return "linear-gradient(90deg, rgba(255,47,109,.95), rgba(255,144,99,.80))";
    if(aura==="gold") return "linear-gradient(90deg, rgba(255,213,106,.95), rgba(32,255,154,.80))";
    return "linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04))";
  }

  let skinPick = skinById(state.me.skin);

  function renderSkins(){
    renderTop();
    skinPick = skinById(state.me.skin);
    $("skinSelected").textContent=skinPick.id;
    $("skinRarity").textContent=skinPick.rarity;

    const grid=$("skinGrid");
    grid.innerHTML="";
    SKINS.forEach(s=>{
      const btn=document.createElement("button");
      btn.className="btn secondary";
      btn.style.padding="12px";
      btn.style.background="linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04))";
      btn.innerHTML=`
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:44px;height:44px;border-radius:16px;border:1px solid rgba(255,255,255,.14);
            background:${auraGradient(s.aura)}; box-shadow:0 12px 26px rgba(0,0,0,.28)"></div>
          <div style="text-align:left;flex:1">
            <div style="font-weight:950">${escapeHtml(s.name)}</div>
            <div style="font-size:11px;color:rgba(255,255,255,.62)">${escapeHtml(s.rarity)}</div>
          </div>
          <div style="font-weight:950;color:${s.id===state.me.skin ? 'rgba(32,255,154,.95)' : 'rgba(255,255,255,.72)'}">
            ${s.id===state.me.skin ? "EQUIP" : "PICK"}
          </div>
        </div>
      `;
      btn.addEventListener("click", ()=>{
        skinPick=s;
        $("skinSelected").textContent=s.id;
        $("skinRarity").textContent=s.rarity;
        toast("–í—ã–±—Ä–∞–Ω: "+s.name);
        SFX.tap();
      });
      grid.appendChild(btn);
    });
  }

  function computeRank(){
    const arr=Object.values(state.players||{}).map(p=>({
      id:p.id,
      nick:p.nick||"Unknown",
      skin:p.skin||"classic",
      infected:Number(p.infected||0)
    }));
    arr.sort((a,b)=>b.infected-a.infected || a.id.localeCompare(b.id));
    return arr;
  }

  function renderRank(){
    renderTop();
    const arr=computeRank();
    $("totalPlayers").textContent=String(arr.length);
    const myIndex=arr.findIndex(x=>x.id===state.me.id);
    $("youRank").textContent = myIndex>=0 ? "#"+(myIndex+1) : "‚Äî";

    const box=$("rankList");
    box.innerHTML="";
    arr.slice(0, 14).forEach((p,i)=>{
      const s=skinById(p.skin);
      const row=document.createElement("div");
      row.style.display="flex";
      row.style.alignItems="center";
      row.style.justifyContent="space-between";
      row.style.gap="10px";
      row.style.padding="12px";
      row.style.borderRadius="18px";
      row.style.background="rgba(255,255,255,.05)";
      row.style.border="1px solid rgba(255,255,255,.10)";
      row.style.boxShadow="0 10px 22px rgba(0,0,0,.20)";
      row.innerHTML=`
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:34px;height:34px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
            background:${auraGradient(s.aura)}"></div>
          <div>
            <div style="font-weight:950">${i+1}. ${escapeHtml(p.nick)}</div>
            <div class="mono" style="font-size:11px;color:rgba(255,255,255,.62)">${escapeHtml(p.id)}</div>
          </div>
        </div>
        <div style="min-width:74px;text-align:center;font-weight:950;border-radius:14px;padding:8px 10px;
          color:rgba(0,0,0,.90); background:linear-gradient(90deg, rgba(255,213,106,1), rgba(32,255,154,1));
          box-shadow:0 12px 28px rgba(0,0,0,.28)">${p.infected}</div>
      `;
      box.appendChild(row);
    });
  }

  function normalizeLinks(arr){
    const out=[];
    for(const raw of arr){
      if(!raw) continue;
      let s=String(raw).trim();
      if(!s) continue;
      if(!/^https?:\/\//i.test(s)) continue;
      if(s.length>120) s=s.slice(0,120);
      out.push(s);
      if(out.length>=3) break;
    }
    return out;
  }

  function renderProfile(){
    renderTop();
    $("profileId").textContent=state.me.id;
    $("profileSkin").textContent=skinById(state.me.skin).name;
    $("profileRef").textContent=myRefLink();

    $("nickInput").value = state.me.nick || "";
    $("bioInput").value = state.me.bio || "";
    $("link1").value = state.me.links?.[0] || "";
    $("link2").value = state.me.links?.[1] || "";
    $("link3").value = state.me.links?.[2] || "";
  }

  // ---------- Navigation ----------
  const screens=["home","play","skins","rank","chat","profile"];
  function showScreen(name){
    screens.forEach(s=>{
      const el=$("screen-"+s);
      if(el) el.classList.toggle("active", s===name);
    });
    qa(".tab").forEach(t=>t.classList.toggle("active", t.dataset.go===name));
    SFX.tap();

    if(name==="home") renderHome();
    if(name==="skins") renderSkins();
    if(name==="rank") renderRank();
    if(name==="chat") renderChat(true);
    if(name==="profile") renderProfile();
    if(name==="play") Game.ensure();
  }
  qa(".tab").forEach(t=>t.addEventListener("click", ()=>showScreen(t.dataset.go)));

  // ---------- INTRO ----------
  const intro=$("intro");
  const introVid=$("introVid");
  const introBar=$("introBar");

  function tickIntroBar(){
    const d = introVid?.duration || 0;
    if(d>0){
      intro.classList.add("introOn");
      introBar.style.width = clamp((introVid.currentTime/d)*100, 0, 100) + "%";
    }else{
      // cinematic fallback
      const t = (Date.now()%3200)/3200;
      introBar.style.width = (t*100) + "%";
    }
    requestAnimationFrame(tickIntroBar);
  }
  tickIntroBar();

  function closeIntro(){
    intro.classList.add("fadeOut");
    setTimeout(()=>intro.remove(), 230);
  }

  $("introSkip").addEventListener("click", ()=>{ SFX.tap(); closeIntro(); });
  $("introStart").addEventListener("click", async ()=>{
    SFX.unlock();
    SFX.success();
    try{ await introVid.play(); }catch(e){}
    closeIntro();
  });
  introVid?.addEventListener("ended", closeIntro);

  // ---------- Buttons (home/global) ----------
  $("btnGoPlay").addEventListener("click", ()=>showScreen("play"));

  $("btnCopyLink").addEventListener("click", async ()=>{
    await copyToClipboard(myRefLink());
    toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
    SFX.success();
  });
  $("btnCopyLink2").addEventListener("click", async ()=>{
    await copyToClipboard(myRefLink());
    toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
    SFX.success();
  });

  $("btnShare").addEventListener("click", async ()=>{
    const link=myRefLink();
    const ok = await shareLink("–ó–∞–π–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ ‚Äî –∏ —Ç—ã –∑–∞—Ä–∞–∂—ë–Ω üòà", link);
    if(!ok){
      await copyToClipboard(link);
      toast("Share –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
    }else toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
    SFX.success();
  });

  $("btnReset").addEventListener("click", ()=>{
    localStorage.removeItem(STORE_KEY);
    toast("–°–±—Ä–æ—à–µ–Ω–æ");
    SFX.danger();
    setTimeout(()=>location.href=location.pathname, 450);
  });

  $("btnSeed").addEventListener("click", ()=>{
    const names=["GraveRunner","NightBite","ZeroPulse","BioHaze","CyanFang","RotKing","PlagueMuse","VoidEcho","SporeWave","Wasteland","NeonGhoul","ToxicByte"];
    for(let i=0;i<18;i++){
      const id=genId();
      state.players[id]={
        id,
        nick: names[randi(names.length)] + (10+randi(90)),
        skin: SKINS[randi(SKINS.length)].id,
        infected: randi(120),
        createdAt: Date.now()-randi(1e7),
        lastSeen: Date.now()-randi(1e6)
      };
    }
    saveState();
    toast("–î–µ–º–æ-–∏–≥—Ä–æ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã");
    SFX.success();
    renderRank();
  });

  $("btnSaveSkin").addEventListener("click", ()=>{
    state.me.skin = skinPick.id;
    state.players[state.me.id].skin = state.me.skin;
    saveState();
    toast("–°–∫–∏–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω: "+skinPick.name);
    SFX.success();
    Game.applySkin();
    renderHome(); renderProfile(); renderSkins(); renderRank();
  });

  $("btnSaveProfile").addEventListener("click", ()=>{
    const nick = ($("nickInput").value||"").trim().slice(0,16) || "PatientZero";
    const bio  = ($("bioInput").value||"").trim().slice(0,220);
    const links= normalizeLinks([$("link1").value,$("link2").value,$("link3").value]);

    state.me.nick=nick;
    state.me.bio=bio;
    state.me.links=links;

    state.players[state.me.id]=state.players[state.me.id]||{id:state.me.id,nick,skin:state.me.skin,infected:0,createdAt:Date.now(),lastSeen:Date.now()};
    state.players[state.me.id].nick=nick;
    state.players[state.me.id].skin=state.me.skin;

    saveState();
    toast("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
    SFX.success();
    renderHome(); renderProfile(); renderRank();
  });

  $("btnCopyProfileRef").addEventListener("click", async ()=>{
    await copyToClipboard(myRefLink());
    toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
    SFX.success();
  });

  // ---------- CHAT ----------
  function cryptoId(){
    try{
      const a=new Uint8Array(8);
      crypto.getRandomValues(a);
      return Array.from(a).map(x=>x.toString(16).padStart(2,"0")).join("");
    }catch(e){
      return String(Math.random()).slice(2);
    }
  }

  function addChat(msg){
    state.chat.push(msg);
    if(state.chat.length>90) state.chat=state.chat.slice(-90);
    saveState();
    renderChat(true);
  }

  function renderChat(keepScroll){
    renderTop();
    const list=$("chatList");
    const atBottom = list.scrollTop + list.clientHeight >= list.scrollHeight - 24;

    list.innerHTML="";
    (state.chat||[]).forEach(m=>{
      const div=document.createElement("div");
      div.className="msg"+(m.fromId===state.me.id?" mine":"");
      div.innerHTML=`
        <div class="h">
          <b>${escapeHtml(m.fromNick||"Unknown")}</b>
          <span>${escapeHtml(m.t||"")}</span>
        </div>
        ${m.text ? `<p>${escapeHtml(m.text)}</p>` : ``}
        ${m.audioDataUrl ? `<audio controls src="${m.audioDataUrl}"></audio>` : ``}
      `;
      list.appendChild(div);
    });

    if(keepScroll){
      if(atBottom) list.scrollTop=list.scrollHeight;
    }else{
      list.scrollTop=list.scrollHeight;
    }
  }

  function sendText(){
    const inp=$("chatText");
    let text=(inp.value||"").trim();
    if(!text) return;

    const cleaned=stripUrls(text);
    if(cleaned!==text){
      toast("–°—Å—ã–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã ‚Äî —É–¥–∞–ª–µ–Ω–æ");
      SFX.danger();
    }
    text=cleaned.slice(0,220);

    const msg={id:cryptoId(), fromId:state.me.id, fromNick:state.me.nick, t:nowTime(), text};
    addChat(msg);
    inp.value="";
    SFX.tap();

    // server placeholder
    API.sendChat(msg).catch(()=>{});
  }

  $("btnSend").addEventListener("click", sendText);
  $("chatText").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendText(); } });

  // voice
  let rec={active:false, mediaRecorder:null, chunks:[], stream:null};
  async function blobToDataURL(blob){
    return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); });
  }

  async function toggleRecord(){
    const hint=$("voiceHint");
    if(!window.MediaRecorder){
      hint.textContent="MediaRecorder –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. (–ù–∞ iOS –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.)";
      toast("–ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
      SFX.danger();
      return;
    }

    if(rec.active){
      try{ rec.mediaRecorder.stop(); }catch(e){}
      rec.active=false;
      $("recDot").style.display="none";
      toast("–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
      SFX.tap();
      return;
    }

    if(!navigator.mediaDevices?.getUserMedia){
      toast("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
      SFX.danger();
      return;
    }

    try{
      rec.stream=await navigator.mediaDevices.getUserMedia({audio:true});
      rec.chunks=[];
      rec.mediaRecorder=new MediaRecorder(rec.stream);
      rec.mediaRecorder.ondataavailable=(e)=>{ if(e.data && e.data.size>0) rec.chunks.push(e.data); };
      rec.mediaRecorder.onstop=async ()=>{
        try{ rec.stream?.getTracks()?.forEach(t=>t.stop()); }catch(e){}
        const blob=new Blob(rec.chunks,{type:"audio/webm"});
        const dataUrl=await blobToDataURL(blob);

        const msg={id:cryptoId(), fromId:state.me.id, fromNick:state.me.nick, t:nowTime(), audioDataUrl:dataUrl};
        addChat(msg);
        SFX.success();
        API.sendChat(msg).catch(()=>{});
      };
      rec.mediaRecorder.start();
      rec.active=true;
      $("recDot").style.display="inline-block";
      toast("–ó–∞–ø–∏—Å—å... –Ω–∞–∂–º–∏ –µ—â—ë —Ä–∞–∑ —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å");
      SFX.tap();
    }catch(e){
      toast("–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω");
      SFX.danger();
    }
  }

  $("btnRec").addEventListener("click", toggleRecord);

  // ---------- GAME ENGINE (Canvas) ----------
  const Game = (() => {
    let ready=false;

    const wrap=$("gameWrap");
    const glowC=$("glow");
    const gameC=$("game");
    const gctx=glowC.getContext("2d");
    const ctx=gameC.getContext("2d");

    let W=0,H=0,DPR=1;
    let raf=0;
    let last=0;

    // Joystick state
    let joyVec={x:0,y:0}; // -1..1
    let dashPressed=false;

    // World
    const world={
      t:0,
      running:false,
      timeLeft:60,
      score:0,
      streak:0,
      combo:1,
      comboT:0,
      bonus:0,
      ended:false,
      seed: Math.random()*1e9|0,

      player: null,
      humans: [],
      horde: [],
      parts: [],

      cam:{x:0,y:0, vx:0,vy:0},
      bounds:{x:0,y:0,w:2400,h:3600}
    };

    const paletteByAura = {
      bio:  {core:"#20ff9a", glow:"rgba(32,255,154,.24)", eye:"#07130d", accent:"#31d7ff"},
      bio2: {core:"#20ff9a", glow:"rgba(32,255,154,.20)", eye:"#07130d", accent:"#ffd56a"},
      cyan: {core:"#31d7ff", glow:"rgba(49,215,255,.22)", eye:"#071014", accent:"#20ff9a"},
      pink: {core:"#ff2f6d", glow:"rgba(255,47,109,.20)", eye:"#14060b", accent:"#ff9063"},
      gold: {core:"#ffd56a", glow:"rgba(255,213,106,.20)", eye:"#151106", accent:"#20ff9a"},
    };

    function skinAura(skinId){
      return (skinById(skinId).aura) || "bio";
    }

    function resize(){
      const r=wrap.getBoundingClientRect();
      DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
      W = Math.max(1, Math.floor(r.width));
      H = Math.max(1, Math.floor(r.height));
      glowC.width = Math.floor(W*DPR);
      glowC.height= Math.floor(H*DPR);
      gameC.width = Math.floor(W*DPR);
      gameC.height= Math.floor(H*DPR);
      glowC.style.width=W+"px";
      glowC.style.height=H+"px";
      gameC.style.width=W+"px";
      gameC.style.height=H+"px";
      gctx.setTransform(DPR,0,0,DPR,0,0);
      ctx.setTransform(DPR,0,0,DPR,0,0);
    }

    // Entities
    function makePlayer(){
      const aura=skinAura(state.me.skin);
      return {
        x: world.bounds.w*0.50,
        y: world.bounds.h*0.45,
        vx:0, vy:0,
        r:18,
        ang:0,
        dashCd:0,
        aura
      };
    }

    function makeHuman(elite=false){
      const x = rand(world.bounds.w-240, 120);
      const y = rand(world.bounds.h-440, 220);
      const a = rand(Math.PI*2);
      const sp = elite ? rand(82,68) : rand(64,48);
      return {
        x,y,
        vx: Math.cos(a)*sp,
        vy: Math.sin(a)*sp,
        r: elite ? 15 : 13,
        elite,
        turnT: rand(1200, 500),
        alive:true
      };
    }

    function makeFollower(x,y){
      const aura=skinAura(state.me.skin);
      return {
        x,y,
        vx:0,vy:0,
        r:14,
        ang:0,
        aura,
        wob: rand(1000,0),
      };
    }

    function spawnParticles(x,y,color,count=18, sp=240){
      for(let i=0;i<count;i++){
        const a=rand(Math.PI*2);
        const s=rand(sp, sp*0.35);
        world.parts.push({
          x,y,
          vx: Math.cos(a)*s,
          vy: Math.sin(a)*s,
          life: rand(0.9,0.35),
          max: 1,
          size: rand(4.2,2.0),
          color
        });
      }
    }

    function resetRun(){
      world.t=0;
      world.running=true;
      world.timeLeft=60;
      world.score=0;
      world.streak=0;
      world.combo=1;
      world.comboT=0;
      world.bonus=0;
      world.ended=false;

      world.player = makePlayer();
      world.humans.length=0;
      world.horde.length=0;
      world.parts.length=0;

      // spawn initial
      for(let i=0;i<22;i++) world.humans.push(makeHuman(Math.random()<0.14));
      // camera
      world.cam.x = world.player.x;
      world.cam.y = world.player.y;
      world.cam.vx=0; world.cam.vy=0;

      hud();
    }

    // Drawing helpers
    function withAdditive(fn){
      const prev=ctx.globalCompositeOperation;
      ctx.globalCompositeOperation="lighter";
      fn();
      ctx.globalCompositeOperation=prev;
    }

    function drawBackground(){
      const gx = world.cam.x - W/2;
      const gy = world.cam.y - H/2;

      // base
      ctx.clearRect(0,0,W,H);

      // vignette / panel feel
      ctx.fillStyle="rgba(0,0,0,.18)";
      ctx.fillRect(0,0,W,H);

      // subtle grid
      const step=60;
      ctx.strokeStyle="rgba(255,255,255,.04)";
      ctx.lineWidth=1;

      const sx = Math.floor(gx/step)*step;
      const sy = Math.floor(gy/step)*step;

      ctx.beginPath();
      for(let x=sx; x<gx+W+step; x+=step){
        const px=x-gx;
        ctx.moveTo(px,0); ctx.lineTo(px,H);
      }
      for(let y=sy; y<gy+H+step; y+=step){
        const py=y-gy;
        ctx.moveTo(0,py); ctx.lineTo(W,py);
      }
      ctx.stroke();

      // large arcs
      const arc1x = (world.bounds.w*0.28)-gx;
      const arc1y = (world.bounds.h*0.34)-gy;
      ctx.strokeStyle="rgba(32,255,154,.06)";
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.arc(arc1x,arc1y, Math.min(W,H)*0.58, 0, Math.PI*2);
      ctx.stroke();

      const arc2x = (world.bounds.w*0.74)-gx;
      const arc2y = (world.bounds.h*0.68)-gy;
      ctx.strokeStyle="rgba(49,215,255,.06)";
      ctx.beginPath();
      ctx.arc(arc2x,arc2y, Math.min(W,H)*0.48, 0, Math.PI*2);
      ctx.stroke();

      // border frame
      ctx.strokeStyle="rgba(255,255,255,.06)";
      ctx.lineWidth=2;
      roundRect(ctx, 14,14,W-28,H-28,22, false, true);
    }

    function drawGlowPass(){
      gctx.clearRect(0,0,W,H);
      // bloom-ish: draw glows then blur when compositing
      const gx = world.cam.x - W/2;
      const gy = world.cam.y - H/2;

      // player glow
      if(world.player){
        const pal=paletteByAura[world.player.aura] || paletteByAura.bio;
        radial(gctx, world.player.x-gx, world.player.y-gy, 46, pal.glow);
      }

      // horde glow
      for(const z of world.horde){
        const pal=paletteByAura[z.aura] || paletteByAura.bio;
        radial(gctx, z.x-gx, z.y-gy, 28, pal.glow);
      }

      // humans subtle
      for(const h of world.humans){
        radial(gctx, h.x-gx, h.y-gy, h.elite?30:22, h.elite ? "rgba(255,213,106,.12)" : "rgba(255,255,255,.06)");
      }

      // particles glow
      for(const p of world.parts){
        radial(gctx, p.x-gx, p.y-gy, p.size*4.2, p.color);
      }
    }

    function radial(c, x,y, r, color){
      const g=c.createRadialGradient(x,y,0, x,y,r);
      g.addColorStop(0, color);
      g.addColorStop(1, "rgba(0,0,0,0)");
      c.fillStyle=g;
      c.beginPath(); c.arc(x,y,r,0,Math.PI*2); c.fill();
    }

    function roundRect(c,x,y,w,h,r, fill=true, stroke=false){
      c.beginPath();
      c.moveTo(x+r,y);
      c.arcTo(x+w,y,x+w,y+h,r);
      c.arcTo(x+w,y+h,x,y+h,r);
      c.arcTo(x,y+h,x,y,r);
      c.arcTo(x,y,x+w,y,r);
      if(fill) c.fill();
      if(stroke) c.stroke();
    }

    function drawZombie(c, x,y, aura, size, ang, crown=false, mask=false){
      const pal=paletteByAura[aura] || paletteByAura.bio;

      c.save();
      c.translate(x,y);
      c.rotate(ang);

      // body
      c.fillStyle=pal.core;
      c.strokeStyle="rgba(255,255,255,.14)";
      c.lineWidth=2;
      c.beginPath();
      roundedPath(c, -size*0.55, -size*0.70, size*1.1, size*1.45, size*0.42);
      c.fill();
      c.stroke();

      // face plate
      c.fillStyle="rgba(0,0,0,.28)";
      c.strokeStyle="rgba(255,255,255,.10)";
      c.lineWidth=1;
      c.beginPath();
      roundedPath(c, -size*0.42, -size*0.18, size*0.84, size*0.70, size*0.28);
      c.fill(); c.stroke();

      // eyes
      c.fillStyle=pal.accent;
      c.beginPath(); c.arc(-size*0.18, -size*0.02, size*0.10, 0, Math.PI*2); c.fill();
      c.beginPath(); c.arc( size*0.18, -size*0.02, size*0.10, 0, Math.PI*2); c.fill();

      c.fillStyle=pal.eye;
      c.globalAlpha=0.55;
      c.beginPath(); c.arc(-size*0.18, -size*0.02, size*0.05, 0, Math.PI*2); c.fill();
      c.beginPath(); c.arc( size*0.18, -size*0.02, size*0.05, 0, Math.PI*2); c.fill();
      c.globalAlpha=1;

      // mouth
      c.strokeStyle=pal.accent;
      c.globalAlpha=0.35;
      c.lineWidth=2;
      c.beginPath();
      c.moveTo(-size*0.22, size*0.24);
      c.lineTo( size*0.22, size*0.24);
      c.stroke();
      c.globalAlpha=1;

      if(mask){
        c.fillStyle="rgba(0,0,0,.35)";
        c.strokeStyle="rgba(255,255,255,.12)";
        c.lineWidth=2;
        c.beginPath();
        roundedPath(c, -size*0.48, -size*0.30, size*0.96, size*0.90, size*0.34);
        c.fill(); c.stroke();
      }

      if(crown){
        c.fillStyle=pal.accent;
        c.globalAlpha=0.85;
        c.beginPath();
        c.moveTo(-size*0.55, -size*0.68);
        c.lineTo(-size*0.20, -size*1.05);
        c.lineTo( 0,         -size*0.70);
        c.lineTo( size*0.20, -size*1.12);
        c.lineTo( size*0.55, -size*0.68);
        c.closePath();
        c.fill();
        c.globalAlpha=1;
      }

      c.restore();
    }

    function roundedPath(c,x,y,w,h,r){
      c.moveTo(x+r,y);
      c.arcTo(x+w,y, x+w,y+h, r);
      c.arcTo(x+w,y+h, x,y+h, r);
      c.arcTo(x,y+h, x,y, r);
      c.arcTo(x,y, x+w,y, r);
    }

    function drawHuman(c, x,y, elite){
      c.save();
      c.translate(x,y);

      // body glow style
      c.fillStyle = elite ? "rgba(255,213,106,.85)" : "rgba(255,255,255,.72)";
      c.strokeStyle = elite ? "rgba(255,213,106,.20)" : "rgba(255,255,255,.14)";
      c.lineWidth=2;

      // body
      c.beginPath();
      roundedPath(c, -14, -10, 28, 38, 14);
      c.fill(); c.stroke();

      // head
      c.beginPath();
      c.arc(0, -22, 10, 0, Math.PI*2);
      c.fill();

      // elite ring
      if(elite){
        c.strokeStyle="rgba(32,255,154,.28)";
        c.lineWidth=2;
        c.beginPath();
        c.arc(0, 4, 24, 0, Math.PI*2);
        c.stroke();
      }

      c.restore();
    }

    function hud(){
      $("hudScore").textContent=String(world.score);
      $("hudCombo").textContent="x"+String(world.combo);
      $("hudStreak").textContent=String(world.streak);
      $("hudTime").textContent=String(world.timeLeft);
      $("hudBonus").textContent="+"+String(world.bonus);
    }

    function calcBonus(score, streak){
      // feel-good math: every 22 score + streak bonuses
      const b1 = Math.floor(score / 22);
      const b2 = Math.floor(streak / 18);
      return b1 + b2;
    }

    function endRun(){
      if(world.ended) return;
      world.ended=true;
      world.running=false;

      world.bonus = calcBonus(world.score, world.streak);
      hud();

      // persist
      state.me.bestRun = Math.max(state.me.bestRun||0, world.score);

      const meP = state.players[state.me.id] || {infected:0};
      meP.infected = (meP.infected||0) + world.bonus;
      state.players[state.me.id]=meP;

      state.meta.lastPlayedAt = Date.now();
      state.meta.totalRuns = (state.meta.totalRuns||0) + 1;
      state.meta.totalScore = (state.meta.totalScore||0) + world.score;

      saveState();
      renderHome();
      renderRank();

      toast(`RUN OVER ‚Ä¢ SCORE ${world.score} ‚Ä¢ BONUS +${world.bonus} INFECTED`, 2400);
      SFX.success();

      API.submitRun({meId:state.me.id, score:world.score, bonus:world.bonus}).catch(()=>{});
    }

    function ensurePopulation(){
      const target = 22 + Math.min(22, Math.floor(world.score/10));
      const missing = target - world.humans.length;
      if(missing<=0) return;
      for(let i=0;i<Math.min(3, missing);i++){
        world.humans.push(makeHuman(Math.random()<0.16));
      }
    }

    function infectHuman(h){
      if(!h.alive) return;
      h.alive=false;

      const aura=skinAura(state.me.skin);
      const pal=paletteByAura[aura] || paletteByAura.bio;

      const addBase = h.elite ? 4 : 1;
      const add = addBase * world.combo;

      world.score += add;
      world.streak += 1;

      // combo logic
      world.combo = Math.min(16, world.combo + (h.elite ? 3 : 1));
      world.comboT = 80;

      spawnParticles(h.x, h.y, pal.glow, 22 + addBase*8, 320);
      world.horde.push(makeFollower(h.x, h.y));

      SFX.tap();
      hud();
    }

    function update(dt){
      world.t += dt;

      if(world.running && !world.ended){
        // time
        world._secAcc = (world._secAcc||0) + dt;
        if(world._secAcc>=1000){
          world._secAcc -= 1000;
          world.timeLeft--;
          if(world.timeLeft<=0) endRun();
          hud();
        }
      }

      // decay combo
      if(world.comboT>0) world.comboT--;
      else world.combo = Math.max(1, world.combo-1);

      ensurePopulation();

      // player move
      const p=world.player;
      if(!p) return;

      const speedBase = 310 + Math.min(160, world.horde.length*3);

      const vlen = hypot(joyVec.x, joyVec.y);
      if(vlen>0.08 && world.running && !world.ended){
        const nx = joyVec.x / vlen;
        const ny = joyVec.y / vlen;
        p.vx += nx*speedBase*(dt/1000);
        p.vy += ny*speedBase*(dt/1000);
        p.ang = Math.atan2(ny,nx);
      }else{
        // mild drift damp
        p.vx *= Math.pow(0.002, dt/1000);
        p.vy *= Math.pow(0.002, dt/1000);
      }

      // dash
      p.dashCd = Math.max(0, p.dashCd - dt);
      if(dashPressed && p.dashCd<=0 && world.running && !world.ended){
        dashPressed=false;
        p.dashCd=900;
        const dnx = vlen>0.08 ? (joyVec.x/vlen) : Math.cos(p.ang);
        const dny = vlen>0.08 ? (joyVec.y/vlen) : Math.sin(p.ang);
        p.vx += dnx*720;
        p.vy += dny*720;

        const pal=paletteByAura[p.aura] || paletteByAura.bio;
        spawnParticles(p.x, p.y, pal.glow, 24, 420);
        SFX.tap();
      }

      // apply friction
      const fr = Math.pow(0.03, dt/1000);
      p.vx *= fr;
      p.vy *= fr;

      // clamp vel
      const vmax = 520;
      const pv = hypot(p.vx,p.vy);
      if(pv>vmax){
        p.vx = p.vx/pv*vmax;
        p.vy = p.vy/pv*vmax;
      }

      // integrate
      p.x += p.vx*(dt/1000);
      p.y += p.vy*(dt/1000);

      // bounds
      p.x = clamp(p.x, 80, world.bounds.w-80);
      p.y = clamp(p.y, 120, world.bounds.h-160);

      // humans wander + avoid
      for(const h of world.humans){
        if(!h.alive) continue;

        h.turnT -= dt;
        if(h.turnT<=0){
          h.turnT = rand(1400, 600);
          const a=rand(Math.PI*2);
          const sp=h.elite ? rand(86,70) : rand(66,52);
          h.vx = Math.cos(a)*sp;
          h.vy = Math.sin(a)*sp;
        }

        // avoid player
        const dx=h.x - p.x;
        const dy=h.y - p.y;
        const dist=hypot(dx,dy);
        if(dist < 140){
          const inv = 1/Math.max(1,dist);
          const ax = dx*inv;
          const ay = dy*inv;
          const sp = h.elite ? 120 : 92;
          h.vx = lerp(h.vx, ax*sp, 0.08);
          h.vy = lerp(h.vy, ay*sp, 0.08);
        }

        h.x += h.vx*(dt/1000);
        h.y += h.vy*(dt/1000);

        if(h.x<90 || h.x>world.bounds.w-90) h.vx*=-1;
        if(h.y<160 || h.y>world.bounds.h-220) h.vy*=-1;
        h.x = clamp(h.x, 90, world.bounds.w-90);
        h.y = clamp(h.y, 160, world.bounds.h-220);
      }

      // horde follow chain
      let leadX=p.x, leadY=p.y;
      let leadAng=p.ang;
      const spacing=30;

      for(const z of world.horde){
        const tx = leadX - Math.cos(leadAng)*spacing;
        const ty = leadY - Math.sin(leadAng)*spacing;
        const dx = tx - z.x;
        const dy = ty - z.y;
        z.x += dx * (0.12);
        z.y += dy * (0.12);

        z.ang = Math.atan2(leadY - z.y, leadX - z.x);
        z.wob += dt;

        leadX = z.x;
        leadY = z.y;
        leadAng = z.ang;
      }

      // collisions: player/horde with humans
      if(world.running && !world.ended){
        // player infect
        for(const h of world.humans){
          if(!h.alive) continue;
          const d=hypot(h.x-p.x, h.y-p.y);
          if(d < h.r + p.r + 2){
            infectHuman(h);
          }
        }
        // horde infect
        for(const z of world.horde){
          for(const h of world.humans){
            if(!h.alive) continue;
            const d=hypot(h.x-z.x, h.y-z.y);
            if(d < h.r + z.r + 2){
              infectHuman(h);
            }
          }
        }
      }

      // remove dead humans occasionally
      if(world.t % 400 < dt){
        world.humans = world.humans.filter(h=>h.alive);
      }

      // particles
      for(const p of world.parts){
        p.life -= dt/1000;
        p.x += p.vx*(dt/1000);
        p.y += p.vy*(dt/1000);
        p.vx *= Math.pow(0.20, dt/1000);
        p.vy *= Math.pow(0.20, dt/1000);
      }
      world.parts = world.parts.filter(p=>p.life>0);

      // camera follow
      const cam=world.cam;
      const tx = p.x;
      const ty = p.y;
      cam.x = lerp(cam.x, tx, 0.08);
      cam.y = lerp(cam.y, ty, 0.08);

      // draw
      render();
    }

    function render(){
      drawBackground();
      drawGlowPass();

      // composite glow blur
      ctx.save();
      ctx.globalCompositeOperation="lighter";
      ctx.filter="blur(10px)";
      ctx.drawImage(glowC, 0,0, W,H);
      ctx.filter="none";
      ctx.globalAlpha=0.75;
      ctx.drawImage(glowC, 0,0, W,H);
      ctx.globalAlpha=1;
      ctx.globalCompositeOperation="source-over";
      ctx.restore();

      const gx = world.cam.x - W/2;
      const gy = world.cam.y - H/2;

      // draw humans
      for(const h of world.humans){
        if(!h.alive) continue;
        drawHuman(ctx, h.x-gx, h.y-gy, h.elite);
      }

      // draw horde
      for(const z of world.horde){
        const aura=z.aura;
        const skin=state.me.skin;
        const crown = (skin==="gold");
        const mask  = (skin==="void");
        drawZombie(ctx, z.x-gx, z.y-gy, aura, 15, z.ang, crown, mask);
      }

      // draw player
      if(world.player){
        const skin=state.me.skin;
        const crown = (skin==="gold");
        const mask  = (skin==="void");
        drawZombie(ctx, world.player.x-gx, world.player.y-gy, world.player.aura, 20, world.player.ang, crown, mask);
      }

      // particles
      ctx.save();
      ctx.globalCompositeOperation="lighter";
      for(const p of world.parts){
        const a = clamp(p.life/p.max, 0, 1);
        ctx.globalAlpha = a;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x-gx, p.y-gy, p.size, 0, Math.PI*2);
        ctx.fill();
      }
      ctx.restore();

      // overlay corners
      ctx.strokeStyle="rgba(255,255,255,.06)";
      ctx.lineWidth=2;
      roundRect(ctx, 14,14,W-28,H-28,22, false, true);
    }

    function loop(ts){
      if(!last) last=ts;
      const dt = Math.min(32, ts-last);
      last=ts;
      update(dt);
      raf=requestAnimationFrame(loop);
    }

    // ---------- controls: joystick + dash ----------
    function initControls(){
      const joy=$("joy");
      const knob=$("knob");
      const dash=$("dash");
      let active=false, pid=null, base={x:0,y:0};

      const setKnob=(dx,dy)=>{
        const max=46;
        const dist=Math.hypot(dx,dy);
        const k=dist>max ? (max/dist) : 1;
        const x=dx*k, y=dy*k;
        knob.style.transform=`translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
        joyVec.x = clamp(x/max, -1, 1);
        joyVec.y = clamp(y/max, -1, 1);
      };
      const reset=()=>{
        knob.style.transform="translate(-50%,-50%)";
        joyVec.x=0; joyVec.y=0;
      };

      joy.addEventListener("pointerdown",(e)=>{
        active=true; pid=e.pointerId; joy.setPointerCapture(pid);
        const r=joy.getBoundingClientRect();
        base.x=r.left+r.width/2; base.y=r.top+r.height/2;
        setKnob(e.clientX-base.x, e.clientY-base.y);
      });
      joy.addEventListener("pointermove",(e)=>{
        if(!active || e.pointerId!==pid) return;
        setKnob(e.clientX-base.x, e.clientY-base.y);
      });
      joy.addEventListener("pointerup",(e)=>{
        if(e.pointerId!==pid) return;
        active=false; pid=null; reset();
      });
      joy.addEventListener("pointercancel",()=>{ active=false; pid=null; reset(); });

      dash.addEventListener("pointerdown",()=>{
        dashPressed=true;
        SFX.tap();
        setTimeout(()=>dashPressed=false, 140);
      });
    }

    // ---------- Public API ----------
    function ensure(){
      if(ready) return;
      ready=true;

      resize();
      window.addEventListener("resize", resize);

      initControls();
      resetRun();
      last=0;
      raf=requestAnimationFrame(loop);
    }

    function applySkin(){
      if(!world.player) return;
      world.player.aura = skinAura(state.me.skin);
      for(const z of world.horde) z.aura = world.player.aura;
      toast("–°–∫–∏–Ω –ø—Ä–∏–º–µ–Ω—ë–Ω –≤ –∏–≥—Ä–µ");
      SFX.tap();
    }

    function restart(){
      resetRun();
      toast("–ù–æ–≤—ã–π –∑–∞–±–µ–≥");
      SFX.tap();
    }

    function shareRun(){
      const link=myRefLink();
      const text=`Viral Link ‚Äî Score ${world.score}, Bonus +${world.bonus}. Infect via: ${link}`;
      return {text, link};
    }

    // hook buttons
    $("btnRestart").addEventListener("click", ()=>restart());
    $("btnShareRun").addEventListener("click", async ()=>{
      const {text, link}=shareRun();
      const ok=await shareLink(text, link);
      if(!ok){
        await copyToClipboard(text);
        toast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ");
      }else toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
      SFX.success();
    });

    // end-run on leaving tab? (optional: not forcing)
    document.addEventListener("visibilitychange", ()=>{
      if(document.hidden) return;
      // resume feel
      SFX.unlock();
    });

    return { ensure, applySkin };
  })();

  // ---------- Boot ----------
  function renderAll(){
    // ensure me in players
    state.players[state.me.id]=state.players[state.me.id]||{id:state.me.id,nick:state.me.nick,skin:state.me.skin,infected:0,createdAt:Date.now(),lastSeen:Date.now()};
    state.players[state.me.id].nick = state.me.nick;
    state.players[state.me.id].skin = state.me.skin;
    saveState();

    renderHome();
    renderSkins();
    renderRank();
    renderChat(false);
    renderProfile();
  }

  renderAll();

  // Wake lock (best effort)
  (async ()=>{ try{ if("wakeLock" in navigator){ await navigator.wakeLock.request("screen"); } }catch(e){} })();

  // PWA service worker (safe for GitHub Pages path)
  (async ()=>{
    try{
      if("serviceWorker" in navigator){
        const swUrl = new URL("sw.js", location.href);
        await navigator.serviceWorker.register(swUrl);
      }
    }catch(e){}
  })();

  </script>
</body>
</html>
