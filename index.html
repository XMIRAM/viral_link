<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#07090c"/>
  <title>Viral Link ‚Äî The Link Is The Virus</title>

  <style>
    :root{
      --bg:#07090c;
      --bg2:#05070a;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.085);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --bio:#20ff9a;
      --cyan:#31d7ff;
      --pink:#ff2f6d;
      --gold:#ffd56a;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 12px 28px rgba(0,0,0,.35);

      --r: 22px;
      --r2: 28px;
      --pad: 14px;
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    body{ overflow:hidden; -webkit-tap-highlight-color: transparent; user-select:none; }

    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1000px 700px at 50% -10%, rgba(32,255,154,.14), transparent 55%),
        radial-gradient(900px 700px at 15% 55%, rgba(49,215,255,.10), transparent 55%),
        radial-gradient(900px 700px at 85% 65%, rgba(255,47,109,.10), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg) 35%, var(--bg2));
    }
    .noise{
      position:absolute; inset:0; opacity:.06; mix-blend-mode:overlay; pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
    }

    /* App shell */
    .shell{
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      padding-top:calc(10px + var(--safeTop));
      padding-bottom:calc(10px + var(--safeBottom));
    }

    /* Sticky top HUD (not tabs like before) */
    .hud{
      position:sticky; top:0;
      z-index:50;
      padding:0 var(--pad);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      pointer-events:auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .sigil{
      width:34px; height:34px; border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(circle at 30% 30%, rgba(32,255,154,.9), rgba(32,255,154,0) 60%),
        radial-gradient(circle at 70% 60%, rgba(49,215,255,.7), rgba(49,215,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.02));
      position:relative;
    }
    .sigil:after{
      content:"";
      position:absolute; inset:-80%;
      background: conic-gradient(from 220deg,
        rgba(32,255,154,0), rgba(32,255,154,.22), rgba(49,215,255,0),
        rgba(255,47,109,.18), rgba(32,255,154,0));
      filter: blur(12px);
      animation: spin 6.4s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    .btngroup{
      display:flex; gap:8px; align-items:center;
    }
    .pill{
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      display:flex; align-items:center; gap:8px;
      font-weight:900;
      letter-spacing:.3px;
    }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; letter-spacing:.7px; }
    .dot{
      width:10px; height:10px; border-radius:99px;
      background: radial-gradient(circle at 30% 30%, rgba(32,255,154,1), rgba(32,255,154,.18));
      box-shadow:0 0 18px rgba(32,255,154,.35);
    }
    .mini{
      padding:10px 12px;
      border-radius:999px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      color: rgba(255,255,255,.88);
      font-weight:900;
    }
    .mini:active{ transform: scale(.985); }

    /* Scroll feed */
    .feed{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px var(--pad) 120px;
      scroll-snap-type: y proximity;
    }

    section{
      scroll-snap-align: start;
      margin: 10px 0 18px;
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    section .inner{
      padding: 16px;
      display:flex; flex-direction:column; gap:12px;
    }

    /* Headline / cinematic */
    .hero{
      min-height: 76vh;
      display:flex; flex-direction:column; justify-content:flex-end;
      padding: 18px;
      background:
        radial-gradient(950px 500px at 40% 0%, rgba(32,255,154,.18), transparent 60%),
        radial-gradient(900px 650px at 10% 60%, rgba(49,215,255,.12), transparent 60%),
        radial-gradient(900px 650px at 90% 70%, rgba(255,47,109,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.20), rgba(0,0,0,.65));
      position:relative;
      overflow:hidden;
    }
    .heroCanvas{
      position:absolute; inset:0;
      width:100%; height:100%;
      opacity:.95;
    }
    .hero:after{
      content:"";
      position:absolute; inset:-70%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform: rotate(22deg) translateX(-55%);
      animation: shine 2.6s ease-in-out infinite;
      opacity:.7;
      pointer-events:none;
    }
    @keyframes shine{
      0%{ transform:rotate(22deg) translateX(-70%); opacity:0 }
      18%{ opacity:.55 }
      55%{ opacity:.35 }
      100%{ transform:rotate(22deg) translateX(70%); opacity:0 }
    }

    h1{ margin:0; font-size:22px; font-weight:950; letter-spacing:.6px; }
    .lead{ margin:0; color:rgba(255,255,255,.74); font-size:13px; line-height:1.35; }

    .glowline{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(32,255,154,.65), rgba(49,215,255,.55), rgba(255,47,109,.25), transparent);
      opacity:.9;
    }

    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }

    .card{
      border-radius: var(--r);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
      padding: 12px;
    }
    .k{ font-size:11px; color:rgba(255,255,255,.62); }
    .v{ margin-top:4px; font-size:18px; font-weight:950; }

    .btn{
      width:100%;
      border:none; outline:none;
      padding: 14px 14px;
      border-radius: 18px;
      font-weight:950;
      color: rgba(0,0,0,.92);
      letter-spacing:.2px;
      background:
        radial-gradient(140% 140% at 20% 20%, rgba(255,255,255,.55), rgba(255,255,255,0) 38%),
        linear-gradient(90deg, rgba(32,255,154,1), rgba(49,215,255,1));
      box-shadow:
        0 16px 40px rgba(0,0,0,.45),
        0 0 0 1px rgba(255,255,255,.20) inset,
        0 0 40px rgba(32,255,154,.18);
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
    }
    .btn:active{ transform: scale(.985); }
    .btn.secondary{
      color: rgba(255,255,255,.92);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
    }
    .btn.danger{
      color: rgba(255,255,255,.92);
      background: linear-gradient(90deg, rgba(255,47,109,1), rgba(255,144,99,1));
      box-shadow:
        0 16px 40px rgba(0,0,0,.45),
        0 0 0 1px rgba(255,255,255,.16) inset,
        0 0 40px rgba(255,47,109,.18);
    }
    .btn .shine{
      position:absolute; inset:-70%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
      transform: rotate(25deg) translateX(-55%);
      animation: btnshine 2.3s ease-in-out infinite;
      opacity:.75;
      pointer-events:none;
    }
    @keyframes btnshine{
      0%{ transform: rotate(25deg) translateX(-75%); opacity:0 }
      22%{ opacity:.55 }
      62%{ opacity:.35 }
      100%{ transform: rotate(25deg) translateX(75%); opacity:0 }
    }

    .tiny{ font-size:11px; color:rgba(255,255,255,.62); line-height:1.3; }
    .chipbar{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
      font-size:12px;
      color: rgba(255,255,255,.88);
    }

    /* Game */
    .gameWrap{
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      box-shadow: 0 20px 60px rgba(0,0,0,.40);
      overflow:hidden;
      height: min(56vh, 520px);
      position:relative;
      touch-action:none;
    }
    canvas.game{
      position:absolute; inset:0;
      width:100%; height:100%;
      display:block;
    }
    .hudline{
      position:absolute; top:12px; left:12px; right:12px;
      display:flex; gap:10px; flex-wrap:wrap;
      z-index:5;
    }
    .hudchip{
      padding:9px 10px;
      border-radius:16px;
      background: rgba(0,0,0,.32);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
      font-size:12px;
      font-weight:900;
      color: rgba(255,255,255,.90);
    }
    .controls{
      position:absolute; bottom:12px; left:12px; right:12px;
      display:flex; justify-content:space-between; gap:12px;
      z-index:5;
      pointer-events:none;
    }
    .stick, .dash{
      pointer-events:auto;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .stick{
      width:140px; height:140px; border-radius:999px; position:relative;
      touch-action:none;
    }
    .stick:before{
      content:""; position:absolute; inset:16px;
      border-radius:999px; border:1px dashed rgba(255,255,255,.12); opacity:.7;
    }
    .knob{
      width:56px; height:56px; border-radius:18px;
      position:absolute; left:50%; top:50%;
      transform: translate(-50%,-50%);
      background:
        radial-gradient(120% 120% at 20% 20%, rgba(255,255,255,.18), rgba(255,255,255,0) 45%),
        linear-gradient(90deg, rgba(32,255,154,.85), rgba(49,215,255,.85));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 16px 40px rgba(0,0,0,.45), 0 0 30px rgba(32,255,154,.15);
    }
    .dash{
      width:98px; height:98px; border-radius:28px;
      display:grid; place-items:center;
      font-weight:950; letter-spacing:.7px;
      color: rgba(255,255,255,.92);
      background:
        radial-gradient(140% 140% at 20% 20%, rgba(255,255,255,.16), rgba(255,255,255,0) 45%),
        linear-gradient(90deg, rgba(255,47,109,.95), rgba(255,144,99,.90));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 20px 60px rgba(0,0,0,.45), 0 0 34px rgba(255,47,109,.16);
      touch-action:none;
    }
    .dash:active{ transform: scale(.985); }

    /* Forms */
    .field{ display:flex; flex-direction:column; gap:8px; }
    label{ font-size:11px; color:rgba(255,255,255,.66); }
    input,textarea{
      width:100%;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      color: rgba(255,255,255,.92);
      padding: 12px 12px;
      outline:none;
      font-size:13px;
    }
    textarea{ min-height:80px; resize:none; line-height:1.25; }

    /* Chat */
    .chatList{
      height: 320px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      display:flex; flex-direction:column; gap:8px;
      padding-right:2px;
    }
    .msg{
      max-width: 88%;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
      align-self:flex-start;
    }
    .msg.mine{
      align-self:flex-end;
      background: rgba(32,255,154,.10);
      border-color: rgba(32,255,154,.20);
    }
    .msg .h{ display:flex; justify-content:space-between; gap:10px; margin-bottom:4px; }
    .msg .h b{ font-size:11px; }
    .msg .h span{ font-size:10px; color: rgba(255,255,255,.58); }
    .msg p{ margin:0; font-size:12.5px; color: rgba(255,255,255,.88); line-height:1.3; word-break:break-word; }
    .msg audio{ width:100%; margin-top:6px; }

    .chatInput{
      display:flex; gap:10px; align-items:center;
      padding:10px;
      border-radius:18px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
    }
    .chatInput input{
      flex:1; border:none; background:transparent; padding:10px 6px;
    }
    .iconBtn{
      width:46px; height:46px; border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
      display:grid; place-items:center;
      position:relative;
    }
    .icon{ width:18px; height:18px; fill:none; stroke:rgba(255,255,255,.90); stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
    .recDot{
      position:absolute; top:10px; left:10px;
      width:10px;height:10px;border-radius:99px;
      background: rgba(255,47,109,1);
      box-shadow: 0 0 18px rgba(255,47,109,.55);
      display:none;
    }

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:calc(22px + var(--safeBottom));
      z-index:9999;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      color: rgba(255,255,255,.88);
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      max-width:92vw;
      text-align:center;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

    /* Landscape toggle modes */
    body[data-ui="landscape"] .feed{
      padding-bottom: 26px;
    }
    body[data-ui="landscape"] section .inner{
      padding: 14px;
    }
    body[data-ui="landscape"] .hero{
      min-height: 60vh;
    }
    body[data-ui="landscape"] .gameWrap{
      height: min(60vh, 420px);
    }

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce){
      .sigil:after, .hero:after, .btn .shine{ animation:none !important; }
    }
  </style>
</head>

<body>
  <div class="bg"><div class="noise"></div></div>

  <div class="shell">
    <!-- Sticky HUD -->
    <div class="hud">
      <div class="brand">
        <div class="sigil" aria-hidden="true"></div>
        <div>
          <div style="font-weight:950;letter-spacing:.7px;font-size:12px">VIRAL LINK</div>
          <div style="font-size:11px;color:rgba(255,255,255,.62)">The Link Is The Virus</div>
        </div>
      </div>

      <div class="btngroup">
        <div class="pill" title="Your Infection ID">
          <div class="dot"></div>
          <div style="font-size:11px;color:rgba(255,255,255,.62)">ID</div>
          <div class="mono" id="myId">‚Äî</div>
        </div>
        <button class="mini" id="btnLandscape" title="Landscape mode">‚Üî</button>
      </div>
    </div>

    <!-- Scroll Feed -->
    <div class="feed" id="feed">
      <!-- SECTION: INTRO -->
      <section id="s-intro">
        <div class="hero">
          <canvas class="heroCanvas" id="heroFX"></canvas>
          <div style="position:relative;display:flex;flex-direction:column;gap:10px">
            <h1>–°—Å—ã–ª–∫–∞ ‚Äî —ç—Ç–æ –≤–∏—Ä—É—Å.</h1>
            <p class="lead">
              –¢—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è —Ç–æ–ø-1 –Ω–µ ‚Äú–ø–æ —Å–∫–∏–ª–ª—É‚Äù, –∞ –ø–æ <b>INFECTED</b>. <br/>
              –õ—é–±–æ–π, –∫—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏–≥—Ä—É –ø–æ —Ç–≤–æ–µ–º—É <span class="mono">?ref=ID</span> ‚Äî –∑–∞—Ä–∞–∂—ë–Ω.
            </p>

            <div class="glowline"></div>

            <div class="chipbar">
              <div class="chip"><span class="mono">REF</span><b id="refChip">‚Äî</b></div>
              <div class="chip"><span class="mono">INFECTED</span><b id="infectedChip">0</b></div>
              <div class="chip"><span class="mono">FROM</span><b class="mono" id="fromChip">‚Äî</b></div>
              <div class="chip"><span class="mono">MODE</span><b id="modeChip">DEMO</b></div>
            </div>

            <div class="row">
              <button class="btn" id="btnCopyLink">
                COPY VIRUS LINK <span class="shine" aria-hidden="true"></span>
              </button>
              <button class="btn secondary" id="btnShare">SHARE</button>
            </div>

            <button class="btn secondary" id="btnScrollToPlay">SCROLL TO PLAY ‚Üì</button>

            <div class="tiny">
              –í DEMO –≤—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞). –ù–æ –º–µ—Ö–∞–Ω–∏–∫–∞ –≤–∏—Ä—É—Å-—Å—Å—ã–ª–∫–∏ —É–∂–µ –∫–∞–∫ –Ω–∞–¥–æ.
              –ö–æ–≥–¥–∞ –ø–æ–¥–∫–ª—é—á–∏—à—å –±—ç–∫–µ–Ω–¥ ‚Äî –ª–∏–¥–µ—Ä—ã —Å—Ç–∞–Ω—É—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏.
            </div>
          </div>
        </div>
      </section>

      <!-- SECTION: HOW IT WORKS -->
      <section id="s-how">
        <div class="inner">
          <div class="row">
            <div class="card">
              <div class="k">–®–∞–≥ 1</div>
              <div class="v">Copy Link</div>
              <div class="tiny">–£ —Ç–µ–±—è –µ—Å—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∏ —Å—Å—ã–ª–∫–∞ —Å <span class="mono">?ref</span>.</div>
            </div>
            <div class="card">
              <div class="k">–®–∞–≥ 2</div>
              <div class="v">Share</div>
              <div class="tiny">–ö–∏–¥–∞–µ—à—å –≤ —Å—Ç–æ—Ä–∏—Å/–¥—Ä—É–∑—å—è–º/—Ç–≥/–∫–æ–º–º–µ–Ω—Ç—ã.</div>
            </div>
          </div>

          <div class="card">
            <div class="k">–®–∞–≥ 3</div>
            <div class="v">Infect</div>
            <div class="tiny">
              –õ—é–±–æ–π –Ω–æ–≤—ã–π –∏–≥—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∫—Ä—ã–ª –∏–≥—Ä—É –ø–æ —Ç–≤–æ–µ–π —Å—Å—ã–ª–∫–µ ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ç–≤–æ–π <b>INFECTED</b>.
              –ê –∑–∞ –∏–≥—Ä—É —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å <b>Run Bonus</b> (–∫–æ–º–±–æ/—Å—Ç—Ä–∏–º).
            </div>
          </div>

          <button class="btn" id="btnJumpPlay">
            GO PLAY NOW <span class="shine" aria-hidden="true"></span>
          </button>
        </div>
      </section>

      <!-- SECTION: GAME -->
      <section id="s-play">
        <div class="inner">
          <div class="card">
            <div class="k">Infect Run (2D)</div>
            <div class="v">–°–æ–±–∏—Ä–∞–π –æ—Ä–¥—É</div>
            <div class="tiny">
              –¢—ã—á–µ—à—å –ª—é–¥–µ–π ‚Üí –æ–Ω–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Ç–≤–æ–µ–π –æ—Ä–¥–æ–π –∏ –∑–∞—Ä–∞–∂–∞—é—Ç –¥—Ä—É–≥–∏—Ö.
              –ö–æ–º–±–æ —Ä–∞—Å—Ç—ë—Ç, streak –¥–∞—ë—Ç –±–æ–Ω—É—Å. –í –∫–æ–Ω—Ü–µ –∑–∞–±–µ–≥–∞ –±–æ–Ω—É—Å +INFECTED.
            </div>
          </div>

          <div class="gameWrap" id="gameWrap">
            <canvas class="game" id="glow"></canvas>
            <canvas class="game" id="game"></canvas>

            <div class="hudline">
              <div class="hudchip">SCORE <span class="mono" id="hudScore">0</span></div>
              <div class="hudchip">COMBO <span class="mono" id="hudCombo">x1</span></div>
              <div class="hudchip">STREAK <span class="mono" id="hudStreak">0</span></div>
              <div class="hudchip">TIME <span class="mono" id="hudTime">60</span></div>
              <div class="hudchip">BONUS <span class="mono" id="hudBonus">+0</span></div>
            </div>

            <div class="controls">
              <div class="stick" id="stick"><div class="knob" id="knob"></div></div>
              <div class="dash" id="dash">DASH</div>
            </div>
          </div>

          <div class="row">
            <button class="btn secondary" id="btnRestart">RESTART</button>
            <button class="btn" id="btnShareRun">SHARE RUN <span class="shine" aria-hidden="true"></span></button>
          </div>

          <div class="tiny">–í—Å—ë –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ. –ù–∏–∫–∞–∫–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—Ç–æ—á–µ–Ω–æ –ø–æ–¥ –ø–∞–ª–µ—Ü.</div>
        </div>
      </section>

      <!-- SECTION: RANK -->
      <section id="s-rank">
        <div class="inner">
          <div class="row">
            <div class="card">
              <div class="k">–¢–≤–æ–π –Ω–∏–∫</div>
              <div class="v" id="nickStat">‚Äî</div>
              <div class="tiny">–ü—Ä–æ—Ñ–∏–ª—å –Ω–∏–∂–µ.</div>
            </div>
            <div class="card">
              <div class="k">Best Run</div>
              <div class="v"><span class="mono" id="bestRun">0</span></div>
              <div class="tiny">–û—á–∫–∏ –∑–∞ –∑–∞–±–µ–≥.</div>
            </div>
          </div>

          <div class="card">
            <div class="k">–õ–∏–¥–µ—Ä–±–æ—Ä–¥ (DEMO)</div>
            <div class="tiny">–ü–æ <b>INFECTED</b> (—Ä–µ—Ñ–µ—Ä–∞–ª—ã + –±–æ–Ω—É—Å—ã). –ü–æ–¥ —Å–µ—Ä–≤–µ—Ä ‚Äî —Å—Ç–∞–Ω–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ.</div>
            <div style="height:10px"></div>
            <div id="rankList" style="display:flex;flex-direction:column;gap:10px"></div>
          </div>

          <div class="row">
            <button class="btn secondary" id="btnSeed">SEED DEMO PLAYERS</button>
            <button class="btn secondary" id="btnCopyLink2">COPY LINK</button>
          </div>
        </div>
      </section>

      <!-- SECTION: CHAT -->
      <section id="s-chat">
        <div class="inner">
          <div class="card">
            <div class="k">Global Chat</div>
            <div class="v">Text + Voice</div>
            <div class="tiny"><b>–°—Å—ã–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã</b>. –õ—é–±—ã–µ URL —Ä–µ–∂—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
          </div>

          <div class="chatList" id="chatList"></div>

          <div class="chatInput">
            <input id="chatText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ (—Å—Å—ã–ª–∫–∏ —É–¥–∞–ª—è—Ç—Å—è)" maxlength="220"/>
            <button class="iconBtn" id="btnRec" title="Voice" aria-label="Voice">
              <span class="recDot" id="recDot"></span>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3Z"></path>
                <path d="M19 11a7 7 0 0 1-14 0"></path>
                <path d="M12 18v3"></path>
              </svg>
            </button>
            <button class="iconBtn" id="btnSend" title="Send" aria-label="Send">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M22 2 11 13"></path>
                <path d="M22 2 15 22 11 13 2 9 22 2Z"></path>
              </svg>
            </button>
          </div>

          <div class="tiny" id="voiceHint">–ì–æ–ª–æ—Å–æ–≤—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ (–¥–µ–º–æ). –ù–∞ iOS –∑–∞–ø–∏—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞.</div>
        </div>
      </section>

      <!-- SECTION: PROFILE -->
      <section id="s-profile">
        <div class="inner">
          <div class="card">
            <div class="k">–ü—Ä–æ—Ñ–∏–ª—å</div>
            <div class="v">Bio + Links</div>
            <div class="tiny">–°—Å—ã–ª–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Ç—É—Ç. –í —á–∞—Ç–µ ‚Äî –Ω–µ–ª—å–∑—è.</div>
          </div>

          <div class="field">
            <label>–ù–∏–∫ (–¥–æ 16)</label>
            <input id="nickInput" maxlength="16" placeholder="PatientZero"/>
          </div>

          <div class="field">
            <label>Bio (–¥–æ 220)</label>
            <textarea id="bioInput" maxlength="220" placeholder="–ö—Ç–æ —Ç—ã –∏ –∑–∞—á–µ–º —Ç—ã –∑–∞—Ä–∞–∂–∞–µ—à—å?"></textarea>
          </div>

          <div class="field">
            <label>–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (–¥–æ 3, —Ç–æ–ª—å–∫–æ https://)</label>
            <input id="link1" placeholder="https://..."/>
            <input id="link2" placeholder="https://..."/>
            <input id="link3" placeholder="https://..."/>
          </div>

          <button class="btn" id="btnSaveProfile">
            SAVE PROFILE <span class="shine" aria-hidden="true"></span>
          </button>

          <div class="card">
            <div class="k">–¢–≤–æ—è –≤–∏—Ä—É—Å-—Å—Å—ã–ª–∫–∞</div>
            <div class="v"><span class="mono" id="profileRef">‚Äî</span></div>
            <div style="height:8px"></div>
            <button class="btn secondary" id="btnCopyProfileRef">COPY LINK</button>
          </div>

          <button class="btn danger" id="btnReset">RESET DEMO (LOCAL)</button>
        </div>
      </section>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
/* ==========================================================
   Viral Link ‚Äî NEW FRONTEND FROM SCRATCH
   - Scroll feed layout (not tabs like before)
   - Landscape toggle button (best effort lock + fallback UI)
   - Virus link ?ref=ID (local demo)
   - 2D infection game (canvas)
   - Chat text+voice (no URLs)
   - Profile with allowed links (only there)
   ========================================================== */

const $ = (id)=>document.getElementById(id);
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const lerp=(a,b,t)=>a+(b-a)*t;
const hypot=Math.hypot;

const nowTime=()=>new Date().toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
const urlRe=/https?:\/\/[^\s]+|www\.[^\s]+|\b[\w.-]+\.[a-z]{2,}\b/ig;
const stripUrls=(t)=>String(t||"").replace(urlRe,"[no-link]");
const escapeHtml=(s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));

const toast=(msg,ms=1600)=>{
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.classList.remove("show"), ms);
};

/* ---- SFX (tiny procedural) ---- */
const SFX = (() => {
  let ctx=null;
  const ensure=()=>ctx || (ctx=new (window.AudioContext||window.webkitAudioContext)());
  const ping=(f=220,ms=35,type="sine",gain=0.045)=>{
    try{
      const c=ensure();
      const o=c.createOscillator();
      const g=c.createGain();
      o.type=type; o.frequency.value=f;
      g.gain.value=gain;
      o.connect(g); g.connect(c.destination);
      o.start(); setTimeout(()=>o.stop(), ms);
    }catch(e){}
  };
  return {
    unlock(){ try{ ensure(); }catch(e){} },
    tap(){ navigator.vibrate?.(8); ping(240,22,"sine",0.03); },
    success(){ navigator.vibrate?.([18,10,18]); ping(420,40,"triangle",0.05); },
    danger(){ navigator.vibrate?.([25,12,25]); ping(140,70,"sawtooth",0.04); }
  };
})();

/* ---- Local State ---- */
const STORE_KEY="viral_link_scroll_v1";
const genId=()=>{
  const a="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out=""; for(let i=0;i<8;i++) out+=a[(Math.random()*a.length)|0];
  return out;
};
const defaultState=()=>({
  me:{ id: genId(), nick:"PatientZero", bio:"", links:[], infectedBy:null, bestRun:0 },
  players:{},
  chat:[]
});
let state = load();

function load(){
  try{
    const raw=localStorage.getItem(STORE_KEY);
    if(!raw){
      const s=defaultState();
      s.players[s.me.id]={id:s.me.id,nick:s.me.nick,infected:0};
      localStorage.setItem(STORE_KEY, JSON.stringify(s));
      return s;
    }
    const s=JSON.parse(raw);
    s.players=s.players||{};
    s.chat=s.chat||[];
    if(!s.me?.id) throw new Error("bad");
    if(!s.players[s.me.id]) s.players[s.me.id]={id:s.me.id,nick:s.me.nick,infected:0};
    return s;
  }catch(e){
    const s=defaultState();
    s.players[s.me.id]={id:s.me.id,nick:s.me.nick,infected:0};
    localStorage.setItem(STORE_KEY, JSON.stringify(s));
    return s;
  }
}
function save(){
  state.players[state.me.id]=state.players[state.me.id]||{id:state.me.id,nick:state.me.nick,infected:0};
  state.players[state.me.id].nick=state.me.nick;
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}

function myRefLink(){
  const base = location.origin + location.pathname;
  return `${base}?ref=${encodeURIComponent(state.me.id)}`;
}

/* ---- Referral virus ---- */
(function applyReferral(){
  const ref = new URL(location.href).searchParams.get("ref");
  if(!ref) return;
  if(ref===state.me.id) return;
  if(state.me.infectedBy) return;

  state.me.infectedBy=ref;
  state.players[ref]=state.players[ref]||{id:ref,nick:"Unknown",infected:0};
  state.players[ref].infected = (state.players[ref].infected||0) + 1;

  save();
  toast("–¢—ã –∑–∞—Ä–∞–∂—ë–Ω –æ—Ç "+ref, 2000);
  SFX.success();
})();

/* ---- UI render ---- */
function renderHeader(){
  $("myId").textContent=state.me.id;
}
function renderIntro(){
  $("refChip").textContent="?ref="+state.me.id;
  $("fromChip").textContent=state.me.infectedBy || "‚Äî";
  $("modeChip").textContent="DEMO";
  $("infectedChip").textContent = String(state.players[state.me.id]?.infected || 0);
}
function renderRank(){
  $("nickStat").textContent = state.me.nick || "PatientZero";
  $("bestRun").textContent = String(state.me.bestRun||0);

  const arr=Object.values(state.players).map(p=>({
    id:p.id, nick:p.nick||"Unknown", infected:Number(p.infected||0)
  })).sort((a,b)=>b.infected-a.infected || a.id.localeCompare(b.id));

  const box=$("rankList");
  box.innerHTML="";
  arr.slice(0,12).forEach((p,i)=>{
    const row=document.createElement("div");
    row.className="card";
    row.style.display="flex";
    row.style.alignItems="center";
    row.style.justifyContent="space-between";
    row.style.gap="10px";
    row.innerHTML=`
      <div>
        <div style="font-weight:950">${i+1}. ${escapeHtml(p.nick)}</div>
        <div class="mono" style="font-size:11px;color:rgba(255,255,255,.62)">${escapeHtml(p.id)}</div>
      </div>
      <div style="min-width:76px;text-align:center;font-weight:950;border-radius:16px;padding:10px 12px;
        color:rgba(0,0,0,.90); background:linear-gradient(90deg, rgba(255,213,106,1), rgba(32,255,154,1));
        box-shadow:0 12px 28px rgba(0,0,0,.28)">${p.infected}</div>
    `;
    box.appendChild(row);
  });
}
function renderProfile(){
  $("nickInput").value = state.me.nick || "";
  $("bioInput").value  = state.me.bio || "";
  $("link1").value = state.me.links?.[0] || "";
  $("link2").value = state.me.links?.[1] || "";
  $("link3").value = state.me.links?.[2] || "";
  $("profileRef").textContent=myRefLink();
}
function renderChat(stickBottom=false){
  const list=$("chatList");
  const atBottom = list.scrollTop + list.clientHeight >= list.scrollHeight - 24;

  list.innerHTML="";
  for(const m of state.chat){
    const div=document.createElement("div");
    div.className="msg"+(m.fromId===state.me.id?" mine":"");
    div.innerHTML=`
      <div class="h">
        <b>${escapeHtml(m.fromNick||"Unknown")}</b>
        <span>${escapeHtml(m.t||"")}</span>
      </div>
      ${m.text ? `<p>${escapeHtml(m.text)}</p>` : ``}
      ${m.audioDataUrl ? `<audio controls src="${m.audioDataUrl}"></audio>` : ``}
    `;
    list.appendChild(div);
  }
  if(stickBottom){
    if(atBottom) list.scrollTop=list.scrollHeight;
  }else{
    list.scrollTop=list.scrollHeight;
  }
}
function renderAll(){
  renderHeader();
  renderIntro();
  renderRank();
  renderChat(false);
  renderProfile();
}
renderAll();

/* ---- Actions ---- */
async function copyToClipboard(text){
  try{ await navigator.clipboard.writeText(text); return true; }
  catch(e){
    const ta=document.createElement("textarea");
    ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    ta.remove(); return true;
  }
}
async function shareLink(text, url){
  if(navigator.share){
    try{ await navigator.share({title:"Viral Link", text, url}); return true; }catch(e){ return false; }
  }
  return false;
}

$("btnCopyLink").addEventListener("click", async ()=>{
  SFX.unlock(); SFX.tap();
  await copyToClipboard(myRefLink());
  toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
  SFX.success();
});
$("btnCopyLink2").addEventListener("click", async ()=>{
  SFX.unlock(); SFX.tap();
  await copyToClipboard(myRefLink());
  toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
  SFX.success();
});
$("btnShare").addEventListener("click", async ()=>{
  SFX.unlock(); SFX.tap();
  const link=myRefLink();
  const ok=await shareLink("–ó–∞–π–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ ‚Äî –∏ —Ç—ã –∑–∞—Ä–∞–∂—ë–Ω üòà", link);
  if(!ok){
    await copyToClipboard(link);
    toast("Share –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
  }else toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
  SFX.success();
});

$("btnScrollToPlay").addEventListener("click", ()=>{
  SFX.tap();
  $("s-play").scrollIntoView({behavior:"smooth", block:"start"});
});
$("btnJumpPlay").addEventListener("click", ()=>{
  SFX.tap();
  $("s-play").scrollIntoView({behavior:"smooth", block:"start"});
});

$("btnSeed").addEventListener("click", ()=>{
  const names=["GraveRunner","NightBite","ZeroPulse","BioHaze","CyanFang","RotKing","PlagueMuse","VoidEcho","SporeWave","Wasteland","NeonGhoul","ToxicByte"];
  for(let i=0;i<18;i++){
    const id=genId();
    state.players[id]={ id, nick:names[(Math.random()*names.length)|0]+(10+((Math.random()*90)|0)), infected: (Math.random()*120)|0 };
  }
  save(); renderRank();
  toast("–î–µ–º–æ-–∏–≥—Ä–æ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã");
  SFX.success();
});

$("btnSaveProfile").addEventListener("click", ()=>{
  const nick = ($("nickInput").value||"").trim().slice(0,16) || "PatientZero";
  const bio  = ($("bioInput").value||"").trim().slice(0,220);
  const links = normalizeLinks([$("link1").value,$("link2").value,$("link3").value]);

  state.me.nick=nick;
  state.me.bio=bio;
  state.me.links=links;
  state.players[state.me.id]=state.players[state.me.id]||{id:state.me.id,nick,infected:0};
  state.players[state.me.id].nick=nick;
  save();

  renderAll();
  toast("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
  SFX.success();
});

$("btnCopyProfileRef").addEventListener("click", async ()=>{
  await copyToClipboard(myRefLink());
  toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
  SFX.success();
});

$("btnReset").addEventListener("click", ()=>{
  localStorage.removeItem(STORE_KEY);
  toast("–°–±—Ä–æ—à–µ–Ω–æ");
  SFX.danger();
  setTimeout(()=>location.href=location.pathname, 450);
});

function normalizeLinks(arr){
  const out=[];
  for(const raw of arr){
    if(!raw) continue;
    let s=String(raw).trim();
    if(!s) continue;
    if(!/^https?:\/\//i.test(s)) continue;
    if(s.length>120) s=s.slice(0,120);
    out.push(s);
    if(out.length>=3) break;
  }
  return out;
}

/* ---- Chat ---- */
function addChat(msg){
  state.chat.push(msg);
  if(state.chat.length>90) state.chat=state.chat.slice(-90);
  save();
  renderChat(true);
}
function sendText(){
  const inp=$("chatText");
  let text=(inp.value||"").trim();
  if(!text) return;

  const cleaned=stripUrls(text);
  if(cleaned!==text){ toast("–°—Å—ã–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã ‚Äî —É–¥–∞–ª–µ–Ω–æ"); SFX.danger(); }
  text=cleaned.slice(0,220);

  addChat({id:rid(), fromId:state.me.id, fromNick:state.me.nick, t:nowTime(), text});
  inp.value="";
  SFX.tap();
}
$("btnSend").addEventListener("click", ()=>{ SFX.unlock(); sendText(); });
$("chatText").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); SFX.unlock(); sendText(); } });

function rid(){
  try{
    const a=new Uint8Array(8); crypto.getRandomValues(a);
    return Array.from(a).map(x=>x.toString(16).padStart(2,"0")).join("");
  }catch(e){ return String(Math.random()).slice(2); }
}

let rec={active:false, mediaRecorder:null, chunks:[], stream:null};
async function blobToDataURL(blob){
  return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); });
}
async function toggleRecord(){
  SFX.unlock();
  if(!window.MediaRecorder){
    $("voiceHint").textContent="MediaRecorder –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–Ω–∞ iOS –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ).";
    toast("–ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"); SFX.danger(); return;
  }
  if(rec.active){
    try{ rec.mediaRecorder.stop(); }catch(e){}
    rec.active=false;
    $("recDot").style.display="none";
    toast("–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"); SFX.tap();
    return;
  }
  if(!navigator.mediaDevices?.getUserMedia){
    toast("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"); SFX.danger(); return;
  }
  try{
    rec.stream=await navigator.mediaDevices.getUserMedia({audio:true});
    rec.chunks=[];
    rec.mediaRecorder=new MediaRecorder(rec.stream);
    rec.mediaRecorder.ondataavailable=(e)=>{ if(e.data && e.data.size>0) rec.chunks.push(e.data); };
    rec.mediaRecorder.onstop=async ()=>{
      try{ rec.stream?.getTracks()?.forEach(t=>t.stop()); }catch(e){}
      const blob=new Blob(rec.chunks,{type:"audio/webm"});
      const dataUrl=await blobToDataURL(blob);
      addChat({id:rid(), fromId:state.me.id, fromNick:state.me.nick, t:nowTime(), audioDataUrl:dataUrl});
      SFX.success();
    };
    rec.mediaRecorder.start();
    rec.active=true;
    $("recDot").style.display="inline-block";
    toast("–ó–∞–ø–∏—Å—å... –Ω–∞–∂–º–∏ –µ—â—ë —Ä–∞–∑ —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å");
    SFX.tap();
  }catch(e){
    toast("–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω"); SFX.danger();
  }
}
$("btnRec").addEventListener("click", toggleRecord);

/* ---- Landscape toggle ----
   1) Try Fullscreen + Orientation Lock (works in some browsers/PWA)
   2) Fallback: switch UI layout flag (still requires device rotate for true landscape)
*/
let uiMode = localStorage.getItem("uiMode") || "portrait";
applyUiMode(uiMode);

function applyUiMode(mode){
  uiMode=mode;
  document.body.setAttribute("data-ui", mode);
  localStorage.setItem("uiMode", mode);
  toast(mode==="landscape" ? "Landscape UI ON" : "Portrait UI ON");
}

$("btnLandscape").addEventListener("click", async ()=>{
  SFX.unlock(); SFX.tap();
  const next = (uiMode==="portrait") ? "landscape" : "portrait";
  applyUiMode(next);

  // Best-effort orientation lock
  if(next==="landscape"){
    try{
      if(document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
      if(screen.orientation?.lock) await screen.orientation.lock("landscape");
    }catch(e){
      toast("–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –Ω–µ –∑–∞–ª–æ—á–∏–ª–∞—Å—å ‚Äî –ø–æ–≤–µ—Ä–Ω–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –≤—Ä—É—á–Ω—É—é");
    }
  }else{
    try{
      if(screen.orientation?.unlock) screen.orientation.unlock();
      if(document.fullscreenElement) await document.exitFullscreen();
    }catch(e){}
  }
});

/* ---- HERO FX (different vibe than before) ---- */
(function heroFX(){
  const c=$("heroFX");
  const ctx=c.getContext("2d");
  let W=0,H=0,DPR=1;
  const dots=[];
  function resize(){
    const r=c.getBoundingClientRect();
    DPR=Math.max(1, Math.min(2, window.devicePixelRatio||1));
    W=Math.max(1, Math.floor(r.width));
    H=Math.max(1, Math.floor(r.height));
    c.width=Math.floor(W*DPR); c.height=Math.floor(H*DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  function seed(){
    dots.length=0;
    const n = Math.floor((W*H)/14000);
    for(let i=0;i<n;i++){
      dots.push({
        x:Math.random()*W, y:Math.random()*H,
        vx:(Math.random()*2-1)*0.35,
        vy:(Math.random()*2-1)*0.35,
        r: 1.2+Math.random()*2.4,
        a: 0.12+Math.random()*0.25,
        hue: Math.random()<0.5 ? "bio" : (Math.random()<0.75 ? "cyan" : "pink")
      });
    }
  }
  function color(h){
    if(h==="bio") return "rgba(32,255,154,.35)";
    if(h==="cyan") return "rgba(49,215,255,.30)";
    return "rgba(255,47,109,.24)";
  }
  function step(){
    ctx.clearRect(0,0,W,H);
    // soft glow fog
    const g=ctx.createRadialGradient(W*0.5,H*0.2,0, W*0.5,H*0.2, Math.max(W,H));
    g.addColorStop(0,"rgba(32,255,154,.12)");
    g.addColorStop(0.45,"rgba(49,215,255,.08)");
    g.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

    // dots + links
    for(const p of dots){
      p.x+=p.vx; p.y+=p.vy;
      if(p.x< -20) p.x=W+20;
      if(p.x> W+20) p.x=-20;
      if(p.y< -20) p.y=H+20;
      if(p.y> H+20) p.y=-20;

      ctx.fillStyle=color(p.hue);
      ctx.globalAlpha=p.a;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha=1;
    }
    // connecting lines (viral network)
    ctx.strokeStyle="rgba(255,255,255,.06)";
    for(let i=0;i<dots.length;i++){
      for(let j=i+1;j<dots.length;j++){
        const a=dots[i], b=dots[j];
        const dx=a.x-b.x, dy=a.y-b.y;
        const d=Math.hypot(dx,dy);
        if(d<90){
          ctx.globalAlpha=(1-d/90)*0.35;
          ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
          ctx.globalAlpha=1;
        }
      }
    }
    requestAnimationFrame(step);
  }
  resize(); seed(); step();
  window.addEventListener("resize", ()=>{ resize(); seed(); });
})();

/* ---- GAME (infect run) ---- */
const Game = (() => {
  const wrap=$("gameWrap");
  const glow=$("glow");
  const game=$("game");
  const gctx=glow.getContext("2d");
  const ctx=game.getContext("2d");

  let W=0,H=0,DPR=1;
  let last=0, raf=0;

  // joystick
  let joy={x:0,y:0};
  let dashPressed=false;

  const world={
    running:true,
    ended:false,
    t:0,
    timeLeft:60,
    score:0,
    streak:0,
    combo:1,
    comboT:0,
    bonus:0,

    cam:{x:0,y:0},
    bounds:{w:2200,h:3200},
    player:null,
    humans:[],
    horde:[],
    parts:[]
  };

  function resize(){
    const r=wrap.getBoundingClientRect();
    DPR=Math.max(1, Math.min(2, window.devicePixelRatio||1));
    W=Math.max(1, Math.floor(r.width));
    H=Math.max(1, Math.floor(r.height));
    glow.width=Math.floor(W*DPR); glow.height=Math.floor(H*DPR);
    game.width=Math.floor(W*DPR); game.height=Math.floor(H*DPR);
    gctx.setTransform(DPR,0,0,DPR,0,0);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }

  function hud(){
    $("hudScore").textContent=String(world.score);
    $("hudCombo").textContent="x"+String(world.combo);
    $("hudStreak").textContent=String(world.streak);
    $("hudTime").textContent=String(world.timeLeft);
    $("hudBonus").textContent="+"+String(world.bonus);
  }

  function reset(){
    world.running=true; world.ended=false;
    world.t=0; world.timeLeft=60;
    world.score=0; world.streak=0; world.combo=1; world.comboT=0;
    world.bonus=0;
    world.humans.length=0; world.horde.length=0; world.parts.length=0;

    world.player={x:world.bounds.w*0.5,y:world.bounds.h*0.45,vx:0,vy:0,r:18,ang:0,dashCd:0};
    world.cam.x=world.player.x; world.cam.y=world.player.y;

    for(let i=0;i<24;i++) world.humans.push(makeHuman(Math.random()<0.15));
    hud();
  }

  function makeHuman(elite=false){
    const x = 120 + Math.random()*(world.bounds.w-240);
    const y = 220 + Math.random()*(world.bounds.h-440);
    const a = Math.random()*Math.PI*2;
    const sp = elite ? 80+Math.random()*18 : 54+Math.random()*14;
    return {x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,r:elite?15:13,elite,turnT:600+Math.random()*1000,alive:true};
  }
  function makeFollower(x,y){
    return {x,y,vx:0,vy:0,r:14,ang:0,wob:Math.random()*1000};
  }
  function radial(c,x,y,r,color){
    const g=c.createRadialGradient(x,y,0,x,y,r);
    g.addColorStop(0,color);
    g.addColorStop(1,"rgba(0,0,0,0)");
    c.fillStyle=g;
    c.beginPath(); c.arc(x,y,r,0,Math.PI*2); c.fill();
  }
  function spawnParts(x,y,color,n=18,sp=280){
    for(let i=0;i<n;i++){
      const a=Math.random()*Math.PI*2;
      const s=sp*(0.35+Math.random()*0.65);
      world.parts.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:0.35+Math.random()*0.55,max:1,size:2+Math.random()*3,color});
    }
  }
  function calcBonus(score, streak){
    return Math.floor(score/22) + Math.floor(streak/18);
  }

  function infectHuman(h){
    if(!h.alive) return;
    h.alive=false;

    const addBase = h.elite ? 4 : 1;
    const add = addBase * world.combo;

    world.score += add;
    world.streak += 1;
    world.combo = Math.min(16, world.combo + (h.elite ? 3 : 1));
    world.comboT = 80;

    spawnParts(h.x,h.y,"rgba(32,255,154,.22)", 20+addBase*8, 340);
    world.horde.push(makeFollower(h.x,h.y));

    SFX.tap();
    hud();
  }

  function endRun(){
    if(world.ended) return;
    world.ended=true; world.running=false;
    world.bonus = calcBonus(world.score, world.streak);
    hud();

    state.me.bestRun = Math.max(state.me.bestRun||0, world.score);
    state.players[state.me.id].infected = (state.players[state.me.id].infected||0) + world.bonus;
    save();

    renderIntro(); renderRank();
    toast(`RUN OVER ‚Ä¢ SCORE ${world.score} ‚Ä¢ BONUS +${world.bonus}`, 2400);
    SFX.success();
  }

  function ensurePopulation(){
    const target = 22 + Math.min(24, Math.floor(world.score/10));
    const missing = target - world.humans.length;
    if(missing<=0) return;
    for(let i=0;i<Math.min(3,missing);i++) world.humans.push(makeHuman(Math.random()<0.16));
  }

  function drawBackground(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle="rgba(0,0,0,.18)";
    ctx.fillRect(0,0,W,H);

    const gx=world.cam.x - W/2;
    const gy=world.cam.y - H/2;

    // subtle grid
    const step=60;
    ctx.strokeStyle="rgba(255,255,255,.04)";
    ctx.lineWidth=1;
    const sx=Math.floor(gx/step)*step;
    const sy=Math.floor(gy/step)*step;

    ctx.beginPath();
    for(let x=sx; x<gx+W+step; x+=step){ const px=x-gx; ctx.moveTo(px,0); ctx.lineTo(px,H); }
    for(let y=sy; y<gy+H+step; y+=step){ const py=y-gy; ctx.moveTo(0,py); ctx.lineTo(W,py); }
    ctx.stroke();
  }

  function drawGlow(){
    gctx.clearRect(0,0,W,H);
    const gx=world.cam.x - W/2;
    const gy=world.cam.y - H/2;

    if(world.player) radial(gctx, world.player.x-gx, world.player.y-gy, 46, "rgba(32,255,154,.20)");
    for(const z of world.horde) radial(gctx, z.x-gx, z.y-gy, 28, "rgba(32,255,154,.16)");
    for(const h of world.humans) radial(gctx, h.x-gx, h.y-gy, h.elite?30:22, h.elite?"rgba(255,213,106,.12)":"rgba(255,255,255,.05)");
    for(const p of world.parts) radial(gctx, p.x-gx, p.y-gy, p.size*4.2, p.color);
  }

  function roundedPath(c,x,y,w,h,r){
    c.moveTo(x+r,y);
    c.arcTo(x+w,y, x+w,y+h, r);
    c.arcTo(x+w,y+h, x,y+h, r);
    c.arcTo(x,y+h, x,y, r);
    c.arcTo(x,y, x+w,y, r);
  }

  function drawZombie(x,y,size,ang,isKing=false){
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(ang);

    // body
    ctx.fillStyle="#20ff9a";
    ctx.strokeStyle="rgba(255,255,255,.14)";
    ctx.lineWidth=2;
    ctx.beginPath();
    roundedPath(ctx, -size*0.55, -size*0.70, size*1.1, size*1.45, size*0.42);
    ctx.fill(); ctx.stroke();

    // face
    ctx.fillStyle="rgba(0,0,0,.28)";
    ctx.strokeStyle="rgba(255,255,255,.10)";
    ctx.lineWidth=1;
    ctx.beginPath();
    roundedPath(ctx, -size*0.42, -size*0.18, size*0.84, size*0.70, size*0.28);
    ctx.fill(); ctx.stroke();

    // eyes
    ctx.fillStyle="#31d7ff";
    ctx.beginPath(); ctx.arc(-size*0.18, -size*0.02, size*0.10, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( size*0.18, -size*0.02, size*0.10, 0, Math.PI*2); ctx.fill();

    if(isKing){
      ctx.fillStyle="rgba(255,213,106,.88)";
      ctx.beginPath();
      ctx.moveTo(-size*0.55, -size*0.68);
      ctx.lineTo(-size*0.20, -size*1.05);
      ctx.lineTo( 0,         -size*0.70);
      ctx.lineTo( size*0.20, -size*1.12);
      ctx.lineTo( size*0.55, -size*0.68);
      ctx.closePath();
      ctx.fill();
    }
    ctx.restore();
  }

  function drawHuman(x,y,elite){
    ctx.save(); ctx.translate(x,y);
    ctx.fillStyle = elite ? "rgba(255,213,106,.85)" : "rgba(255,255,255,.70)";
    ctx.strokeStyle = elite ? "rgba(255,213,106,.20)" : "rgba(255,255,255,.14)";
    ctx.lineWidth=2;

    ctx.beginPath(); roundedPath(ctx,-14,-10,28,38,14); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(0,-22,10,0,Math.PI*2); ctx.fill();

    if(elite){
      ctx.strokeStyle="rgba(32,255,154,.28)";
      ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(0,4,24,0,Math.PI*2); ctx.stroke();
    }
    ctx.restore();
  }

  function render(){
    drawBackground();
    drawGlow();

    // composite glow
    ctx.save();
    ctx.globalCompositeOperation="lighter";
    ctx.filter="blur(10px)";
    ctx.drawImage(glow,0,0,W,H);
    ctx.filter="none";
    ctx.globalAlpha=0.75;
    ctx.drawImage(glow,0,0,W,H);
    ctx.globalAlpha=1;
    ctx.globalCompositeOperation="source-over";
    ctx.restore();

    const gx=world.cam.x - W/2;
    const gy=world.cam.y - H/2;

    // humans
    for(const h of world.humans){ if(h.alive) drawHuman(h.x-gx,h.y-gy,h.elite); }
    // horde
    for(const z of world.horde) drawZombie(z.x-gx,z.y-gy,15,z.ang,false);
    // player (king if many followers)
    if(world.player){
      const king = world.horde.length>=16;
      drawZombie(world.player.x-gx, world.player.y-gy, 20, world.player.ang, king);
    }

    // particles
    ctx.save();
    ctx.globalCompositeOperation="lighter";
    for(const p of world.parts){
      const a=clamp(p.life/p.max,0,1);
      ctx.globalAlpha=a;
      ctx.fillStyle=p.color;
      ctx.beginPath(); ctx.arc(p.x-gx,p.y-gy,p.size,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();
  }

  function update(dt){
    world.t += dt;

    if(world.running && !world.ended){
      world._sec=(world._sec||0)+dt;
      if(world._sec>=1000){
        world._sec-=1000;
        world.timeLeft--;
        if(world.timeLeft<=0) endRun();
        hud();
      }
    }

    // combo decay
    if(world.comboT>0) world.comboT--;
    else world.combo=Math.max(1, world.combo-1);

    ensurePopulation();

    const p=world.player;
    if(!p) return;

    const vlen=Math.hypot(joy.x,joy.y);
    const speedBase = 300 + Math.min(160, world.horde.length*3);

    if(vlen>0.08 && world.running && !world.ended){
      const nx=joy.x/vlen, ny=joy.y/vlen;
      p.vx += nx*speedBase*(dt/1000);
      p.vy += ny*speedBase*(dt/1000);
      p.ang = Math.atan2(ny,nx);
    }else{
      p.vx *= Math.pow(0.002, dt/1000);
      p.vy *= Math.pow(0.002, dt/1000);
    }

    // dash
    p.dashCd=Math.max(0, p.dashCd-dt);
    if(dashPressed && p.dashCd<=0 && world.running && !world.ended){
      dashPressed=false;
      p.dashCd=900;
      const dnx=vlen>0.08 ? joy.x/vlen : Math.cos(p.ang);
      const dny=vlen>0.08 ? joy.y/vlen : Math.sin(p.ang);
      p.vx += dnx*720;
      p.vy += dny*720;
      spawnParts(p.x,p.y,"rgba(255,47,109,.20)", 24, 420);
      SFX.tap();
    }

    // friction + clamp
    const fr=Math.pow(0.03, dt/1000);
    p.vx*=fr; p.vy*=fr;
    const pv=Math.hypot(p.vx,p.vy);
    const vmax=520;
    if(pv>vmax){ p.vx=p.vx/pv*vmax; p.vy=p.vy/pv*vmax; }

    // integrate
    p.x+=p.vx*(dt/1000);
    p.y+=p.vy*(dt/1000);
    p.x=clamp(p.x,80,world.bounds.w-80);
    p.y=clamp(p.y,120,world.bounds.h-160);

    // humans wander + avoid
    for(const h of world.humans){
      if(!h.alive) continue;
      h.turnT-=dt;
      if(h.turnT<=0){
        h.turnT=600+Math.random()*1200;
        const a=Math.random()*Math.PI*2;
        const sp=h.elite ? 70+Math.random()*18 : 52+Math.random()*14;
        h.vx=Math.cos(a)*sp; h.vy=Math.sin(a)*sp;
      }
      const dx=h.x-p.x, dy=h.y-p.y;
      const dist=Math.hypot(dx,dy);
      if(dist<140){
        const inv=1/Math.max(1,dist);
        const ax=dx*inv, ay=dy*inv;
        const sp=h.elite?120:92;
        h.vx=lerp(h.vx, ax*sp, 0.08);
        h.vy=lerp(h.vy, ay*sp, 0.08);
      }
      h.x += h.vx*(dt/1000);
      h.y += h.vy*(dt/1000);
      if(h.x<90||h.x>world.bounds.w-90) h.vx*=-1;
      if(h.y<160||h.y>world.bounds.h-220) h.vy*=-1;
      h.x=clamp(h.x,90,world.bounds.w-90);
      h.y=clamp(h.y,160,world.bounds.h-220);
    }

    // horde follow chain
    let leadX=p.x, leadY=p.y, leadAng=p.ang;
    const spacing=30;
    for(const z of world.horde){
      const tx=leadX - Math.cos(leadAng)*spacing;
      const ty=leadY - Math.sin(leadAng)*spacing;
      z.x += (tx - z.x)*0.12;
      z.y += (ty - z.y)*0.12;
      z.ang = Math.atan2(leadY - z.y, leadX - z.x);

      leadX=z.x; leadY=z.y; leadAng=z.ang;
    }

    // collisions
    if(world.running && !world.ended){
      for(const h of world.humans){
        if(!h.alive) continue;
        if(Math.hypot(h.x-p.x,h.y-p.y) < h.r + p.r + 2) infectHuman(h);
      }
      for(const z of world.horde){
        for(const h of world.humans){
          if(!h.alive) continue;
          if(Math.hypot(h.x-z.x,h.y-z.y) < h.r + z.r + 2) infectHuman(h);
        }
      }
    }

    // cleanup dead humans sometimes
    if(world.t % 400 < dt) world.humans=world.humans.filter(h=>h.alive);

    // particles
    for(const pt of world.parts){
      pt.life -= dt/1000;
      pt.x += pt.vx*(dt/1000);
      pt.y += pt.vy*(dt/1000);
      pt.vx *= Math.pow(0.20, dt/1000);
      pt.vy *= Math.pow(0.20, dt/1000);
    }
    world.parts=world.parts.filter(p=>p.life>0);

    // camera follow
    world.cam.x=lerp(world.cam.x, p.x, 0.08);
    world.cam.y=lerp(world.cam.y, p.y, 0.08);

    render();
  }

  function loop(ts){
    if(!last) last=ts;
    const dt=Math.min(32, ts-last);
    last=ts;
    update(dt);
    raf=requestAnimationFrame(loop);
  }

  // controls
  function initControls(){
    const stick=$("stick");
    const knob=$("knob");
    const dash=$("dash");
    let active=false, pid=null, base={x:0,y:0};

    const setKnob=(dx,dy)=>{
      const max=46;
      const dist=Math.hypot(dx,dy);
      const k=dist>max ? (max/dist) : 1;
      const x=dx*k, y=dy*k;
      knob.style.transform=`translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      joy.x = clamp(x/max,-1,1);
      joy.y = clamp(y/max,-1,1);
    };
    const resetJoy=()=>{
      knob.style.transform="translate(-50%,-50%)";
      joy.x=0; joy.y=0;
    };

    stick.addEventListener("pointerdown",(e)=>{
      active=true; pid=e.pointerId;
      stick.setPointerCapture(pid);
      const r=stick.getBoundingClientRect();
      base.x=r.left+r.width/2; base.y=r.top+r.height/2;
      setKnob(e.clientX-base.x, e.clientY-base.y);
    });
    stick.addEventListener("pointermove",(e)=>{
      if(!active || e.pointerId!==pid) return;
      setKnob(e.clientX-base.x, e.clientY-base.y);
    });
    stick.addEventListener("pointerup",(e)=>{
      if(e.pointerId!==pid) return;
      active=false; pid=null; resetJoy();
    });
    stick.addEventListener("pointercancel",()=>{ active=false; pid=null; resetJoy(); });

    dash.addEventListener("pointerdown",()=>{
      dashPressed=true;
      SFX.tap();
      setTimeout(()=>dashPressed=false, 140);
    });
  }

  $("btnRestart").addEventListener("click", ()=>{
    SFX.unlock(); SFX.tap();
    reset();
    toast("–ù–æ–≤—ã–π –∑–∞–±–µ–≥");
  });

  $("btnShareRun").addEventListener("click", async ()=>{
    SFX.unlock(); SFX.tap();
    const link=myRefLink();
    const text=`Viral Link ‚Äî Score ${world.score}, Bonus +${world.bonus}. Infect via: ${link}`;
    const ok=await shareLink(text, link);
    if(!ok){ await copyToClipboard(text); toast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"); }
    else toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
    SFX.success();
  });

  function boot(){
    resize();
    window.addEventListener("resize", resize);
    initControls();
    reset();
    raf=requestAnimationFrame(loop);
  }
  boot();

  // expose endRun when time hits (already)
  return { reset, endRun };
})();

/* ---- feed convenience ---- */
$("btnScrollToPlay").addEventListener("click", ()=>SFX.unlock());

/* ---- prevent audio lock annoyance ---- */
document.addEventListener("pointerdown", ()=>SFX.unlock(), {once:false});
</script>
</body>
</html>
